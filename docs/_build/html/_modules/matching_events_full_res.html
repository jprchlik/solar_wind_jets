

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>matching_events_full_res &mdash; Solar Wind Matching 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'0.1',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../index.html" class="icon icon-home"> Solar Wind Matching
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Solar Wind Matching</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>matching_events_full_res</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for matching_events_full_res</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">fancy_plot</span> <span class="k">import</span> <span class="n">fancy_plot</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Pool</span><span class="p">,</span><span class="n">Lock</span><span class="p">,</span><span class="n">current_process</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">mlpy</span> <span class="c1">#for dynamic time shifting</span>

<span class="kn">from</span> <span class="nn">scipy.stats.mstats</span> <span class="k">import</span> <span class="n">theilslopes</span>

<span class="c1">#prevents issues with core affinity (i.e. issues with using all the processes)</span>
<span class="c1">#os.system(&quot;taskset -p 0xff %d&quot; % os.getpid())</span>

<span class="c1">#Function to read in spacecraft</span>
<div class="viewcode-block" id="read_in"><a class="viewcode-back" href="../source/code/matching_events_full_res.html#matching_events_full_res.read_in">[docs]</a><span class="k">def</span> <span class="nf">read_in</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">p_var</span><span class="o">=</span><span class="s1">&#39;predict_shock_500&#39;</span><span class="p">,</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;../cdf/cdftotxt/&#39;</span><span class="p">,</span>
            <span class="n">mag_fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_mag_2015_2017_formatted.txt&#39;</span><span class="p">,</span><span class="n">pls_fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_pls_2015_2017_formatted.txt&#39;</span><span class="p">,</span>
            <span class="n">orb_fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_orb_2015_2017_formatted.txt&#39;</span><span class="p">,</span>
            <span class="n">start_t</span><span class="o">=</span><span class="s1">&#39;2016/12/01&#39;</span><span class="p">,</span><span class="n">end_t</span><span class="o">=</span><span class="s1">&#39;2017/09/24&#39;</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function to read in text files for a given spacecraft</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    k: string</span>
<span class="sd">        Then name of a spacecraft so to format for file read in</span>
<span class="sd">    arch: string, optional</span>
<span class="sd">        The archive location for the text file to read in (Default = &#39;../cdf/cdftotxt/&#39;)</span>
<span class="sd">    mag_fmt: string, optional</span>
<span class="sd">        The file format for the magnetic field observations (Default = &#39;{0}_mag_2015_2017_formatted.txt&#39;,</span>
<span class="sd">        where 0 is the formatted k).</span>
<span class="sd">    pls_fmt: string, optional</span>
<span class="sd">        The file format for the plasma observations (Default = &#39;{0}_pls_2015_2017_formatted.txt&#39;,</span>
<span class="sd">        where 0 is the formatted k).</span>
<span class="sd">    orb_fmt: string, optional</span>
<span class="sd">        The file format for the orbital data (Default = &#39;{0}_orb_2015_2017_formatted.txt&#39;,</span>
<span class="sd">        where 0 is the formatted k).</span>
<span class="sd">    center = boolean, optional</span>
<span class="sd">        Whether the analyzed point to be center focused (center = True) or right focus (Default = False).</span>
<span class="sd">        Center focus gives you a better localized point, however, the model is trained with a right focus</span>
<span class="sd">        in order to reject spikes and increase S/N.</span>
<span class="sd">    start_t: string, optional</span>
<span class="sd">        Date in YYYY/MM/DD format to start looking for events (Default = &#39;2016/06/04&#39;)</span>
<span class="sd">    start_t: string, optional</span>
<span class="sd">        Date in YYYY/MM/DD format to stop looking for events (inclusive, Default = &#39;2017/07/31&#39;)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plsm: Pandas DataFrame</span>
<span class="sd">        A pandas dataframe with probability values and combined mag and plasma observations.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Read in plasma and magnetic field data from full res</span>
    <span class="n">pls</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">arch</span><span class="o">+</span><span class="n">pls_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span><span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#no magnetic field data from SOHO</span>
    <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;soho&#39;</span><span class="p">:</span>
        <span class="n">mag</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">arch</span><span class="o">+</span><span class="n">mag_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span><span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">orb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">arch</span><span class="o">+</span><span class="n">orb_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span><span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">#create datetime objects from time</span>
        <span class="n">pls</span><span class="p">[</span><span class="s1">&#39;time_dt_pls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">pls</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span>
        <span class="n">mag</span><span class="p">[</span><span class="s1">&#39;time_dt_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">mag</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span>
        <span class="n">orb</span><span class="p">[</span><span class="s1">&#39;time_dt_orb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">orb</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span>

        <span class="c1">#setup index</span>
        <span class="n">pls</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">pls</span><span class="o">.</span><span class="n">time_dt_pls</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mag</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">mag</span><span class="o">.</span><span class="n">time_dt_mag</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">orb</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">time_dt_orb</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">#cut for testing reasons</span>
        <span class="n">pls</span> <span class="o">=</span> <span class="n">pls</span><span class="p">[</span><span class="n">start_t</span><span class="p">:</span><span class="n">end_t</span><span class="p">]</span>
        <span class="n">mag</span> <span class="o">=</span> <span class="n">mag</span><span class="p">[</span><span class="n">start_t</span><span class="p">:</span><span class="n">end_t</span><span class="p">]</span>
        <span class="n">orb</span> <span class="o">=</span> <span class="n">orb</span><span class="p">[</span><span class="n">start_t</span><span class="p">:</span><span class="n">end_t</span><span class="p">]</span>

        <span class="c1">#pls = pls[&#39;2016/07/18&#39;:&#39;2016/07/21&#39;]</span>
        <span class="c1">#mag = mag[&#39;2016/07/18&#39;:&#39;2016/07/21&#39;]</span>
        <span class="c1">#pls = pls[&#39;2017/01/25&#39;:&#39;2017/01/27&#39;]</span>
        <span class="c1">#mag = mag[&#39;2017/01/25&#39;:&#39;2017/01/27&#39;]</span>

        <span class="c1">#join magnetic field and plasma dataframes</span>
        <span class="n">com_df</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">mag</span><span class="p">,</span><span class="n">pls</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span><span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_mag&#39;</span><span class="p">,</span><span class="s1">&#39;_pls&#39;</span><span class="p">),</span><span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">#make sure data columns are numeric</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">,</span><span class="s1">&#39;Np&#39;</span><span class="p">,</span><span class="s1">&#39;Vth&#39;</span><span class="p">,</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>
        <span class="n">com_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">com_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

        <span class="c1">#add Time string</span>
        <span class="n">com_df</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">com_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y/%m/</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)</span>

        <span class="c1">#replace NaN with previously measured value</span>
        <span class="c1">#com_df.fillna(method=&#39;bfill&#39;,inplace=True)</span>
        
        <span class="c1">#get degault formating for pandas dataframe</span>
        <span class="n">plsm</span> <span class="o">=</span> <span class="n">format_df</span><span class="p">(</span><span class="n">com_df</span><span class="p">,</span><span class="n">p_var</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> 

        <span class="c1">#add orbital data</span>
        <span class="n">plsm</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">plsm</span><span class="p">,</span><span class="n">orb</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span><span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;_orb&#39;</span><span class="p">),</span><span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#make sure data columns are numeric</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">,</span><span class="s1">&#39;Np&#39;</span><span class="p">,</span><span class="s1">&#39;Vth&#39;</span><span class="p">,</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">,</span><span class="s1">&#39;GSEx&#39;</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">]</span>
        <span class="n">plsm</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

        <span class="c1">#add Time string</span>
        <span class="n">plsm</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y/%m/</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)</span>

        <span class="c1">#fill undersampled orbit</span>
        <span class="k">for</span> <span class="n">cor</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">]:</span> <span class="n">plsm</span><span class="p">[</span><span class="s1">&#39;GSE&#39;</span><span class="o">+</span><span class="n">cor</span><span class="p">]</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#work around for no Mag data in SOHO</span>
        <span class="n">pls</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">pls</span><span class="p">[</span><span class="s1">&#39;time_dt_pls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">pls</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span>
        <span class="n">pls</span><span class="p">[</span><span class="s1">&#39;time_dt_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">pls</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span>
        <span class="n">pls</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">pls</span><span class="o">.</span><span class="n">time_dt_pls</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plsm</span> <span class="o">=</span> <span class="n">format_df</span><span class="p">(</span><span class="n">pls</span><span class="p">,</span><span class="n">p_var</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
        <span class="n">plsm</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.0</span>

        <span class="n">Re</span> <span class="o">=</span> <span class="mf">6371.0</span> <span class="c1"># Earth radius</span>

        <span class="c1">#multiply each component by Earth Radius</span>
        <span class="n">plsm</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">Re</span>
        <span class="n">plsm</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">Re</span>
        <span class="n">plsm</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">Re</span>

        <span class="c1">#chane column name from X, Y, Z to GSEx, GSEy, GSEz </span>
        <span class="n">plsm</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="s1">&#39;GSEx&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="s1">&#39;GSEy&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="s1">&#39;GSEz&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#force index to sort</span>
    <span class="n">plsm</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#for rekeying later</span>
    <span class="n">plsm</span><span class="p">[</span><span class="s1">&#39;craft&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>

    <span class="k">return</span> <span class="n">plsm</span></div>


<span class="c1">#format input data frame</span>
<div class="viewcode-block" id="format_df"><a class="viewcode-back" href="../source/code/matching_events_full_res.html#matching_events_full_res.format_df">[docs]</a><span class="k">def</span> <span class="nf">format_df</span><span class="p">(</span><span class="n">inpt_df</span><span class="p">,</span><span class="n">p_var</span><span class="p">,</span><span class="n">span</span><span class="o">=</span><span class="s1">&#39;3600s&#39;</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    format_df is a function which formats an input data frame with plasma parameters</span>
<span class="sd">    into a format to be used by the rest of the program. Cheifly, it determines the </span>
<span class="sd">    p-values for an event.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    inpt_df: Pandas DataFrame</span>
<span class="sd">        A combined plasma and magnetic field pandas DataFrame.</span>
<span class="sd">    p_var  : string </span>
<span class="sd">        Formatted string of column name which will contain the trained </span>
<span class="sd">        sigma levels probability level for training (i.e. 5 sigma).</span>
<span class="sd">    span: string, optional</span>
<span class="sd">        String with pandas to_timedelta like formating (Default = 3600s)</span>
<span class="sd">    center: boolean, optional</span>
<span class="sd">        Boolean specifying with probabilities should compute with point </span>
<span class="sd">        centered values (center = True) or left sided values (Default = False). </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outp_df: Pandas DataFrame</span>
<span class="sd">        A dataframe with probability values populated based on a 5 sigma</span>
<span class="sd">        trained magnetic field model.</span>

<span class="sd">    &#39;&#39;&#39;</span>


    <span class="c1">#Add Mag field Magnitude</span>
    <span class="n">inpt_df</span><span class="p">[</span><span class="s1">&#39;Bt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">Bx</span><span class="o">**</span><span class="mf">2.</span><span class="o">+</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">By</span><span class="o">**</span><span class="mf">2.</span><span class="o">+</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">Bz</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
   

    <span class="c1">#range check for variables</span>
    <span class="n">inpt_df</span><span class="o">.</span><span class="n">SPEED</span><span class="p">[((</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">))]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.0</span>
    <span class="n">inpt_df</span><span class="o">.</span><span class="n">Vth</span><span class="p">[((</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">Vth</span> <span class="o">&gt;</span> <span class="mf">1E2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">Vth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.0</span>
    <span class="n">inpt_df</span><span class="o">.</span><span class="n">Np</span><span class="p">[((</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">Np</span> <span class="o">&gt;</span> <span class="mf">1E4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">Np</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.0</span>
    <span class="n">inpt_df</span><span class="o">.</span><span class="n">Bx</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">Bx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1E3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.0</span>
    <span class="n">inpt_df</span><span class="o">.</span><span class="n">By</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">By</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1E3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.0</span>
    <span class="n">inpt_df</span><span class="o">.</span><span class="n">Bz</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">Bz</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1E3</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.0</span>

    <span class="c1">#output data frame</span>
    <span class="c1">#outp_df = inpt_df.copy()</span>
    
    
    <span class="c1">#check quality </span>
    <span class="n">p_den</span> <span class="o">=</span> <span class="p">((</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">Np</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.</span><span class="p">)</span>    <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">Np</span><span class="p">)))</span>
    <span class="n">p_vth</span> <span class="o">=</span> <span class="p">((</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">Vth</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.</span><span class="p">)</span>   <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">Vth</span><span class="p">)))</span>
    <span class="n">p_spd</span> <span class="o">=</span> <span class="p">((</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">SPEED</span><span class="p">)))</span>
    <span class="n">p_ptm</span> <span class="o">=</span> <span class="n">inpt_df</span><span class="o">.</span><span class="n">time_dt_pls</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>

    <span class="n">p_bfx</span> <span class="o">=</span> <span class="p">((</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">Bx</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.</span><span class="p">)</span>    <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">Bx</span><span class="p">)))</span>
    <span class="n">p_bfy</span> <span class="o">=</span> <span class="p">((</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">By</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.</span><span class="p">)</span>    <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">By</span><span class="p">)))</span>
    <span class="n">p_bfz</span> <span class="o">=</span> <span class="p">((</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">Bz</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.</span><span class="p">)</span>    <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">inpt_df</span><span class="o">.</span><span class="n">Bz</span><span class="p">)))</span>
    <span class="n">p_mtm</span> <span class="o">=</span> <span class="n">inpt_df</span><span class="o">.</span><span class="n">time_dt_mag</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span>

    <span class="c1">#only keep times with good data in plasma or magnetic field</span>
    <span class="n">plsm_df</span> <span class="o">=</span> <span class="n">inpt_df</span><span class="p">[((</span><span class="n">p_den</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">p_vth</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">p_spd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">p_ptm</span><span class="p">))]</span>
    <span class="n">magf_df</span> <span class="o">=</span> <span class="n">inpt_df</span><span class="p">[((</span><span class="n">p_bfx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">p_bfy</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">p_bfz</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">p_mtm</span><span class="p">))]</span>

    <span class="c1">#Do a quick spike rejection</span>
    <span class="c1">#calculat plasma parameters rolling median for spike rejection</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;roll_med_spike_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;roll_med_spike_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span>   <span class="mi">60</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;roll_med_spike_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span>  <span class="mi">60</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

    <span class="c1">#calculate difference in plasma parameters from rolling median for spike rejection</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_med_spike_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">SPEED</span><span class="o">-</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_med_spike_speed</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_med_spike_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">Np</span>   <span class="o">-</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_med_spike_Np</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_med_spike_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">Vth</span>  <span class="o">-</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_med_spike_Vth</span>

    <span class="c1">#calculate sigma in plasma parameters from rollin median for spike rejection</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_sig_spike_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_spike_speed</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_sig_spike_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_spike_Np</span>   <span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">())</span> 
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_sig_spike_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_spike_Vth</span>  <span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">())</span> 


    <span class="c1">#difference for spike rejection</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_snr_spike_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_spike_speed</span><span class="p">)</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_sig_spike_speed</span> 
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_snr_spike_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_spike_Np</span><span class="p">)</span>   <span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_sig_spike_Np</span>       
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_snr_spike_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_spike_Vth</span><span class="p">)</span>  <span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_sig_spike_Vth</span>     

    <span class="c1">#shift back</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;l_diff_snr_spike_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_snr_spike_speed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;l_diff_snr_spike_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_snr_spike_Np&#39;</span><span class="p">]</span>   <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;l_diff_snr_spike_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_snr_spike_Vth&#39;</span><span class="p">]</span>  <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 

    <span class="c1">#shift forward</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;r_diff_snr_spike_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_snr_spike_speed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;r_diff_snr_spike_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_snr_spike_Np&#39;</span><span class="p">]</span>   <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;r_diff_snr_spike_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_snr_spike_Vth&#39;</span><span class="p">]</span>  <span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 

    <span class="c1">#Sigma tolerance </span>
    <span class="n">sig_tol</span> <span class="o">=</span> <span class="mf">5.0</span>

    <span class="c1">#loop over toleranaces and fill with -9999.0 where you find an isolated spike</span>
    <span class="n">tol_loop</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;speed&#39;</span><span class="p">,</span><span class="s1">&#39;Np&#39;</span><span class="p">,</span><span class="s1">&#39;Vth&#39;</span><span class="p">]</span> 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tol_loop</span><span class="p">:</span>
        <span class="n">before</span> <span class="o">=</span> <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;l_diff_snr_spike_&#39;</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sig_tol</span>
        <span class="n">during</span> <span class="o">=</span> <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_snr_spike_&#39;</span><span class="o">+</span><span class="n">i</span><span class="p">]</span>   <span class="o">&gt;</span> <span class="n">sig_tol</span>
        <span class="n">after</span>  <span class="o">=</span> <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;r_diff_snr_spike_&#39;</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">sig_tol</span>

        <span class="c1">#correct for bad variable naming</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="s1">&#39;speed&#39;</span><span class="p">:</span> <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">plsm_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[((</span><span class="n">before</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">during</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">after</span><span class="p">)),</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1">#Interpolate over filled values</span>
        <span class="n">plsm_df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>





    
    <span class="c1">#Only fill for ACE</span>
    <span class="c1">#if k == &#39;ace&#39;:</span>
    <span class="c1">#    #replace bad values with nans and pervious observation fill previous value</span>
    <span class="c1">#   parameters = [&#39;SPEED&#39;,&#39;Vth&#39;,&#39;Np&#39;,&#39;Bx&#39;,&#39;By&#39;,&#39;Bz&#39;] </span>
    <span class="c1">#   for p in parameters:</span>
    <span class="c1">#        inpt_df.loc[inpt_df[p] &lt; -9990.,p] = np.nan</span>
    <span class="c1">#        inpt_df[p].ffill(inplace=True)</span>
    <span class="c1">#</span>

    <span class="c1">#Do parameter calculation of different cadences</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;del_time_pls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;time_dt_pls&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span><span class="o">/</span><span class="mf">1.e9</span><span class="p">)</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;del_time_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;time_dt_mag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span><span class="o">/</span><span class="mf">1.e9</span><span class="p">)</span>


    <span class="c1">#convert span to a number index so I can use the logic center = True</span>
    <span class="c1">#assumes format_df import is in s</span>
    <span class="c1">#then divide by the space craft jump time</span>
    <span class="k">if</span> <span class="n">center</span><span class="p">:</span>
        <span class="n">span_mag</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">span</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">magf_df</span><span class="o">.</span><span class="n">del_time_mag</span><span class="o">.</span><span class="n">median</span><span class="p">()))</span>
        <span class="n">span_pls</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">span</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span><span class="o">.</span><span class="n">median</span><span class="p">()))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;######################################################&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">span</span><span class="p">,</span><span class="n">span_mag</span><span class="p">,</span><span class="n">span_pls</span><span class="p">,</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span><span class="n">magf_df</span><span class="o">.</span><span class="n">del_time_mag</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;######################################################&#39;</span><span class="p">)</span>
    <span class="c1">#else use the runup (left) span</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">span_mag</span> <span class="o">=</span> <span class="n">span</span>
        <span class="n">span_pls</span> <span class="o">=</span> <span class="n">span</span>

    <span class="c1">#time cadence parameter to add to plasma and magnetic field time series</span>
    <span class="n">par_ind_mag</span> <span class="o">=</span> <span class="n">magf_df</span><span class="o">.</span><span class="n">del_time_mag</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">**</span><span class="mf">2.</span><span class="o">/</span><span class="mf">60.</span><span class="o">/</span><span class="n">magf_df</span><span class="o">.</span><span class="n">del_time_mag</span><span class="o">*</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">/</span><span class="n">magf_df</span><span class="o">.</span><span class="n">del_time_mag</span><span class="o">.</span><span class="n">median</span><span class="p">())</span> <span class="c1">#add correction for higher cadence observations</span>
    <span class="n">par_ind_pls</span> <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">**</span><span class="mf">2.</span><span class="o">/</span><span class="mf">60.</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span>

    <span class="c1">#calculate difference in parameters</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;ldel_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span><span class="p">)</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;ldel_Np&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span><span class="p">)</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;ldel_Vth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span><span class="p">)</span>

    <span class="c1">#calculat plasma parameters rolling median</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;roll_med_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">span_pls</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;roll_med_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span>   <span class="n">span_pls</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;roll_med_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span>  <span class="n">span_pls</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

    <span class="c1">#calculate difference in plasma parameters from rolling median</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_med_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">SPEED</span><span class="o">-</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_med_speed</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_med_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">Np</span><span class="o">-</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_med_Np</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_med_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">Vth</span><span class="o">-</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_med_Vth</span>

    <span class="c1">#calculate difference in plasma parameters from rolling median</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;roll_diff_med_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_speed</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">span_pls</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;roll_diff_med_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_Np</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span>   <span class="n">span_pls</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;roll_diff_med_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_Vth</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span>  <span class="n">span_pls</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

    <span class="c1">#calculate acceleration in plasma parameters from rolling median</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;accl_diff_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_speed</span><span class="o">-</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_diff_med_speed</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;accl_diff_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_Np</span><span class="o">-</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_diff_med_Np</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;accl_diff_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_Vth</span><span class="o">-</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_diff_med_Vth</span>

    <span class="c1">#calculate sigma in plasma parameters from rollin median</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_sig_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_speed</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">span_pls</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_sig_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_Np</span>   <span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">span_pls</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">())</span> 
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_sig_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_Vth</span>  <span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">span_pls</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">())</span> 

    <span class="c1">#calculate acceleration in plasma parameters from rolling median</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;accl_sig_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;accl_diff_speed&#39;</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">span_pls</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">())</span> 
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;accl_sig_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;accl_diff_Np&#39;</span><span class="p">]</span>   <span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">span_pls</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">())</span> 
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;accl_sig_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;accl_diff_Vth&#39;</span><span class="p">]</span>  <span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">span_pls</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">())</span> 

    <span class="c1">#calculate snr in plasma parameters from rollin median</span>
    <span class="c1">#Change to difference in sigma per minute time period 2017/10/31</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_snr_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_speed</span><span class="p">)</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_sig_speed</span> <span class="o">*</span><span class="n">par_ind_pls</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_snr_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_Np</span><span class="p">)</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_sig_Np</span>       <span class="o">*</span><span class="n">par_ind_pls</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_snr_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_Vth</span><span class="p">)</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_sig_Vth</span>     <span class="o">*</span><span class="n">par_ind_pls</span>


    <span class="c1">#calculate snr in plasma acceleration parameters from rollin median</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;accl_snr_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">accl_sig_speed</span><span class="p">)</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">accl_sig_speed</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;accl_snr_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">accl_sig_Np</span>   <span class="p">)</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">accl_sig_Np</span>   
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;accl_snr_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">accl_sig_Vth</span>  <span class="p">)</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">accl_sig_Vth</span>

    <span class="c1">#calculate power in the diffence for paramaters</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_pow_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_speed</span><span class="p">)</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_med_Np</span><span class="p">)</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_pow_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_Np</span><span class="p">)</span>   <span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_med_speed</span><span class="o">**</span><span class="mf">2.</span><span class="o">+</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_med_Vth</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_pow_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_Vth</span><span class="p">)</span>  <span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_med_Np</span><span class="p">)</span>
                             
    <span class="c1">#calculate increase in power in the diffence for paramaters</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_acc_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_speed</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_med_Np</span><span class="p">)</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_acc_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_Np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>   <span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_med_speed</span><span class="o">**</span><span class="mf">2.</span><span class="o">+</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_med_Vth</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;diff_acc_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">diff_med_Vth</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>  <span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_med_Np</span><span class="p">)</span>

    <span class="c1">#calculate B parameters rollin median</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;roll_med_Bx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">span_mag</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;roll_med_By&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">span_mag</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;roll_med_Bz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">span_mag</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

    <span class="c1">#calculate difference B parameters from rollin median</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;diff_med_Bx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magf_df</span><span class="o">.</span><span class="n">Bx</span><span class="o">-</span><span class="n">magf_df</span><span class="o">.</span><span class="n">roll_med_Bx</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;diff_med_By&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magf_df</span><span class="o">.</span><span class="n">By</span><span class="o">-</span><span class="n">magf_df</span><span class="o">.</span><span class="n">roll_med_By</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;diff_med_Bz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magf_df</span><span class="o">.</span><span class="n">Bz</span><span class="o">-</span><span class="n">magf_df</span><span class="o">.</span><span class="n">roll_med_Bz</span>

    <span class="c1">#calculate sigma in B parameters from rollin median</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;diff_sig_Bx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">magf_df</span><span class="o">.</span><span class="n">diff_med_Bx</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">span_mag</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;diff_sig_By&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">magf_df</span><span class="o">.</span><span class="n">diff_med_By</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">span_mag</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;diff_sig_Bz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">magf_df</span><span class="o">.</span><span class="n">diff_med_Bz</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">span_mag</span><span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">())</span>

    <span class="c1">#calculate snr in B parameters from rollin median</span>
    <span class="c1">#Change to difference in sigma per minute time period 2017/10/31</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;diff_snr_Bx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">magf_df</span><span class="o">.</span><span class="n">diff_med_Bx</span><span class="p">)</span><span class="o">/</span><span class="n">magf_df</span><span class="o">.</span><span class="n">diff_sig_Bx</span><span class="o">*</span><span class="n">par_ind_mag</span> 
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;diff_snr_By&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">magf_df</span><span class="o">.</span><span class="n">diff_med_By</span><span class="p">)</span><span class="o">/</span><span class="n">magf_df</span><span class="o">.</span><span class="n">diff_sig_By</span><span class="o">*</span><span class="n">par_ind_mag</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;diff_snr_Bz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">magf_df</span><span class="o">.</span><span class="n">diff_med_Bz</span><span class="p">)</span><span class="o">/</span><span class="n">magf_df</span><span class="o">.</span><span class="n">diff_sig_Bz</span><span class="o">*</span><span class="n">par_ind_mag</span>

    <span class="c1">#calculate difference B parameters</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;del_Bx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">magf_df</span><span class="o">.</span><span class="n">del_time_mag</span><span class="p">)</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;del_By&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">magf_df</span><span class="o">.</span><span class="n">del_time_mag</span><span class="p">)</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;del_Bz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">magf_df</span><span class="o">.</span><span class="n">del_time_mag</span><span class="p">)</span>

    <span class="c1">#Find difference on otherside</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;del_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span><span class="p">)</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;del_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span>   <span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span><span class="p">)</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;del_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span>  <span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span><span class="p">)</span>

    <span class="c1">#get the Energy Change per second</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;power&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">del_Np</span><span class="o">*</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">SPEED</span><span class="o">**</span><span class="mf">2.</span><span class="o">+</span><span class="mf">2.</span><span class="o">*</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_speed</span><span class="o">*</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">Np</span><span class="o">*</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">SPEED</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;Np_power&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">del_Np</span><span class="o">*</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">SPEED</span><span class="o">**</span><span class="mf">2.</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;speed_power&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_speed</span><span class="o">*</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">Np</span><span class="o">*</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">SPEED</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;Npth_power&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">del_Np</span><span class="o">*</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">Vth</span><span class="o">**</span><span class="mf">2.</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;Vth_power&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_Vth</span><span class="o">*</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">Np</span><span class="o">*</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">Vth</span>

    <span class="c1">#absolute value of the power</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;abs_power&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">power</span><span class="p">)</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;Np_abs_power&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">Np_power</span><span class="p">)</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;speed_abs_power&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">speed_power</span><span class="p">)</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;Npth_abs_power&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">Npth_power</span><span class="p">)</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;Vth_abs_power&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">Vth_power</span><span class="p">)</span>

    <span class="c1">#calculate variance normalized parameters</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;std_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_med_speed</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;std_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_med_Np</span>   <span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;std_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">roll_med_Vth</span>  <span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">del_time_pls</span>

    <span class="c1">#calculate standard dev in B parameters</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;std_Bx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magf_df</span><span class="o">.</span><span class="n">diff_sig_Bx</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;std_By&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magf_df</span><span class="o">.</span><span class="n">diff_sig_By</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;std_Bz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magf_df</span><span class="o">.</span><span class="n">diff_sig_Bz</span>
    
    <span class="c1">#Significance of the variation in the wind parameters</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;sig_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">del_speed</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">std_speed</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;sig_Np&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">del_Np</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">std_Np</span>
    <span class="n">plsm_df</span><span class="p">[</span><span class="s1">&#39;sig_Vth&#39;</span><span class="p">]</span>   <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">del_Vth</span><span class="o">/</span><span class="n">plsm_df</span><span class="o">.</span><span class="n">std_Vth</span>

    <span class="c1">#significance of variation in B parameters</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;sig_Bx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magf_df</span><span class="o">.</span><span class="n">del_Bx</span><span class="o">/</span><span class="n">magf_df</span><span class="o">.</span><span class="n">std_Bx</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;sig_By&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magf_df</span><span class="o">.</span><span class="n">del_By</span><span class="o">/</span><span class="n">magf_df</span><span class="o">.</span><span class="n">std_By</span>
    <span class="n">magf_df</span><span class="p">[</span><span class="s1">&#39;sig_Bz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">magf_df</span><span class="o">.</span><span class="n">del_Bz</span><span class="o">/</span><span class="n">magf_df</span><span class="o">.</span><span class="n">std_Bz</span>
    
    <span class="c1">#fill pesky nans and infs with 0 values</span>
    <span class="n">pls_fill</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sig_speed&#39;</span><span class="p">,</span><span class="s1">&#39;sig_Np&#39;</span><span class="p">,</span><span class="s1">&#39;sig_Vth&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;diff_snr_speed&#39;</span><span class="p">,</span><span class="s1">&#39;diff_snr_Np&#39;</span><span class="p">,</span><span class="s1">&#39;diff_snr_Vth&#39;</span><span class="p">,</span>
                <span class="s1">&#39;diff_pow_speed&#39;</span><span class="p">,</span><span class="s1">&#39;diff_pow_Np&#39;</span><span class="p">,</span><span class="s1">&#39;diff_pow_Vth&#39;</span><span class="p">,</span> 
                <span class="s1">&#39;diff_acc_speed&#39;</span><span class="p">,</span><span class="s1">&#39;diff_acc_Np&#39;</span><span class="p">,</span><span class="s1">&#39;diff_acc_Vth&#39;</span><span class="p">]</span>  
    <span class="n">mag_fill</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sig_Bx&#39;</span><span class="p">,</span><span class="s1">&#39;sig_By&#39;</span><span class="p">,</span><span class="s1">&#39;sig_Bz&#39;</span><span class="p">,</span>
                <span class="s1">&#39;diff_snr_Bx&#39;</span><span class="p">,</span><span class="s1">&#39;diff_snr_By&#39;</span><span class="p">,</span><span class="s1">&#39;diff_snr_Bz&#39;</span><span class="p">]</span>
                
                

    <span class="c1">#loop through and replace fill values with -9999.9</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pls_fill</span><span class="p">:</span> 
        <span class="n">plsm_df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plsm_df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=-</span><span class="mf">9999.9</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#loop through and replace fill values with -9999.9</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">mag_fill</span><span class="p">:</span> 
        <span class="n">magf_df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">magf_df</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">value</span><span class="o">=-</span><span class="mf">9999.9</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    
    <span class="c1">#create an array of constants that hold a place for the intercept </span>
    <span class="c1">#plsm_df[&#39;intercept&#39;] = 1 </span>


    <span class="c1">#only guess times with good data in plasma or magnetic field respectively</span>
    <span class="n">m_var</span> <span class="o">=</span> <span class="n">p_var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;predict&#39;</span><span class="p">,</span><span class="s1">&#39;predict_sigma&#39;</span><span class="p">)</span>
    <span class="n">plsm_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">p_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">logit_model</span><span class="p">(</span><span class="n">plsm_df</span><span class="p">,</span><span class="o">-</span><span class="mf">3.2437</span><span class="p">,</span><span class="mf">0.2365</span><span class="p">,</span><span class="mf">0.0464</span><span class="p">,</span><span class="mf">0.0594</span><span class="p">)</span>
    <span class="n">magf_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">m_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">logit_model</span><span class="p">(</span><span class="n">magf_df</span><span class="p">,</span><span class="o">-</span><span class="mf">10.0575</span><span class="p">,</span><span class="mf">0.6861</span><span class="p">,</span><span class="mf">0.7071</span><span class="p">,</span><span class="mf">0.6640</span><span class="p">,</span><span class="n">plasma</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#cur arrays to the bar minimum for matching</span>
    <span class="n">plsm_df</span> <span class="o">=</span> <span class="n">plsm_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="n">p_var</span><span class="p">,</span><span class="s1">&#39;diff_med_speed&#39;</span><span class="p">,</span> <span class="s1">&#39;diff_med_Np&#39;</span><span class="p">,</span> <span class="s1">&#39;diff_med_Vth&#39;</span><span class="p">,</span><span class="s1">&#39;diff_sig_speed&#39;</span><span class="p">,</span> <span class="s1">&#39;diff_sig_Np&#39;</span><span class="p">,</span> <span class="s1">&#39;diff_sig_Vth&#39;</span><span class="p">]]</span>
    <span class="n">magf_df</span> <span class="o">=</span> <span class="n">magf_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="n">m_var</span><span class="p">,</span><span class="s1">&#39;diff_med_Bx&#39;</span><span class="p">,</span> <span class="s1">&#39;diff_med_By&#39;</span><span class="p">,</span> <span class="s1">&#39;diff_med_Bz&#39;</span><span class="p">,</span> <span class="s1">&#39;diff_sig_Bx&#39;</span><span class="p">,</span> <span class="s1">&#39;diff_sig_By&#39;</span><span class="p">,</span> <span class="s1">&#39;diff_sig_Bz&#39;</span><span class="p">]]</span>
    
    <span class="c1">#update array with new p-values by matching on indices</span>
    <span class="n">outp_df</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">inpt_df</span><span class="p">,</span><span class="n">plsm_df</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">outp_df</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">outp_df</span><span class="p">,</span><span class="n">magf_df</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span><span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="c1">#forward fill NaN event probabilities</span>
    <span class="c1">#outp_df[p_var].ffill(inplace=True)</span>
    <span class="c1">#outp_df[m_var].ffill(inplace=True)</span>

    <span class="k">return</span> <span class="n">outp_df</span></div>


<span class="c1">#probability model and parameters to use</span>
<div class="viewcode-block" id="logit_model"><a class="viewcode-back" href="../source/code/matching_events_full_res.html#matching_events_full_res.logit_model">[docs]</a><span class="k">def</span> <span class="nf">logit_model</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">b0</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">b2</span><span class="p">,</span><span class="n">b3</span><span class="p">,</span><span class="n">plasma</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns a probability value for a set of input parameters</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df: Pandas DataFrame</span>
<span class="sd">        Pandas DataFrame containing plasma or magnetic field paraemters</span>
<span class="sd">    b0: float</span>
<span class="sd">        Logit model intercept</span>
<span class="sd">    b1: float</span>
<span class="sd">        Logit model slope for parameter 1 (either Bx or proton flow speed) </span>
<span class="sd">    b2: float</span>
<span class="sd">        Logit model slope for parameter 2 (either By or proton thermal velocity)</span>
<span class="sd">    b3: float</span>
<span class="sd">        Logit model slope for parameter 3 (either Bz or proton number density)</span>
<span class="sd">    plasma: boolean, optinal</span>
<span class="sd">        Use plasma parametes for model (Default = True)  or </span>
<span class="sd">        use magnetic field parameters (plasma=False)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    logit probability for a given set of parameters</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">plasma</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">diff_snr_speed</span><span class="o">*</span><span class="n">b1</span><span class="o">+</span><span class="n">df</span><span class="o">.</span><span class="n">diff_snr_Vth</span><span class="o">*</span><span class="n">b2</span><span class="o">+</span><span class="n">df</span><span class="o">.</span><span class="n">diff_snr_Np</span><span class="o">*</span><span class="n">b3</span><span class="o">+</span><span class="n">b0</span><span class="p">))</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">diff_snr_Bx</span><span class="o">*</span><span class="n">b1</span><span class="o">+</span><span class="n">df</span><span class="o">.</span><span class="n">diff_snr_By</span><span class="o">*</span><span class="n">b2</span><span class="o">+</span><span class="n">df</span><span class="o">.</span><span class="n">diff_snr_Bz</span><span class="o">*</span><span class="n">b3</span><span class="o">+</span><span class="n">b0</span><span class="p">))</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span> </div>

<div class="viewcode-block" id="help_chi_min"><a class="viewcode-back" href="../source/code/matching_events_full_res.html#matching_events_full_res.help_chi_min">[docs]</a><span class="k">def</span> <span class="nf">help_chi_min</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Allows for multiple arguments to be called by a Pooled Multiprocessor function</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    args: list</span>
<span class="sd">        A list of parameters in order of return_chi_min</span>

<span class="sd">    Return</span>
<span class="sd">    -----------</span>
<span class="sd">    time,chisq : Tuple</span>
<span class="sd">        Result of return_chi_min</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">return_chi_min</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span></div>


<div class="viewcode-block" id="dumb_chi_min"><a class="viewcode-back" href="../source/code/matching_events_full_res.html#matching_events_full_res.dumb_chi_min">[docs]</a><span class="k">def</span> <span class="nf">dumb_chi_min</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">current_process</span><span class="p">())</span>
    <span class="c1">#rgh_chi_t = args[0]</span>
    <span class="c1">#plsm      = args[1]</span>
    <span class="c1">#k         = args[2]</span>
    <span class="c1">#par       = args[3]</span>
    <span class="c1">#try_mag   = args[4]</span>
    <span class="c1">#try_pls   = args[5]</span>
    <span class="c1">#trainer_time = args[6]</span>
    <span class="c1">#time      = args[7]</span>
    <span class="c1">#trainer=&#39;Wind&#39;</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">args</span><span class="p">,</span><span class="n">chisq</span></div>

<span class="c1">#parallize chi^2 computation</span>
<div class="viewcode-block" id="return_chi_min"><a class="viewcode-back" href="../source/code/matching_events_full_res.html#matching_events_full_res.return_chi_min">[docs]</a><span class="k">def</span> <span class="nf">return_chi_min</span><span class="p">(</span><span class="n">rgh_chi_t</span><span class="p">,</span><span class="n">plsm</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">par</span><span class="p">,</span><span class="n">try_mag</span><span class="p">,</span><span class="n">try_pls</span><span class="p">,</span><span class="n">trainer_time</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">trainer</span><span class="o">=</span><span class="s1">&#39;Wind&#39;</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    return_chi_min computes the chi^2 min. time for a given set of parameters</span>
<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    rgh_chi_t: Pandas datetime delta object</span>
<span class="sd">        Time around a given time in p_mat to include in chi^2 minimization  </span>
<span class="sd">    plsm: dict</span>
<span class="sd">        Dictionary of plasma DataFrames of plasma Dataframes</span>
<span class="sd">    k   : string</span>
<span class="sd">        Spacecraft name in plsm dictionary</span>
<span class="sd">    par : string,list</span>
<span class="sd">        List of string of parameters to initially try and compute Chi^2 min on</span>
<span class="sd">    try_mag: boolean</span>
<span class="sd">        If true try to force using magnetic field for matching</span>
<span class="sd">    try_pls: boolean</span>
<span class="sd">        If true try to force flow speed matching </span>
<span class="sd">    trainer_time: Time index</span>
<span class="sd">        Time index of training spacecraft to match and get Chi^2 min.</span>
<span class="sd">    time: Time index</span>
<span class="sd">        Time index of nonprimary spacecraft to offset and match with primary spacecraft</span>
<span class="sd">    trainer: string</span>
<span class="sd">        The spacecraft to use for X^2 comparison (Default=Wind)</span>

<span class="sd">    RETURNS</span>
<span class="sd">    --------</span>
<span class="sd">    time,chisq : datetime index, calculate Chi^2</span>
<span class="sd">    Datetime index of  Chi^2 time and the Chi^2 value</span>

<span class="sd">    &quot;&quot;&quot;</span>
   

    <span class="c1">#get a region around one of the best fit times</span>
    <span class="n">com_slice</span> <span class="o">=</span> <span class="p">[</span><span class="n">time</span><span class="o">-</span><span class="n">rgh_chi_t</span><span class="p">,</span><span class="n">time</span><span class="o">+</span><span class="n">rgh_chi_t</span><span class="p">]</span>
    <span class="n">c_mat</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">com_slice</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">com_slice</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="c1">#update the time index of the match array for comparision with training spacecraft (i=training spacecraft time)</span>
    <span class="n">c_mat</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">c_mat</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="p">(</span><span class="n">trainer_time</span><span class="o">-</span><span class="n">time</span><span class="p">)</span>


    <span class="c1">#c_mat.SPEED.interpolate(&#39;time&#39;,inplace=True)</span>
    <span class="c1">#need to use values for correct logic</span>

    <span class="c1">#get training spacecraft time range</span>
    <span class="n">t_mat</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">trainer</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">():</span><span class="n">c_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>

    <span class="c1">#use magentic field for refinement for ACE, Wind, and DSCOVR</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;soho&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">try_mag</span><span class="p">)):</span> <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>

    <span class="c1">#use speed for rough esimation if possible</span>
    <span class="k">if</span> <span class="p">(((</span><span class="nb">len</span><span class="p">(</span><span class="n">c_mat</span><span class="p">[</span><span class="n">c_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">10.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">10.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">try_pls</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;soho&#39;</span><span class="p">)):</span> <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span> <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>


    <span class="c1">#remove bad Speed values </span>
    <span class="n">c_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">,</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>


    <span class="c1">#need to use finite values for correct logic</span>
    <span class="n">c_mat</span> <span class="o">=</span> <span class="n">c_mat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">c_mat</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>
    <span class="n">t_mat</span> <span class="o">=</span> <span class="n">t_mat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>

    <span class="c1">#drop duplicates when using more than one array value</span>
    <span class="c1">#use mag column because in has the higher sampling fequence</span>
    <span class="n">c_mat</span> <span class="o">=</span> <span class="n">c_mat</span><span class="p">[</span><span class="o">~</span><span class="n">c_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)]</span>
    <span class="n">t_mat</span> <span class="o">=</span> <span class="n">t_mat</span><span class="p">[</span><span class="o">~</span><span class="n">t_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)]</span>


    <span class="c1">#go to next time if DataFrame is empty</span>
    <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">c_mat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)):</span> 
        <span class="k">return</span> <span class="n">time</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>


    <span class="c1">#resample the matching (nontrained spacecraft to the trained spacecraft&#39;s timegrid and interpolate</span>
    <span class="n">c_mat</span> <span class="o">=</span> <span class="n">c_mat</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>


    <span class="c1">#get the median slope and offset</span>
    <span class="c1">#J. Prchlik (2017/11/20)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">med_m</span><span class="p">,</span><span class="n">med_i</span><span class="p">,</span><span class="n">low_s</span><span class="p">,</span><span class="n">hgh_s</span> <span class="o">=</span> <span class="n">theilslopes</span><span class="p">(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">c_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">c_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">c_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">*</span><span class="n">med_m</span><span class="o">+</span><span class="n">med_i</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
    <span class="c1">#get median offset to apply to match spacecraft</span>
        <span class="n">off_speed</span> <span class="o">=</span> <span class="n">c_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        <span class="n">c_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">c_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">-</span><span class="n">off_speed</span>
    

    <span class="c1">#sometimes different componets give better chi^2 values therefore reject the worst when more than 1 parameter</span>
    <span class="c1">#Try using the parameter with the largest difference  in B values preceding and including the event (2017/12/11 J. Prchlik)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
       <span class="c1">#par_chi = np.array([np.sum((((c_mat.loc[:,par_i]-t_mat.loc[:,par_i])/t_mat.loc[:,par_i].median())**2.).values)/float(len(c_mat)+len(t_mat)) for par_i in par])</span>
       <span class="c1">#use_par, = np.where(par_chi == np.min(par_chi))</span>
       <span class="n">par_chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;1950/10/10&#39;</span><span class="p">:</span><span class="n">trainer_time</span><span class="p">,</span><span class="n">par_i</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="k">for</span> <span class="n">par_i</span> <span class="ow">in</span> <span class="n">par</span><span class="p">])</span>
       <span class="n">use_par</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">par_chi</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">par_chi</span><span class="p">))</span>
       <span class="n">par</span>      <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">par</span><span class="p">)[</span><span class="n">use_par</span><span class="p">])</span>
       <span class="c1">#par = [&#39;Bt&#39;]</span>


    <span class="c1">#compute locate variation in parameters</span>
    <span class="c1">#from 15 pixels around the observation [J. Prchlik 2017/12/11]</span>
    <span class="n">loc_var</span> <span class="o">=</span> <span class="mi">15</span>
    <span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;lc_std_&#39;</span><span class="o">+</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">t_mat</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">loc_var</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">True</span> <span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">**</span><span class="mf">2.</span>
    <span class="n">c_mat</span><span class="p">[</span><span class="s1">&#39;lc_std_&#39;</span><span class="o">+</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">c_mat</span><span class="p">[</span><span class="n">par</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">loc_var</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">True</span> <span class="p">,</span><span class="n">min_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">**</span><span class="mf">2.</span>


    <span class="c1">#fill the first values</span>
    <span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;lc_std_&#39;</span><span class="o">+</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;bfill&#39;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">c_mat</span><span class="p">[</span><span class="s1">&#39;lc_std_&#39;</span><span class="o">+</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;bfill&#39;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;lc_std_&#39;</span><span class="o">+</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">c_mat</span><span class="p">[</span><span class="s1">&#39;lc_std_&#39;</span><span class="o">+</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;ffill&#39;</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#compute chi^2 value for Wind and other spacecraft</span>
    <span class="c1">#added computation number to prefer maximum overlap (i.e. won&#39;t shove to an edge) J. Prchlik 2017/11/15</span>
    <span class="c1">#Added uncertainty based on locale variables 2017/12/11 (J. Prchlik)</span>
    <span class="c1">#add logic to only get run upto event if using mag. fields 2017/10/11 J. Prchlik</span>
    <span class="k">if</span> <span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPEED&#39;</span><span class="p">:</span>
        <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">c_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">par</span><span class="p">]</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">par</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">/</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;lc_std_&#39;</span><span class="o">+</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">+</span><span class="n">c_mat</span><span class="p">[</span><span class="s1">&#39;lc_std_&#39;</span><span class="o">+</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;1 minutes&#39;</span><span class="p">)</span>
        <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">c_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">trainer_time</span><span class="o">+</span><span class="n">pad</span><span class="p">,</span><span class="n">par</span><span class="p">]</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">trainer_time</span><span class="o">+</span><span class="n">pad</span><span class="p">,</span><span class="n">par</span><span class="p">])</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">/</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;lc_std_&#39;</span><span class="o">+</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">+</span><span class="n">c_mat</span><span class="p">[</span><span class="s1">&#39;lc_std_&#39;</span><span class="o">+</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    <span class="c1">#Try using the median offset rather than chi^2 minimum (Did not work)</span>
    <span class="c1">#chisq = np.nanmedian(((c_mat.loc[:,par]-t_mat.loc[:,par])**2.).values)/float(len(c_mat)+len(t_mat))</span>
     

    <span class="k">return</span> <span class="n">time</span><span class="p">,</span><span class="n">chisq</span></div>


<span class="c1">#function to find the Chi^2 min value given a set of parameters</span>
<div class="viewcode-block" id="chi_min"><a class="viewcode-back" href="../source/code/matching_events_full_res.html#matching_events_full_res.chi_min">[docs]</a><span class="k">def</span> <span class="nf">chi_min</span><span class="p">(</span><span class="n">p_mat</span><span class="p">,</span><span class="n">par</span><span class="p">,</span><span class="n">rgh_chi_t</span><span class="p">,</span><span class="n">plsm</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">window</span><span class="p">,</span><span class="n">ref_window</span><span class="p">,</span><span class="n">trainer_t</span><span class="p">,</span><span class="n">color</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span><span class="n">ref_chi_t</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;10 minutes&#39;</span><span class="p">),</span><span class="n">refine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">n_fine</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="kc">True</span> <span class="p">,</span><span class="n">nproc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">use_discon</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    chi_min computes the chi^2 min. time for a given set of parameters</span>
<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    p_mat: Pandas DataFrame</span>
<span class="sd">        Solar wind pandas DataFrame for a space craft roughly sampled</span>
<span class="sd">    par : list</span>
<span class="sd">        List of parameters to use in the Chi^2 minimization </span>
<span class="sd">    rgh_chi_t: Pandas datetime delta object</span>
<span class="sd">        Time around a given time in p_mat to include in chi^2 minimization  </span>
<span class="sd">    ref_chi_t: Pandas datetime delta object</span>
<span class="sd">        Time around a given time in refined grid to include in chi^2 minimization  </span>
<span class="sd">    plsm: dict</span>
<span class="sd">        Dictionary of plasma DataFrames of plasma Dataframes </span>
<span class="sd">    k   : string</span>
<span class="sd">        Spacecraft name in plsm dictionary</span>
<span class="sd">    window : dictionary</span>
<span class="sd">        Spacecraft windows to use when matching</span>
<span class="sd">    ref_window : dictionary</span>
<span class="sd">        Spacecraft windows to use when refined matching</span>
<span class="sd">    trainer_t: Time index</span>
<span class="sd">        Time index of training spacecraft to match and get Chi^2 min.</span>
<span class="sd">    color: dictionary</span>
<span class="sd">        Dictionary of spacecraft colors (keys should be k)</span>
<span class="sd">    marker: dictionary</span>
<span class="sd">        Dictionary of spacecraft markers (keys should be k)</span>
<span class="sd">    refine: boolean</span>
<span class="sd">        Whether to use a refined window (Default = True)</span>
<span class="sd">    n_fine : integer</span>
<span class="sd">        Number of chi^2 min values from the rough grid to check with the fine grid (Default = 4)</span>
<span class="sd">    plot  : boolean,optional</span>
<span class="sd">        Plot Chi^2 minimization window (Default = False)</span>
<span class="sd">    use_discon : boolean,optional</span>
<span class="sd">        Only use discontinuity (Default = False)</span>

<span class="sd">    RETURNS</span>
<span class="sd">    --------</span>
<span class="sd">    i_min : datetime index</span>
<span class="sd">    Datetime index of best fit Chi^2 time</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c1">#if plot create plotting axis</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">chi_fig</span><span class="p">,</span><span class="n">chi_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="c1">#set up chisquared array in pandas object</span>
    <span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;chisq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
    <span class="c1">#keep one for plotting range</span>
    <span class="n">p_mat_r</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1">#first set to no time offset</span>
    <span class="n">i_min</span> <span class="o">=</span> <span class="n">trainer_t</span>


    <span class="c1">#loop and squeeze rough window</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>

        <span class="c1">#Dont loop if use_discon </span>
        <span class="k">if</span> <span class="p">((</span><span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">use_discon</span><span class="p">)):</span> <span class="k">continue</span>
        <span class="c1">#looping time around window to try to match</span>
        <span class="n">t_rgh_wid</span> <span class="o">=</span> <span class="n">window</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#looping range of window size</span>
        <span class="n">t_rgh_chi_t</span> <span class="o">=</span> <span class="n">ref_chi_t</span><span class="o">/</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1">#get all values in top n_fine at full resolution</span>
        <span class="n">p_mat</span>  <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="o">-</span><span class="n">t_rgh_wid</span><span class="p">:</span><span class="n">i_min</span><span class="o">+</span><span class="n">t_rgh_wid</span><span class="p">]</span>
        <span class="c1">#Use Flow Speed Cadence for rough esitmation</span>
        <span class="n">pt_mat</span>  <span class="o">=</span> <span class="n">p_mat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="p">)]</span>
        <span class="c1">#if no SPEED Values then use Total magentic field downsampled by 5</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p_mat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span> <span class="n">pt_mat</span> <span class="o">=</span> <span class="n">p_mat</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">Bt</span><span class="p">)]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[::</span><span class="mi">5</span><span class="p">,:]</span>

        <span class="c1">#list of to values to compute X^2 minium</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">index</span>
   

        <span class="c1">#Just use discontinuity</span>
        <span class="k">if</span> <span class="n">use_discon</span><span class="p">:</span> <span class="n">time</span><span class="o">=</span><span class="n">p_mat_r</span><span class="o">.</span><span class="n">index</span>
        

        <span class="c1">#create list to sent to processors</span>
        <span class="c1">#par_chi_min = partial(return_chi_min,rgh_chi_t,plsm,k,par,False,True,trainer_t)</span>
   
        <span class="c1">#Commented out by J. Prchlik (2017/11/29 for threading testing)</span>
        <span class="n">loop_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">time</span><span class="p">:</span> <span class="n">loop_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t_rgh_chi_t</span><span class="p">,</span><span class="n">plsm</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">par</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">trainer_t</span><span class="p">,</span><span class="n">l</span><span class="p">))</span>
        

        <span class="c1">#Do computation in Par. if requested (2017/12/14 J. Prchlik)</span>
        <span class="k">if</span> <span class="n">nproc</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">:</span>
            <span class="n">pool2</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">nproc</span><span class="p">)</span>
            <span class="c1">#Commented out by J. Prchlik (2017/11/29 for threading testing)</span>
            <span class="c1">#outp = pool2.map(dumb_chi_min,loop_list)</span>
            <span class="n">outp</span> <span class="o">=</span> <span class="n">pool2</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">help_chi_min</span><span class="p">,</span><span class="n">loop_list</span><span class="p">)</span>
            <span class="n">pool2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pool2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">outp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">loop_list</span><span class="p">:</span> <span class="n">outp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">help_chi_min</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>


        <span class="c1">#add chisq times to p_mat array</span>
        <span class="c1">#first is time index second is chisq value</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">outp</span><span class="p">:</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;chisq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        
        
        <span class="c1">#get the index of minimum chisq value</span>
        <span class="n">i_min</span> <span class="o">=</span> <span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;chisq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>

        <span class="c1">#plot chi^2 min</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span> <span class="n">chi_ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">p_mat</span><span class="o">.</span><span class="n">chisq</span><span class="o">/</span><span class="n">p_mat</span><span class="o">.</span><span class="n">chisq</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">label</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    
    <span class="c1">#use fine grid around observations to match time offset locally</span>
    <span class="k">if</span> <span class="n">refine</span><span class="p">:</span>

        <span class="c1">#use magentic field for refinement for ACE, Wind, and DSCOVR</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;soho&#39;</span><span class="p">:</span> <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span>

        <span class="c1">#Find 4 lowest chisq min times </span>
        <span class="c1">#p_temp = p_mat.sort_values(&#39;chisq&#39;,ascending=True )[:n_fine]</span>

        <span class="c1">#set the min value to interative solve for refinmenet</span>
        <span class="c1">#i_min = p_temp[&#39;chisq&#39;].idxmin()</span>
 
        <span class="c1">#loop and squeeze refinement window</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="c1">#interatively solve around 1 sigma</span>
            <span class="c1">#2017/12/11 J. Prchlik</span>
            <span class="n">i_sig</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;chisq&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">2.</span><span class="o">*</span><span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;chisq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),:]</span>

            <span class="c1">#looping time around window to try to match</span>
            <span class="n">t_ref_wid</span> <span class="o">=</span> <span class="n">ref_window</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1">#looping range of window size</span>
            <span class="n">t_ref_chi_t</span> <span class="o">=</span> <span class="n">ref_chi_t</span><span class="o">/</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1">#get all values in top n_fine at full resolution</span>
            <span class="c1">#p_mat  = plsm[k].loc[i_min-t_ref_wid:i_min+t_ref_wid]</span>
            <span class="c1">#print(p_temp.index.min()-rgh_chi_t,p_temp.index.max()+rgh_chi_t)</span>
            <span class="c1">#interatively solve around 1 sigma</span>
            <span class="c1">#2017/12/11 J. Prchlik</span>
            <span class="n">p_mat</span>  <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_sig</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">():</span><span class="n">i_sig</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
 
            <span class="c1">#list of to values to compute X^2 minium</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">index</span>
            <span class="c1">#create list of tuples to sent to processors</span>
            <span class="c1">#create list to sent to processors</span>
            <span class="c1">#ref_chi_min = partial(return_chi_min,ref_chi_t,plsm,k,par,True,False,trainer_t)</span>
            <span class="n">loop_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1">#try only using SPEED 2017/12/11</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">time</span><span class="p">:</span> <span class="n">loop_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t_ref_chi_t</span><span class="p">,</span><span class="n">plsm</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">par</span><span class="p">,</span><span class="kc">True</span> <span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="n">trainer_t</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
    
            <span class="c1">#Parallized chisq computation</span>
            <span class="k">if</span> <span class="n">nproc</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">:</span>
                <span class="n">pool3</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">nproc</span><span class="p">)</span>
                <span class="n">outp</span> <span class="o">=</span> <span class="n">pool3</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">help_chi_min</span><span class="p">,</span><span class="n">loop_list</span><span class="p">)</span>
                <span class="n">pool3</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="n">pool3</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">pool3</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outp</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">loop_list</span><span class="p">:</span> <span class="n">outp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">help_chi_min</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>


            <span class="c1">#add chisq times to p_mat array</span>
            <span class="c1">#first is time index second is chisq value</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outp</span><span class="p">:</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;chisq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1">#get the index of minimum refined chisq value</span>
            <span class="n">i_min</span> <span class="o">=</span> <span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;chisq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>

      
            <span class="c1">#variable to exit while loop</span>
            <span class="n">looper</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="c1">#check to see if chisq min is at an edge but if it is still at an edge after 3 tries give up</span>
            <span class="k">while</span> <span class="p">(((</span><span class="n">i_min</span> <span class="o">==</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">|</span> <span class="p">(</span><span class="n">i_min</span> <span class="o">==</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">looper</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)):</span>
                <span class="c1">#get all values in top n_fine at full resolution</span>
                <span class="n">p_mat</span>  <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="p">(</span><span class="n">t_ref_wid</span><span class="o">*</span><span class="p">(</span><span class="n">looper</span><span class="o">+</span><span class="mi">1</span><span class="p">)):</span><span class="n">p_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="p">(</span><span class="n">t_ref_wid</span><span class="o">*</span><span class="p">(</span><span class="n">looper</span><span class="o">+</span><span class="mi">1</span><span class="p">))]</span>
                <span class="c1">#list of to values to compute X^2 minium</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">index</span>
                <span class="n">loop_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="c1">#create list to pass to function</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">time</span><span class="p">:</span> <span class="n">loop_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">t_ref_chi_t</span><span class="p">,</span><span class="n">plsm</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">par</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">,</span><span class="n">trainer_t</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>

                <span class="c1">#Parallized chisq computation</span>
                <span class="k">if</span> <span class="n">nproc</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">:</span>
                    <span class="n">pool4</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">nproc</span><span class="p">)</span>
                    <span class="n">outp</span> <span class="o">=</span> <span class="n">pool4</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">help_chi_min</span><span class="p">,</span><span class="n">loop_list</span><span class="p">)</span>
                    <span class="n">pool4</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="n">pool4</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">pool4</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outp</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">loop_list</span><span class="p">:</span> <span class="n">outp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">help_chi_min</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>


                <span class="c1">#add chisq times to p_mat array</span>
                <span class="c1">#first is time index second is chisq value</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outp</span><span class="p">:</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s1">&#39;chisq&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1">#get the index of minimum refined chisq value</span>
                <span class="n">i_min</span> <span class="o">=</span> <span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;chisq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
  
                <span class="c1">#Add 1 to running loop</span>
                <span class="n">looper</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="c1">#get the index of minimum refined chisq value</span>
            <span class="n">i_min</span> <span class="o">=</span> <span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;chisq&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
            <span class="c1">#plot chi^2 min</span>
            <span class="k">if</span> <span class="n">plot</span><span class="p">:</span> <span class="n">chi_ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">p_mat</span><span class="o">.</span><span class="n">chisq</span><span class="o">/</span><span class="n">p_mat</span><span class="o">.</span><span class="n">chisq</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ref. </span><span class="si">{0:1d}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    
    
    <span class="c1">#set up plot for chi^2 min</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">chi_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scatterpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">chi_ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">p_mat_r</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;30 minutes&#39;</span><span class="p">),</span><span class="n">p_mat_r</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;30 minutes&#39;</span><span class="p">)])</span>
        <span class="n">chi_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$\chi^2$&#39;</span><span class="p">)</span>
        <span class="n">chi_ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [UTC]&#39;</span><span class="p">)</span>
        <span class="c1">#set plot maximum to be 10% higher than the max value</span>
        <span class="c1">#ymax = 1.1*np.nanmax(p_mat.chisq.values/p_mat.chisq.min())</span>
    
        <span class="c1">##if ymax &gt; 10 then set ymax to 10</span>
        <span class="c1">#if ymax &gt; 10.: ymax = 10.</span>
        <span class="n">ymax</span><span class="o">=</span> <span class="mi">10</span>
        
        <span class="n">chi_ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span><span class="n">ymax</span><span class="p">])</span>
        <span class="n">fancy_plot</span><span class="p">(</span><span class="n">chi_ax</span><span class="p">)</span>
        <span class="n">chi_fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;../plots/spacecraft_events/chisq/chi_min_{0:%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S}_</span><span class="si">{1}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trainer_t</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span><span class="n">bbox_pad</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="c1">#ax.set_ylim([300,1000.])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">chi_fig</span><span class="p">)</span>
   
    <span class="c1">#get upper and lower bounds in Chi^2</span>
    <span class="n">i_upp</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">:</span><span class="s1">&#39;2100/10/01&#39;</span><span class="p">,</span><span class="s1">&#39;chisq&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;chisq&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>
    <span class="n">i_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;1900/10/01&#39;</span><span class="p">:</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;chisq&#39;</span><span class="p">]</span><span class="o">-</span><span class="mf">2.</span><span class="o">*</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;chisq&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">idxmin</span><span class="p">()</span>

    <span class="c1">#return best fit, 1sigma upper limit, 1 sigma lower limit</span>
    <span class="k">return</span> <span class="n">i_min</span><span class="p">,</span><span class="n">i_upp</span><span class="p">,</span><span class="n">i_low</span></div>
    
<div class="viewcode-block" id="dtw_min"><a class="viewcode-back" href="../source/code/matching_events_full_res.html#matching_events_full_res.dtw_min">[docs]</a><span class="k">def</span> <span class="nf">dtw_min</span><span class="p">(</span><span class="n">p_mat</span><span class="p">,</span><span class="n">par</span><span class="p">,</span><span class="n">rgh_chi_t</span><span class="p">,</span><span class="n">plsm</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">window</span><span class="p">,</span><span class="n">ref_window</span><span class="p">,</span><span class="n">trainer_t</span><span class="p">,</span><span class="n">color</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span><span class="n">ref_chi_t</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;10 minutes&#39;</span><span class="p">),</span><span class="n">refine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">n_fine</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="kc">True</span> <span class="p">,</span><span class="n">nproc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">use_discon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">trainer</span><span class="o">=</span><span class="s1">&#39;Wind&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    dtw_min computes the average dynamic time warping value for a given set of parameters</span>
<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    p_mat: Pandas DataFrame</span>
<span class="sd">        Solar wind pandas DataFrame for a space craft roughly sampled</span>
<span class="sd">    par : list</span>
<span class="sd">        List of parameters to use in the Chi^2 minimization </span>
<span class="sd">    rgh_chi_t: Pandas datetime delta object</span>
<span class="sd">        Time around a given time in p_mat to include in chi^2 minimization  </span>
<span class="sd">    ref_chi_t: Pandas datetime delta object</span>
<span class="sd">        Time around a given time in refined grid to include in chi^2 minimization  </span>
<span class="sd">    plsm: dict</span>
<span class="sd">        Dictionary of plasma DataFrames of plasma Dataframes </span>
<span class="sd">    k   : string</span>
<span class="sd">        Spacecraft name in plsm dictionary</span>
<span class="sd">    window : dictionary</span>
<span class="sd">        Spacecraft windows to use when matching</span>
<span class="sd">    ref_window : dictionary</span>
<span class="sd">        Spacecraft windows to use when refined matching</span>
<span class="sd">    trainer_t: Time index</span>
<span class="sd">        Time index of training spacecraft to match and get Chi^2 min.</span>
<span class="sd">    color: dictionary</span>
<span class="sd">        Dictionary of spacecraft colors (keys should be k)</span>
<span class="sd">    marker: dictionary</span>
<span class="sd">        Dictionary of spacecraft markers (keys should be k)</span>
<span class="sd">    refine: boolean</span>
<span class="sd">        Whether to use a refined window (Default = True)</span>
<span class="sd">    n_fine : integer</span>
<span class="sd">        Number of chi^2 min values from the rough grid to check with the fine grid (Default = 4)</span>
<span class="sd">    plot  : boolean,optional</span>
<span class="sd">        Plot Chi^2 minimization window (Default = False)</span>
<span class="sd">    use_discon : boolean,optional</span>
<span class="sd">        Only use discontinuity (Default = False)</span>
<span class="sd">    trainer : string, optional</span>
<span class="sd">        Spacecraft to match back to in dynamic time warping (Default = &#39;Wind&#39;)</span>

<span class="sd">    RETURNS</span>
<span class="sd">    --------</span>
<span class="sd">    i_min,i_upp,i_low : datetime index</span>
<span class="sd">    Average Dynamic Time warp and its upper and lower limit standard deviation</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="c1">#if plot create plotting axis</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">chi_fig</span><span class="p">,</span><span class="n">chi_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="c1">#scanning array for determining which B component to use for fitting</span>
    <span class="n">sc_reg</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;3 minutes&#39;</span><span class="p">)</span>

    <span class="c1">#inital guess is no time shift</span>
    <span class="n">i_min</span> <span class="o">=</span> <span class="n">trainer_t</span>

    <span class="c1">#loop and squeeze rough window</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>

        <span class="c1">#looping time around window to try to match</span>
        <span class="n">t_rgh_wid</span> <span class="o">=</span> <span class="n">window</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#looping range of window size</span>
        <span class="n">t_rgh_chi_t</span> <span class="o">=</span> <span class="n">ref_chi_t</span><span class="o">/</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1">#get all values in top n_fine at full resolution</span>
        <span class="n">p_mat</span>  <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="o">-</span><span class="n">t_rgh_wid</span><span class="p">:</span><span class="n">i_min</span><span class="o">+</span><span class="n">t_rgh_wid</span><span class="p">]</span>
        <span class="n">t_mat</span>  <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">trainer</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trainer_t</span><span class="o">-</span><span class="n">t_rgh_wid</span><span class="p">:</span><span class="n">trainer_t</span><span class="o">+</span><span class="n">t_rgh_wid</span><span class="p">]</span>

        <span class="c1">#use speed for rough esimation if possible</span>
        <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1000.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">p_mat</span><span class="p">[</span><span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">1000.</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;soho&#39;</span><span class="p">)):</span> <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>

        <span class="c1">#sometimes different componets give better chi^2 values therefore reject the worst when more than 1 parameter</span>
        <span class="c1">#Try using the parameter with the largest difference  in B values preceding and including the event (2017/12/11 J. Prchlik)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
           <span class="n">par_chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trainer_t</span><span class="o">-</span><span class="n">sc_reg</span><span class="p">:</span><span class="n">trainer_t</span><span class="o">+</span><span class="n">sc_reg</span><span class="p">,</span><span class="n">par_i</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trainer_t</span><span class="o">-</span><span class="n">sc_reg</span><span class="p">:</span><span class="n">trainer_t</span><span class="o">+</span><span class="n">sc_reg</span><span class="p">,</span><span class="n">par_i</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">par_i</span> <span class="ow">in</span> <span class="n">par</span><span class="p">])</span>
           <span class="n">use_par</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">par_chi</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">par_chi</span><span class="p">))</span>
           <span class="n">par</span>      <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">par</span><span class="p">)[</span><span class="n">use_par</span><span class="p">])</span>

        <span class="c1">#dropa na values of index of p_mat and t_mat for given par</span>
        <span class="n">t_mat</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="n">subset</span><span class="o">=</span><span class="n">par</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">p_mat</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="n">subset</span><span class="o">=</span><span class="n">par</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>




        <span class="c1">#get the median slope and offset</span>
        <span class="c1">#J. Prchlik (2017/11/20)</span>
        <span class="c1">#Dont use interpolated time for solving dynamic time warp (J. Prchlik 2017/12/15)</span>
        <span class="c1">#only try SPEED corrections for SOHO observations</span>
        <span class="c1">#Only apply speed correction after 1 iteration (J. Prchlik 2017/12/18)</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;soho&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1">#create copy of p_mat</span>
                <span class="n">c_mat</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="c1">#resample the matching (nontrained spacecraft to the trained spacecraft&#39;s timegrid to correct offset (2017/12/15 J. Prchlik)</span>
                <span class="n">c_mat</span> <span class="o">=</span> <span class="n">c_mat</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

                <span class="c1">#only comoare no NaN values</span>
                <span class="n">good</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">c_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">values</span><span class="p">))))</span>
                <span class="n">c_mat</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">t_mat</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="p">(</span><span class="n">trainer_t</span><span class="o">-</span><span class="n">i_min</span><span class="p">)</span>

                <span class="c1">#if few points for comparison only used baseline offset</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">good</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mf">10.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPEED&#39;</span><span class="p">)):</span>
                    <span class="n">med_m</span><span class="p">,</span><span class="n">med_i</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span> 
                    <span class="n">off_speed</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                    <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">-</span><span class="n">off_speed</span>
                    <span class="k">if</span> <span class="n">med_m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">*</span><span class="n">med_m</span><span class="o">+</span><span class="n">med_i</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">off_speed</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                    <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">-</span><span class="n">off_speed</span>
                <span class="c1">#only apply slope if greater than 0</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c1">#get median offset to apply to match spacecraft</span>
                <span class="n">off_speed</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">-</span><span class="n">off_speed</span>
    


        <span class="c1">#get dynamic time warping value   </span>
        <span class="n">dist</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">mlpy</span><span class="o">.</span><span class="n">dtw_std</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">p_mat</span><span class="p">[</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">dist_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        

        <span class="c1">#get training number value</span>
        <span class="n">t_nind</span> <span class="o">=</span> <span class="n">t_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">trainer_t</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>

        <span class="c1">#find where path equals number index value</span>
        <span class="n">t_path</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">t_nind</span><span class="p">)</span>
        <span class="c1">#if more than one location returned grab the first and remove array type</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>

        <span class="c1">#get the other spacecraft&#39;s number index to match to the training craft</span>
        <span class="n">s_path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">t_path</span><span class="p">]</span> 

        <span class="c1">#get the index of dtw value</span>
        <span class="n">i_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">p_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">s_path</span><span class="p">,:]</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">s_path</span><span class="p">,:]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">to_pytimedelta</span><span class="p">())</span>
                <span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">s_path</span><span class="p">,:]</span><span class="o">.</span><span class="n">index</span><span class="p">))</span> <span class="o">+</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">s_path</span><span class="p">,:]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="c1">#calculate the mean absolute difference over the entire range 2017/12/20 J. Prchlik</span>
        <span class="c1">#calculate the mean absolute difference over the inner 10 pixels (2*err_wid[error window])</span>
        <span class="c1">#2017/12/20 J. Prchlik </span>
        <span class="n">err_wid</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">i_std</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">p_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">t_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span> 
                 <span class="o">+</span> <span class="p">(</span><span class="n">trainer_t</span><span class="o">-</span><span class="n">i_min</span><span class="p">))</span><span class="o">.</span><span class="n">to_pytimedelta</span><span class="p">()[</span><span class="n">t_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">err_wid</span><span class="p">:</span><span class="n">t_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">err_wid</span><span class="p">]))</span><span class="o">/</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">err_wid</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

        <span class="c1">#Convert back to py time delta</span>
        <span class="n">i_std</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">i_std</span><span class="p">)</span>
        <span class="c1">#calculate upper and lower limits</span>
        <span class="n">i_upp</span> <span class="o">=</span> <span class="n">i_min</span><span class="o">+</span><span class="n">i_std</span> 
        <span class="n">i_low</span> <span class="o">=</span> <span class="n">i_min</span><span class="o">-</span><span class="n">i_std</span> 

        <span class="c1">#plot chi^2 min</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span> <span class="n">chi_ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i_min</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">i_std</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">fmt</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    
    <span class="c1">#use fine grid around observations to match time offset locally</span>
    <span class="k">if</span> <span class="n">refine</span><span class="p">:</span>

        <span class="c1">#use magentic field for refinement for ACE, Wind, and DSCOVR</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;soho&#39;</span><span class="p">:</span> <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span>
        <span class="c1">#par = [&#39;SPEED&#39;]</span>

        <span class="c1">#loop and squeeze refinement window</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>

            <span class="c1">#define refined widow as 3*simga</span>
            <span class="n">t_ref_wid</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">i_std</span><span class="c1">#/(j+1)</span>
            <span class="n">t_ref_pas</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">i_std</span><span class="c1">#/(j+1)</span>

            <span class="c1">#get all values in top n_fine at full resolution</span>
            <span class="n">p_mat</span>  <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="o">-</span><span class="n">t_ref_wid</span><span class="p">:</span><span class="n">i_min</span><span class="o">+</span><span class="n">t_ref_pas</span><span class="p">]</span>
            <span class="n">t_mat</span>  <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">trainer</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trainer_t</span><span class="o">-</span><span class="n">t_ref_wid</span><span class="p">:</span><span class="n">trainer_t</span><span class="o">+</span><span class="n">t_ref_pas</span><span class="p">]</span>

            <span class="c1">#Make sure both spacecraft have observations in range (Only do after rough calculations</span>
            <span class="c1"># 2017/12/20 J. Prchlik</span>
            <span class="n">p_mat</span>  <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">t_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">():</span><span class="n">t_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
            <span class="n">t_mat</span>  <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">trainer</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">p_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">():</span><span class="n">p_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>


            <span class="c1">#sometimes different componets give better chi^2 values therefore reject the worst when more than 1 parameter</span>
            <span class="c1">#Try using the parameter with the largest difference  in B values preceding and including the event (2017/12/11 J. Prchlik)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
               <span class="n">par_chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trainer_t</span><span class="o">-</span><span class="n">sc_reg</span><span class="p">:</span><span class="n">trainer_t</span><span class="o">+</span><span class="n">sc_reg</span><span class="p">,</span><span class="n">par_i</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">trainer_t</span><span class="o">-</span><span class="n">sc_reg</span><span class="p">:</span><span class="n">trainer_t</span><span class="o">+</span><span class="n">sc_reg</span><span class="p">,</span><span class="n">par_i</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">par_i</span> <span class="ow">in</span> <span class="n">par</span><span class="p">])</span>
               <span class="n">use_par</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">par_chi</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">par_chi</span><span class="p">))</span>
               <span class="n">par</span>      <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">par</span><span class="p">)[</span><span class="n">use_par</span><span class="p">])</span>

            <span class="c1">#dropa na values of index of p_mat and t_mat for given par</span>
            <span class="n">t_mat</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="n">subset</span><span class="o">=</span><span class="n">par</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">p_mat</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span><span class="n">subset</span><span class="o">=</span><span class="n">par</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1">#get the median slope and offset</span>
            <span class="c1">#J. Prchlik (2017/11/20)</span>
            <span class="c1">#Dont use interpolated time for solving dynamic time warp (J. Prchlik 2017/12/15)</span>
            <span class="c1">#only try SPEED corrections for SOHO observations</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;soho&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1">#create copy of p_mat</span>
                    <span class="n">c_mat</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="c1">#resample the matching (nontrained spacecraft to the trained spacecraft&#39;s timegrid to correct offset (2017/12/15 J. Prchlik)</span>
                    <span class="n">c_mat</span> <span class="o">=</span> <span class="n">c_mat</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

                    <span class="c1">#only comoare no NaN values</span>
                    <span class="n">good</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">c_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">values</span><span class="p">))))</span>
                    <span class="n">c_mat</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">t_mat</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="p">(</span><span class="n">trainer_t</span><span class="o">-</span><span class="n">i_min</span><span class="p">)</span>

                    <span class="c1">#if few points for comparison only used baseline offset</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">good</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mf">10.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPEED&#39;</span><span class="p">)):</span>
                        <span class="n">med_m</span><span class="p">,</span><span class="n">med_i</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span> 
                        <span class="n">off_speed</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                        <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">-</span><span class="n">off_speed</span>
                        <span class="k">if</span> <span class="n">med_m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">*</span><span class="n">med_m</span><span class="o">+</span><span class="n">med_i</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">off_speed</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                        <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">-</span><span class="n">off_speed</span>
                    <span class="c1">#only apply slope if greater than 0</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="c1">#get median offset to apply to match spacecraft</span>
                    <span class="n">off_speed</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                    <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">-</span><span class="n">off_speed</span>

            <span class="c1">#do no addition refinement if window is smaller than 5 points</span>
            <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">p_mat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)):</span> <span class="k">continue</span>

            <span class="c1">#get dynamic time warping value   </span>
            <span class="n">dist</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">mlpy</span><span class="o">.</span><span class="n">dtw_std</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">p_mat</span><span class="p">[</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">dist_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            

   
            <span class="c1">#get training number value (need nearest because switching to mag. from plasma data)</span>
            <span class="n">t_nind</span> <span class="o">=</span> <span class="n">t_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">trainer_t</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>

            <span class="c1">#find where path equals number index value</span>
            <span class="n">t_path</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">t_nind</span><span class="p">)</span>
            <span class="c1">#if more than one location returned grab the first and remove array type</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>

            <span class="c1">#get the other spacecraft&#39;s number index to match to the training craft</span>
            <span class="n">s_path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">t_path</span><span class="p">]</span> 

            <span class="c1">#get the index of dtw value</span>
            <span class="n">i_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">p_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">s_path</span><span class="p">,:]</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">s_path</span><span class="p">,:]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">to_pytimedelta</span><span class="p">())</span>
                    <span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">s_path</span><span class="p">,:]</span><span class="o">.</span><span class="n">index</span><span class="p">))</span> <span class="o">+</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">s_path</span><span class="p">,:]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="c1">#calculate the mean absolute difference over the entire range</span>
            <span class="n">i_std</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">p_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">],:]</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">t_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span><span class="o">.</span><span class="n">index</span> 
                     <span class="o">+</span> <span class="p">(</span><span class="n">trainer_t</span><span class="o">-</span><span class="n">i_min</span><span class="p">))</span><span class="o">.</span><span class="n">to_pytimedelta</span><span class="p">()))</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">^</span><span class="mi">2</span><span class="p">))</span>
  
            <span class="c1">#calculate upper and lower limits</span>
            <span class="n">i_upp</span> <span class="o">=</span> <span class="n">i_min</span><span class="o">+</span><span class="n">i_std</span> 
            <span class="n">i_low</span> <span class="o">=</span> <span class="n">i_min</span><span class="o">-</span><span class="n">i_std</span> 

            <span class="k">if</span> <span class="n">plot</span><span class="p">:</span> <span class="n">chi_ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">i_min</span><span class="p">,</span><span class="n">yerr</span><span class="o">=</span><span class="n">i_std</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Refined </span><span class="si">{0}</span><span class="s1"> </span><span class="si">{1}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">fmt</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    
    
    <span class="c1">#set up plot for chi^2 min</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">chi_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scatterpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">chi_ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
        <span class="n">chi_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Best Fit Time [UTC]&#39;</span><span class="p">)</span>
       <span class="c1"># #set plot maximum to be 10% higher than the max value</span>
       <span class="c1"># #ymax = 1.1*np.nanmax(p_mat.chisq.values/p_mat.chisq.min())</span>
    
       <span class="c1"># ##if ymax &gt; 10 then set ymax to 10</span>
       <span class="c1"># #if ymax &gt; 10.: ymax = 10.</span>
       <span class="c1"># ymax= 10</span>
       <span class="c1"># </span>
       <span class="c1"># chi_ax.set_ylim([0.5,ymax])</span>
        <span class="n">fancy_plot</span><span class="p">(</span><span class="n">chi_ax</span><span class="p">)</span>
        <span class="n">chi_fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;../plots/spacecraft_events/chisq/chi_min_{0:%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S}_</span><span class="si">{1}</span><span class="s1">.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trainer_t</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span><span class="n">bbox_pad</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="c1">#ax.set_ylim([300,1000.])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">chi_fig</span><span class="p">)</span>
   
    <span class="c1">#get upper and lower bounds in Chi^2</span>

    <span class="c1">#return best fit, 1sigma upper limit, 1 sigma lower limit</span>
    <span class="k">return</span> <span class="n">i_min</span><span class="p">,</span><span class="n">i_upp</span><span class="p">,</span><span class="n">i_low</span></div>
    
<div class="viewcode-block" id="main"><a class="viewcode-back" href="../source/code/matching_events_full_res.html#matching_events_full_res.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">craft</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Wind&#39;</span><span class="p">,</span><span class="s1">&#39;DSCOVR&#39;</span><span class="p">,</span><span class="s1">&#39;ACE&#39;</span><span class="p">,</span><span class="s1">&#39;SOHO&#39;</span><span class="p">],</span><span class="n">col</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="s1">&#39;teal&#39;</span><span class="p">],</span><span class="n">mar</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;&#39;</span><span class="p">],</span>
         <span class="n">use_craft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">use_chisq</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">use_discon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">use_dtw</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">refine</span><span class="o">=</span><span class="kc">True</span> <span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nproc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">p_val</span><span class="o">=</span><span class="mf">0.999</span><span class="p">,</span>
         <span class="n">ref_chi_t</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;30 minutes&#39;</span><span class="p">),</span><span class="n">rgh_chi_t</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;90 minutes&#39;</span><span class="p">),</span>
         <span class="n">arch</span><span class="o">=</span><span class="s1">&#39;../cdf/cdftotxt/&#39;</span><span class="p">,</span><span class="n">mag_fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_mag_2015_2017_formatted.txt&#39;</span><span class="p">,</span><span class="n">pls_fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_pls_2015_2017_formatted.txt&#39;</span><span class="p">,</span><span class="n">orb_fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_orb_2015_2017_formatted.txt&#39;</span><span class="p">,</span>
         <span class="n">start_t</span><span class="o">=</span><span class="s1">&#39;2017/11/17&#39;</span><span class="p">,</span><span class="n">end_t</span><span class="o">=</span><span class="s1">&#39;2017/07/31&#39;</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function which finds solar wind events in a specific spacecraft. Then the program does a Chi^2 minimization to find the event</span>
<span class="sd">    in the other spacecraft. In doing so it creates a series of plots and a html table to summarize the results.</span>

<span class="sd">    Usage</span>
<span class="sd">    ----------</span>
<span class="sd">    Example:</span>
<span class="sd">    python&gt; import matching_events_full_res as fr</span>
<span class="sd">    python&gt; import pandas as pd</span>
<span class="sd">    python&gt; fr.main(nproc=1,p_val=0.950,use_chisq=False,use_discon=False,use_dtw=True ,rgh_chi_t=pd.to_timedelta(&#39;50 minutes&#39;),refine=False,start_t=&#39;2016/06/04&#39;,end_t=&#39;2017/09/14&#39;,plot=True ,center=True)</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    craft: list, optional</span>
<span class="sd">        List of spacecraft to analyze for events. The first spacecraft in the list finds the events and is the reference point</span>
<span class="sd">        for the Chi^2 minimization (Default = [&#39;Wind&#39;,&#39;DSCOVR&#39;,&#39;ACE&#39;,&#39;SOHO&#39;]).</span>
<span class="sd">    col  : list, optional</span>
<span class="sd">        List of matplotlib colors for plotting spacecraft points. The color list index corresponds to the index in craft</span>
<span class="sd">        (Default = [&#39;blue&#39;,&#39;black&#39;,&#39;red&#39;,&#39;teal&#39;]).</span>
<span class="sd">    mar  : list, optional</span>
<span class="sd">        List of matplotlib markers for plotting spacecraft points. The marker list index corresponds to the index in craft</span>
<span class="sd">        (Default = [&#39;D&#39;,&#39;o&#39;,&#39;s&#39;,&#39;&lt;&#39;]).</span>
<span class="sd">    use_craft : boolean, optional</span>
<span class="sd">        Use spacecraft positions to restrict finding range (Default = False). It turns out a lot of events are not radial </span>
<span class="sd">        therefore use_craft is no useful. </span>
<span class="sd">    use_chisq : boolean, optional</span>
<span class="sd">        Use Chi^2 minimization to find corresponding events between spacecraft. The Chi^2 minimum value relates to a given </span>
<span class="sd">        spacecraft and the first spacecraft in the craft list (Default = True).</span>
<span class="sd">    use_discon: boolean, optional</span>
<span class="sd">        Use Chi^2 minimization to find corresponding events between spacecraft, but only set on discontinuities. </span>
<span class="sd">        The Chi^2 minimum value relates to a given spacecraft and the first spacecraft in the craft list (Default = False).</span>
<span class="sd">    use_dtw: boolean, optional</span>
<span class="sd">        Dynamic time warping to find the best off set time (Default= False).</span>
<span class="sd">    plot      : boolean, optional</span>
<span class="sd">        Plot the Chi^2 minimum values as a function of time for a given spacecraft with respect to the reference spacecraft</span>
<span class="sd">        (Default = True). You should keep this parameter on because the output html file references this created file.</span>
<span class="sd">    refine:  boolean, optional</span>
<span class="sd">        Refine Chi^2 minimization by loop with smaller ranges,windows around previous minimum at the highest possible</span>
<span class="sd">        observational cadence (Default = True).</span>
<span class="sd">    verbose: boolean, optional</span>
<span class="sd">        Print the process time for an event (Default = True).</span>
<span class="sd">    nproc  : integer, optional</span>
<span class="sd">        Number of processors to use in Chi^2 minimization (Default = 1). For 1 event I see a 30% time decrease by using</span>
<span class="sd">        nproc=8 over nproc=1.</span>
<span class="sd">    p_val : float, optional</span>
<span class="sd">        Probability value (0&lt;p_val&lt;1.0) used to define an event (Default = 0.999). Do not set value below 0.90 for two reasons.</span>
<span class="sd">        One that creates a lot of &quot;bad events&quot; (i.e. events not seen in all four spacecraft or use instrument spikes.) two </span>
<span class="sd">        currently the code has a cut of 0.90 to define an event start.</span>
<span class="sd">    ref_chi_t : pandas time delta object, optional</span>
<span class="sd">        Size of window around an event (+/-) to find the Chi^2 minimum for a refined window (Default = pd.to_timedelta(&#39;30 minutes&#39;)).</span>
<span class="sd">        During refinement the window will run once and shrink two times by 1+loop (Default = 30,15,10).</span>
<span class="sd">    rgh_chi_t : pandas time delta object, optional</span>
<span class="sd">        Size of window around an event (+/-) to find the Chi^2 minimum for a rough window (Default = pd.to_timedelta(&#39;90 minutes&#39;)).</span>
<span class="sd">        During the rough minimization the window will run once and shrink once by 1+loop (Default = 90,45).</span>
<span class="sd">    arch: string, optional</span>
<span class="sd">        The archive location for the text file to read in (Default = &#39;../cdf/cdftotxt/&#39;)</span>
<span class="sd">    mag_fmt: string, optional</span>
<span class="sd">        The file format for the magnetic field observations (Default = &#39;{0}_mag_2015_2017_formatted.txt&#39;,</span>
<span class="sd">        where 0 is the formatted k).</span>
<span class="sd">    pls_fmt: string, optional</span>
<span class="sd">        The file format for the plasma observations (Default = &#39;{0}_pls_2015_2017_formatted.txt&#39;,</span>
<span class="sd">        where 0 is the formatted k).</span>
<span class="sd">    orb_fmt: string, optional</span>
<span class="sd">        The file format for the orbital data (Default = &#39;{0}_orb_2015_2017_formatted.txt&#39;,</span>
<span class="sd">        where 0 is the formatted k).</span>
<span class="sd">    start_t: string, optional</span>
<span class="sd">        Date in YYYY/MM/DD format to start looking for events (Default = &#39;2016/06/04&#39;)</span>
<span class="sd">    start_t: string, optional</span>
<span class="sd">        Date in YYYY/MM/DD format to stop looking for events (inclusive, Default = &#39;2017/07/31&#39;)</span>
<span class="sd">    center = boolean, optional</span>
<span class="sd">        Whether the analyzed point to be center focused (center = True) or right focus (Default = False).</span>
<span class="sd">        Using a right focused model I find better agreement with events found by eye.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#dictionary for storing the Pandas Data frame</span>
    <span class="n">pls</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mag</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">plsm</span> <span class="o">=</span> <span class="p">{}</span>
    
    
    <span class="c1">#use space craft position to get range of time values</span>
    <span class="c1">#(use_craft)</span>
    
    
    <span class="c1">#use best chisq to find the best time in between spacecraft</span>
    <span class="c1">#(use_chisq)</span>
    
    <span class="c1">#plot chisq min procedure</span>
    <span class="c1">#(plot)</span>
    
    <span class="c1">#refine chisq min with closer time grid</span>
    <span class="c1">#(refine)</span>
    
    <span class="c1">#set use to use all spacecraft</span>
    
    <span class="n">marker</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">color</span>  <span class="o">=</span> <span class="p">{}</span>
    
    
    <span class="c1">#Use five min cadence for rough chi^2 min</span>
    <span class="n">downsamp</span> <span class="o">=</span> <span class="s1">&#39;5T&#39;</span>
    
    
    <span class="c1">#create dictionaries for labels</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">craft</span><span class="p">):</span>
        <span class="n">marker</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mar</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">col</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
    
    <span class="c1">#space craft to use n sigma events to find other events</span>
    <span class="c1">#change craft order to change trainer </span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="n">craft</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    
    <span class="c1">#sigma level to use from wind training</span>
    <span class="n">sig_l</span> <span class="o">=</span> <span class="mf">5.0</span>
    <span class="c1">#use sig_l to create shock prediction variable in dataframes</span>
    <span class="n">p_var</span> <span class="o">=</span> <span class="s1">&#39;predict_shock_</span><span class="si">{0:3.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sig_l</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">m_var</span> <span class="o">=</span> <span class="n">p_var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;predict&#39;</span><span class="p">,</span><span class="s1">&#39;predict_sigma&#39;</span><span class="p">)</span>
    <span class="c1">#fractional p value to call an &quot;event&quot;</span>
    <span class="c1">#(p_val) = 0.950 </span>
    
    <span class="c1">#get strings for times around each event#</span>
    <span class="n">window</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">window</span><span class="p">[</span><span class="s1">&#39;DSCOVR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;40 minutes&#39;</span><span class="p">)</span>
    <span class="n">window</span><span class="p">[</span><span class="s1">&#39;ACE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;40 minutes&#39;</span><span class="p">)</span>
    <span class="n">window</span><span class="p">[</span><span class="s1">&#39;SOHO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;40 minutes&#39;</span><span class="p">)</span>
    <span class="n">window</span><span class="p">[</span><span class="s1">&#39;Wind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;40 minutes&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">use_discon</span><span class="p">:</span>
        <span class="c1">#get strings for times around each event if using donconitinity matching#</span>
        <span class="n">window</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">window</span><span class="p">[</span><span class="s1">&#39;DSCOVR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;90 minutes&#39;</span><span class="p">)</span>
        <span class="n">window</span><span class="p">[</span><span class="s1">&#39;ACE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;90 minutes&#39;</span><span class="p">)</span>
        <span class="n">window</span><span class="p">[</span><span class="s1">&#39;SOHO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;90 minutes&#39;</span><span class="p">)</span>
        <span class="n">window</span><span class="p">[</span><span class="s1">&#39;Wind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;90 minutes&#39;</span><span class="p">)</span>
        
    
    <span class="c1">#define rough chi min time  to cal Chi^2 min for each time</span>
    <span class="c1">#(rgh_chi_t = pd.to_timedelta(&#39;90 minutes&#39;)</span>
    
    <span class="c1">#get strings for times around each event when refining chi^2 time</span>
    <span class="n">ref_window</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#ref_window[&#39;DSCOVR&#39;] = pd.to_timedelta(&#39;15 minutes&#39;)</span>
    <span class="c1">#ref_window[&#39;ACE&#39;] = pd.to_timedelta(&#39;15 minutes&#39;)</span>
    <span class="c1">#ref_window[&#39;SOHO&#39;] = pd.to_timedelta(&#39;25 minutes&#39;)</span>
    <span class="c1">#ref_window[&#39;Wind&#39;] = pd.to_timedelta(&#39;25 minutes&#39;)</span>
    <span class="n">ref_window</span><span class="p">[</span><span class="s1">&#39;DSCOVR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;5 minutes&#39;</span><span class="p">)</span>
    <span class="n">ref_window</span><span class="p">[</span><span class="s1">&#39;ACE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;5 minutes&#39;</span><span class="p">)</span>
    <span class="n">ref_window</span><span class="p">[</span><span class="s1">&#39;SOHO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;5 minutes&#39;</span><span class="p">)</span>
    <span class="n">ref_window</span><span class="p">[</span><span class="s1">&#39;Wind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;5 minutes&#39;</span><span class="p">)</span>
    
    <span class="c1">#refined window to calculate Chi^2 min for each time</span>
    <span class="c1">#(ref_chi_t)</span>
    <span class="c1">#Parameters for file read in and parsing</span>
    <span class="n">par_read_in</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">read_in</span><span class="p">,</span><span class="n">arch</span><span class="o">=</span><span class="n">arch</span><span class="p">,</span><span class="n">mag_fmt</span><span class="o">=</span><span class="n">mag_fmt</span><span class="p">,</span><span class="n">pls_fmt</span><span class="o">=</span><span class="n">pls_fmt</span><span class="p">,</span><span class="n">start_t</span><span class="o">=</span><span class="n">start_t</span><span class="p">,</span><span class="n">end_t</span><span class="o">=</span><span class="n">end_t</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">)</span>
                         


    <span class="c1">#plot window </span>
    <span class="n">plt_windw</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;180 minutes&#39;</span><span class="p">)</span>
    
    <span class="c1">#window around event to get largers parameter jump values</span>
    <span class="c1"># when writing to file</span>
    <span class="n">a_w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;100 seconds&#39;</span><span class="p">)</span>
    
    <span class="c1">#read in and format spacecraft in parallel</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">outp</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">par_read_in</span><span class="p">,</span><span class="n">craft</span><span class="p">)</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="c1">#for k in craft: par_read_in(k)</span>
    
    
    <span class="c1">#create global plasma key</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outp</span><span class="p">:</span>
        <span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">craft</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
    
    
    <span class="c1">#use the trainer space craft to find events</span>
    <span class="n">tr_events</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">trainer</span><span class="p">][</span><span class="n">plsm</span><span class="p">[</span><span class="n">trainer</span><span class="p">][</span><span class="n">p_var</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">p_val</span><span class="p">]</span>
    
    <span class="c1">#Group events by 1 per hour</span>
    <span class="c1">#ctr_events[&#39;str_hour&#39;] = tr_events.time_dt_mag.dt.strftime(&#39;%Y%m%d%H&#39;)</span>
    <span class="c1">#attempting to pick one event at a time J. Prchlik (2017/10/30) (Did not work as 1pm of the same day)</span>
    <span class="c1">#tr_events = tr_events[~tr_events.duplicated([&#39;str_hour&#39;],keep = &#39;first&#39;)]</span>
    <span class="c1">#loop over events and get best probability for event within 1 hour</span>
    <span class="c1">#only do if center == False (2017/12/20 J. Prchlik)</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">center</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">center</span><span class="p">)):</span>
        <span class="n">tr_events</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">tr_events</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tr_events</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">tr_events</span><span class="p">[</span><span class="s1">&#39;t_off&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="n">tr_events</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">tr_events</span><span class="p">[</span><span class="n">tr_events</span><span class="p">[</span><span class="s1">&#39;t_off&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">3600.</span><span class="p">]</span> <span class="c1">#anytime where the offest is less than 1 hour </span>
            <span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1">#use groups to cut out duplicates</span>
        <span class="n">tr_events</span> <span class="o">=</span> <span class="n">tr_events</span><span class="p">[</span><span class="o">~</span><span class="n">tr_events</span><span class="o">.</span><span class="n">duplicated</span><span class="p">([</span><span class="s1">&#39;group&#39;</span><span class="p">],</span><span class="n">keep</span> <span class="o">=</span> <span class="s1">&#39;first&#39;</span><span class="p">)]</span>
    
        <span class="c1">#For an hour around an event find the minimum time to get a precise break point using a 10% lower prob. threshold</span>
        <span class="c1">#search window for the star</span>
        <span class="n">s_wind</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;30 minutes&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tr_events</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
              <span class="n">temp_events</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">trainer</span><span class="p">][</span><span class="n">i</span><span class="o">-</span><span class="n">s_wind</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">s_wind</span><span class="p">][</span><span class="n">plsm</span><span class="p">[</span><span class="n">trainer</span><span class="p">][</span><span class="n">i</span><span class="o">-</span><span class="n">s_wind</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">s_wind</span><span class="p">][</span><span class="n">p_var</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">p_val</span><span class="p">]</span>
              <span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">temp_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">temp_events</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),:]</span>
        
        <span class="c1">#reset index with new plasma time value</span>
        <span class="n">tr_events</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">tr_events</span><span class="o">.</span><span class="n">time_dt_pls</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    
    <span class="c1">#space craft to match with trainer soho</span>
    <span class="n">craft</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">trainer</span><span class="p">)</span>
    
    <span class="c1">#use wind speed to esimate possible time delay</span>
    <span class="n">min_vel</span> <span class="o">=</span> <span class="mf">100.</span> <span class="c1">#km/s</span>
    <span class="n">max_vel</span> <span class="o">=</span> <span class="mf">5000.</span> <span class="c1">#km/s</span>
    <span class="n">Re</span> <span class="o">=</span> <span class="mf">6378.</span> <span class="c1">#Earth radius in km</span>
    
    <span class="c1">#convert ace coordinates into Re</span>
    <span class="c1">#plsm[&#39;ACE&#39;][&#39;X&#39;] = plsm[&#39;ACE&#39;].X/Re</span>
    <span class="c1">#plsm[&#39;ACE&#39;][&#39;Y&#39;] = plsm[&#39;ACE&#39;].Y/Re</span>
    <span class="c1">#plsm[&#39;ACE&#39;][&#39;Z&#39;] = plsm[&#39;ACE&#39;].Z/Re</span>
    
    <span class="c1">#correct normalization of spacecraft wind parameter Vth</span>
    <span class="c1">#Fixed J. Prchlik 2017/11/02</span>
    <span class="c1">##amu = 1.660538921e-27#amu</span>
    <span class="c1">##mp  = 1.00727647*amu</span>
    <span class="c1">##kb  = 1.3906488e-23#boltzmann&#39;s constant</span>
    <span class="c1">##plsm[&#39;wind&#39;][&#39;Vth&#39;]   = (plsm[&#39;wind&#39;].Vth  *1.0e3)**2.*mp/kb/2.</span>
    <span class="c1">##plsm[&#39;ace&#39;][&#39;Vth&#39;]    = (plsm[&#39;ace&#39;].Vth   *1.0e3)**2.*mp/kb/2.</span>
    <span class="c1">##plsm[&#39;dscovr&#39;][&#39;Vth&#39;] = (plsm[&#39;dscovr&#39;].Vth*1.0e3)**2.*mp/kb/2.</span>
    
    
    
    <span class="c1">#set up html output Event heading</span>
    <span class="n">ful_hdr</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                &lt;!DOCTYPE html&gt;</span>
<span class="s1">                &lt;html&gt;</span>
<span class="s1">                &lt;head&gt;</span>
<span class="s1">                &lt;style&gt;</span>
<span class="s1">                table, th, td {</span>
<span class="s1">                    border: 1px solid black;</span>
<span class="s1">                    border-collapse: collapse;</span>
<span class="s1">                }</span>
<span class="s1">                th, td {</span>
<span class="s1">                    padding: 5px;</span>
<span class="s1">                }</span>
<span class="s1">                th {</span>
<span class="s1">                    text-align: left;</span>
<span class="s1">                }</span>
<span class="s1">                &lt;/style&gt;</span>
<span class="s1">                &lt;/head&gt;</span>
<span class="s1">                &lt;body&gt;</span>
<span class="s1">                &#39;&#39;&#39;</span>
    
    <span class="n">par_hdr</span> <span class="o">=</span>   <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                &lt;h1&gt;</span>
<span class="s1">                Finding &amp;chi;&lt;sup&gt;2&lt;/sup&gt; Minimization </span>
<span class="s1">                &lt;/h1&gt;</span>
<span class="s1">                &lt;/br&gt;</span>
<span class="s1">                &lt;/br&gt;</span>
<span class="s1">                &lt;p1&gt;</span>
<span class="s1">                The program for finding the &amp;chi;&lt;sup&gt;2&lt;/sup&gt; minimum for events between spacecraft works by using a primary spacecraft to find events.</span>
<span class="s1">                I selected Wind because I used Wind to train the model, and the events found in Wind are consistent with events found by eye or independent spacecraft </span>
<span class="s1">                algorithms. I define an event discontinuity as a time where our model indicates a </span><span class="si">{0:4.2f}</span><span class="s1">% probability the solar wind parameters corresponds to a 5&amp;sigma;</span>
<span class="s1">                discontinuity in a component of the magnetic field. Then I create a course grid of solar wind speed samples for &amp;plusmn; 40 minutes around a event.</span>
<span class="s1">                Currently, I find </span><span class="si">{1:1d}</span><span class="s1"> events using the Wind spacecraft to define an event. Then I shift </span>
<span class="s1">                the other 3 spacecraft onto the Wind using the course grid. Then I select a 80 minute (&amp;plusmn;40 minutes) window around the shifted Wind and other spacecraft and derive a first order</span>
<span class="s1">                &amp;chi;&lt;sup&gt;2&lt;/sup&gt; minimum. Using the first order &amp;chi;&lt;sup&gt;2&lt;/sup&gt; minimum, I create a fine grid 50 minutes (&amp;plusmn; 25 minutes) around the rough &amp;chi;&lt;sup&gt;2&lt;/sup&gt; minimum</span>
<span class="s1">                time. The fine grid cadence is set to the maximum sampling frequency of a given spacecraft. Then the program stores the &amp;chi;&lt;sup&gt;2&lt;/sup&gt; value for 20 minutes (&amp;plusmn; 10 minutes)</span>
<span class="s1">                around each fine grid point. However, if the first or last point is the &amp;chi;&lt;sup&gt;2&lt;/sup&gt; min. then the program expands the time search window by 20 minutes.</span>
<span class="s1">                The &amp;chi;&lt;sup&gt;2&lt;/sup&gt; reported is the minimum from the time grid.</span>
<span class="s1">                &lt;/p1&gt;</span>
<span class="s1">    </span>
<span class="s1">                &lt;/br&gt;</span>
<span class="s1">                &lt;/br&gt;</span>
<span class="s1">                &lt;h4&gt;</span>
<span class="s1">                Table Summary</span>
<span class="s1">                &lt;/h4&gt;</span>
<span class="s1">                Each table contains a row for each spacecraft with observations in the requested time period. Then each row contains 6 columns. The first column labels the spacecraft for a </span>
<span class="s1">                given row. Then next column (Obs. Time [UT]) gives the time of the &quot;event&quot; in the reference frame of the spacecraft. Offset is the offset in minutes from the Wind observation.</span>
<span class="s1">                P-val (plasma) is the p-val for a 5&amp;sigma; discontinuity at the reference Obs. time for a given spacecraft&#39;s measured plasma values. </span>
<span class="s1">                P-val (mag.) is the p-val for a 5&amp;sigma; discontinuity given at the reference Obs. time for a given spacecraft&#39;s measured magnetic field values.</span>
<span class="s1">                Finally, an X in Use Plasma Mod. means the minimization routine use the wind Speed to find the best match &amp;chi;&lt;sup&gt;2&lt;/sup&gt; time,</span>
<span class="s1">                while an empty cell denotes using the magnetic field. Clicking on the spacecraft shows the &amp;chi;&lt;sup&gt;2&lt;/sup&gt; minimization as a function of time for </span>
<span class="s1">                the wide and refined windows.</span>
<span class="s1">        </span>
<span class="s1">                &lt;/br&gt;</span>
<span class="s1">                &lt;/br&gt;</span>
<span class="s1">    </span>
<span class="s1">                &#39;&#39;&#39;</span>
    
    <span class="n">tab_hdr</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    </span>
<span class="s1">               &lt;table style=&quot;width=100%&quot;&gt;</span>
<span class="s1">                  &lt;tr&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      Spacecraft</span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      Obs. Time [UT]</span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      Offset [min]</span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      Pos. Unc. [s]</span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      Neg. Unc. [s]</span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      p-val (plasma) </span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      p-val (mag.) </span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      Used Plasma Mod.</span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      &amp;delta;SPEED [km/s]</span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      &amp;delta;Np [cm&lt;sup&gt;-3&lt;/sup&gt;]</span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      &amp;delta;Vth [km/s]</span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      &amp;delta;Bx [nT]</span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      &amp;delta;By [nT]</span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      &amp;delta;Bz [nT]</span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      &amp;delta;GSE_X [km]</span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      &amp;delta;GSE_Y [km]</span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      &amp;delta;GSE_Z [km]</span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                  &lt;/tr&gt;</span>
<span class="s1">                      &#39;&#39;&#39;</span>
    
    <span class="c1">#data format for new row</span>
    <span class="n">new_row</span> <span class="o">=</span>   <span class="s1">&#39;&#39;&#39;&lt;tr&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      &lt;a href=&quot;../plots/spacecraft_events/chisq/chi_min_{8:%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S}_</span><span class="si">{9}</span><span class="s1">.png&quot;&gt;</span><span class="si">{0}</span><span class="s1">&lt;/a&gt;</span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      {1:%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S}</span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      </span><span class="si">{2:5.2f}</span><span class="s1"></span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      </span><span class="si">{3:5.2f}</span><span class="s1"></span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      </span><span class="si">{4:5.2f}</span><span class="s1"></span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      </span><span class="si">{5:4.3f}</span><span class="s1"></span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      </span><span class="si">{6:4.3f}</span><span class="s1"></span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      </span><span class="si">{7}</span><span class="s1"></span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      </span><span class="si">{10:4.3f}</span><span class="s1"></span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      </span><span class="si">{11:4.3f}</span><span class="s1"></span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      </span><span class="si">{12:4.3f}</span><span class="s1"></span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      </span><span class="si">{13:4.3f}</span><span class="s1"></span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      </span><span class="si">{14:4.3f}</span><span class="s1"></span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      </span><span class="si">{15:4.3f}</span><span class="s1"></span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      </span><span class="si">{16:8.1f}</span><span class="s1"></span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      </span><span class="si">{17:8.1f}</span><span class="s1"></span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                      &lt;td&gt;</span>
<span class="s1">                      </span><span class="si">{18:8.1f}</span><span class="s1"></span>
<span class="s1">                      &lt;/td&gt;</span>
<span class="s1">                  &lt;/tr&gt;&#39;&#39;&#39;</span>
    <span class="n">footer</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;&lt;/table&gt;</span>
<span class="s1">    </span>
<span class="s1">             &lt;/br&gt;</span>
<span class="s1">             &lt;/br&gt;</span>
<span class="s1">             &lt;/br&gt;</span>
<span class="s1">    </span>
<span class="s1">    </span>
<span class="s1">             &#39;&#39;&#39;</span>
    <span class="n">ful_ftr</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                &lt;/body&gt;</span>
<span class="s1">                &lt;/html&gt;&#39;&#39;&#39;</span>
    
    
    <span class="c1">#Additional output parameters</span>
    <span class="n">par_out</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;diff_med_speed&#39;</span><span class="p">,</span> <span class="s1">&#39;diff_med_Np&#39;</span><span class="p">,</span> <span class="s1">&#39;diff_med_Vth&#39;</span><span class="p">,</span> <span class="s1">&#39;diff_med_Bx&#39;</span><span class="p">,</span> <span class="s1">&#39;diff_med_By&#39;</span><span class="p">,</span> <span class="s1">&#39;diff_med_Bz&#39;</span><span class="p">]</span>
    

    <span class="c1">#Add columns to tr_events dataframe</span>
    <span class="n">output_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_time&#39;</span><span class="p">,</span><span class="s1">&#39;_unc&#39;</span><span class="p">,</span><span class="s1">&#39;_GSE_X&#39;</span><span class="p">,</span><span class="s1">&#39;_GSE_Y&#39;</span><span class="p">,</span><span class="s1">&#39;_GSE_Z&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">output_col</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">craft</span><span class="p">:</span>
            <span class="n">tr_events</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
   
    
    <span class="c1"># write header for html page</span>
    <span class="n">out_f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;../html_files/</span><span class="si">{0}</span><span class="s1">_level_</span><span class="si">{1:4.0f}</span><span class="s1">_full_res.html&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trainer</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="n">p_val</span><span class="o">*</span><span class="mf">1000.</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;0&#39;</span><span class="p">),</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">out_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ful_hdr</span><span class="o">+</span><span class="n">par_hdr</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p_val</span><span class="o">*</span><span class="mf">100.</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">tr_events</span><span class="p">)))</span>
    
    
    <span class="c1">#get event slices </span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tr_events</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="c1">#print processing time</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;########################################&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;NEW EVENT&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">trainer</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;{0:%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S}, p (plasma)=</span><span class="si">{1:4.3f}</span><span class="s1">, p (mag.) = </span><span class="si">{2:4.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">p_var</span><span class="p">],</span><span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">p_var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;predict&#39;</span><span class="p">,</span><span class="s1">&#39;predict_sigma&#39;</span><span class="p">)]))</span>
        <span class="c1">#get time slice around event</span>
       
        <span class="c1">#create table to output html table and link to github png files (https://cdn.rawgit.com/jprchlik/solar_wind_jets/4cf1c6e7)</span>
        <span class="n">out_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&#39;&#39;&lt;b&gt;&lt;a href=&quot;../plots/spacecraft_events/full_res_event_{0:%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S}_bigg.png&quot;&gt; Event on {0:%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S} UT (6 Hour)&lt;/a&gt; &lt;/b&gt;     &#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">out_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&#39;&#39;&lt;b&gt;&lt;a href=&quot;../plots/spacecraft_events/full_res_event_{0:%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S}_zoom.png&quot;&gt; Event on {0:%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S} UT (50 Min.)&lt;/a&gt; &lt;/b&gt;&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">out_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;&#39;&#39;&lt;b&gt;&lt;a href=&quot;../plots/spacecraft_events/event_orientation_{0:%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S}_bigg.png&quot;&gt; Orientation on {0:%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S} UT &lt;/a&gt; &lt;/b&gt;&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

        <span class="n">out_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tab_hdr</span><span class="p">)</span>
        <span class="c1">#write trainer spacecraft event</span>
        <span class="n">out_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_row</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">trainer</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mf">0.00</span><span class="p">,</span><span class="mf">0.00</span><span class="p">,</span><span class="mf">0.00</span><span class="p">,</span><span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">p_var</span><span class="p">],</span><span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">a_w</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">a_w</span><span class="p">,</span><span class="n">p_var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;predict&#39;</span><span class="p">,</span><span class="s1">&#39;predict_sigma&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">trainer</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="o">*</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">trainer</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">a_w</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">a_w</span><span class="p">,</span><span class="n">par_out</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">+</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])))</span>
    
    
        <span class="c1">#create figure showing  solar wind</span>
        <span class="n">bfig</span><span class="p">,</span> <span class="n">fax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">18</span><span class="p">))</span>
        <span class="n">bfig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>
        <span class="n">bfig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Event on {0:%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S} UT&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

        <span class="c1">#Create figure showing space craft orientation</span>
        <span class="n">ofig</span><span class="p">,</span> <span class="n">oax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;height_ratios&#39;</span><span class="p">:[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;width_ratios&#39;</span><span class="p">:[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]},</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">18</span><span class="p">))</span>
        <span class="c1">#turn off bottom right axis</span>
        <span class="c1">#coax[1,1].axis(&#39;off&#39;)</span>
 
        <span class="c1">#set color max for timing differences</span>
        <span class="n">v_max</span> <span class="o">=</span>  <span class="mf">40.</span>
        <span class="n">v_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">40.</span>

    
    
        <span class="c1">#loop over all other space craft</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">craft</span><span class="p">:</span>
    
    
            <span class="c1">#initial time slice to get the approximate spacecraft differences</span>
            <span class="n">init_slice</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">window</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">i</span><span class="o">+</span><span class="n">window</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> 
            <span class="n">p_mat</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">init_slice</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">init_slice</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> 
    
    
    
            <span class="c1">#print current spacecraft</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="c1">#use spacecraft position to get solar wind times for matching</span>
            <span class="k">if</span> <span class="n">use_craft</span><span class="p">:</span>
      
                <span class="c1">#find the median distance</span>
                <span class="c1">#med_dis = np.median(np.sqrt((p_mat.X-i.X)**2.+(p_mat.Y-i.Y)**2.+(p_mat.Z-i.Z)**2.))</span>
                <span class="c1">#Just use X distance since most of wind is in that direction</span>
                <span class="c1">#towards the sun is positive X (GSE)</span>
                <span class="c1">#use negative sign to change to increasing away from the sun</span>
                <span class="n">med_dis_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">X</span><span class="o">-</span><span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                <span class="n">med_dis_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">Y</span><span class="o">-</span><span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                <span class="n">med_dis_z</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">Z</span><span class="o">-</span><span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    
    
                <span class="c1">#convert the median distance into a time delay (distances in Re)</span>
                <span class="k">if</span> <span class="n">med_dis</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">max_del</span> <span class="o">=</span> <span class="n">med_dis</span><span class="o">*</span><span class="n">Re</span><span class="o">/</span><span class="n">min_vel</span>
                    <span class="n">min_del</span> <span class="o">=</span> <span class="n">med_dis</span><span class="o">*</span><span class="n">Re</span><span class="o">/</span><span class="n">max_vel</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">min_del</span> <span class="o">=</span> <span class="n">med_dis</span><span class="o">*</span><span class="n">Re</span><span class="o">/</span><span class="n">min_vel</span>
                    <span class="n">max_del</span> <span class="o">=</span> <span class="n">med_dis</span><span class="o">*</span><span class="n">Re</span><span class="o">/</span><span class="n">max_vel</span>
                
    
                <span class="c1">#convert to pandas time delta window</span>
                <span class="n">cal_wd</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">([</span><span class="n">min_del</span><span class="p">,</span><span class="n">max_del</span><span class="p">],</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
         
                <span class="c1">#get a time slice base on space craft differences</span>
                <span class="n">time_slice</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">cal_wd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="o">+</span><span class="n">cal_wd</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> 
                <span class="k">if</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                   <span class="c1">#get the index of the maximum value</span>
                   <span class="n">i_max</span> <span class="o">=</span> <span class="n">p_mat</span><span class="p">[</span><span class="n">p_var</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span> 
                   <span class="c1">#print(&#39;{2:%Y/%m/%d %H:%M:%S},{0:5.2f} min., p_max={1:4.3f}&#39;.format((i_max-i).total_seconds()/60.,p_mat.loc[i_max][p_var],i_max))</span>
                <span class="k">else</span><span class="p">:</span>
                   <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Plasma Observations&#39;</span><span class="p">)</span>
      
            <span class="c1">#elif use_chisq:</span>
         
            <span class="c1">#use the largets set of discontinuties </span>
            <span class="k">elif</span> <span class="p">((</span><span class="n">use_discon</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">use_chisq</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">use_dtw</span><span class="p">)):</span>
                <span class="c1">#parameters if using discontinuity</span>
                <span class="k">if</span> <span class="n">use_discon</span><span class="p">:</span>
                     <span class="c1">#calculate difference in parameters</span>
                     <span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;del_speed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                     <span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;del_Np&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                     <span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;del_Vth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                     <span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;del_Bx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                     <span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;del_By&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                     <span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;del_Bz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

                     <span class="c1">#find largest magnetic field discontinuties </span>
                     <span class="n">p_mat</span><span class="p">[</span><span class="s1">&#39;del_Bt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">del_Bx</span><span class="o">**</span><span class="mf">2.</span><span class="o">+</span><span class="n">p_mat</span><span class="o">.</span><span class="n">del_By</span><span class="o">**</span><span class="mf">2.</span><span class="o">+</span><span class="n">p_mat</span><span class="o">.</span><span class="n">del_Bz</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span> 

                     <span class="c1">#find largest speed discontinuties </span>
                     <span class="n">p_mat_t</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;del_speed&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>

             
                     <span class="c1">#find largest mag field discontinuies </span>
                     <span class="n">p_mag_t</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;del_Bt&#39;</span><span class="p">,</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]</span>
    
                     <span class="c1">#mag tolerance for using magnetometer data to match events rather than plasma parameters</span>
                     <span class="n">mag_tol</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="c1">#use chisq minimum of top events in 2 hour window</span>
                <span class="k">elif</span> <span class="p">((</span><span class="n">use_chisq</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">use_dtw</span><span class="p">)):</span>
                    <span class="c1">#downsample to 5 minutes for time matching in chisq</span>
                    <span class="c1">#remove downsampling J. Prchlik 2017/11/20</span>
                    <span class="n">p_mat_t</span> <span class="o">=</span> <span class="n">p_mat</span> <span class="c1">#.resample(downsamp).median()</span>
                    <span class="c1">#p_mat_t = p_mat.sort_values(p_var,ascending=False)[:40]</span>
                    <span class="c1">#p_mat_t = p_mat[p_var].idxmax()</span>
    
                    <span class="c1">#downsample mag to 5 minutes for time matching in chisq</span>
                    <span class="c1">#p_mag_t = p_mat.sort_values(m_var,ascending=False)[:40]</span>
                    <span class="c1">#p_mat_t = p_mat[p_var].idxmax()</span>
                    <span class="n">p_mag_t</span> <span class="o">=</span> <span class="n">p_mat_t</span>
    
                    <span class="c1">#mag tolerance for using magnetometer data to match events rather than plasma parameters</span>
                    <span class="n">mag_tol</span> <span class="o">=</span> <span class="mf">0.0</span>
               

                

                <span class="c1">#temporary plasma array to use for X^2 matching</span>
                <span class="c1">#smaller pandas dataframe chunks allows for more efficient event finding and time offsets.</span>
                <span class="n">t_plsm</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">half_day</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;9 hours&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="n">plsm</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="n">t_plsm</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">half_day</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">half_day</span><span class="p">]</span>
    

                <span class="c1">#when to use plasma parameters for matching    </span>
                <span class="k">if</span> <span class="p">(((</span><span class="n">p_mat_t</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">p_mat_t</span><span class="p">[</span><span class="n">p_var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">mag_tol</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;soho&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">p_mat_t</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">))):</span>
                <span class="c1">#if ((k.lower() == &#39;soho&#39;) &amp; (p_mat_t.size &gt; 0.)):</span>
    
                    <span class="c1">#set up logic for dyanmic time warping minimum</span>
                    <span class="k">if</span> <span class="n">use_dtw</span><span class="p">:</span>
                        <span class="n">i_min</span><span class="p">,</span><span class="n">i_upp</span><span class="p">,</span><span class="n">i_low</span> <span class="o">=</span> <span class="n">dtw_min</span><span class="p">(</span><span class="n">p_mat_t</span><span class="p">,[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">],</span><span class="n">rgh_chi_t</span><span class="p">,</span><span class="n">t_plsm</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">window</span><span class="p">,</span><span class="n">ref_window</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">color</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span><span class="n">ref_chi_t</span><span class="o">=</span><span class="n">ref_chi_t</span><span class="p">,</span>
                                        <span class="n">refine</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span><span class="n">n_fine</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span><span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span><span class="n">use_discon</span><span class="o">=</span><span class="n">use_discon</span><span class="p">)</span>
                    <span class="c1">#else use chi^2 procedures</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i_min</span><span class="p">,</span><span class="n">i_upp</span><span class="p">,</span><span class="n">i_low</span> <span class="o">=</span> <span class="n">chi_min</span><span class="p">(</span><span class="n">p_mat_t</span><span class="p">,[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">],</span><span class="n">rgh_chi_t</span><span class="p">,</span><span class="n">t_plsm</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">window</span><span class="p">,</span><span class="n">ref_window</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">color</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span><span class="n">ref_chi_t</span><span class="o">=</span><span class="n">ref_chi_t</span><span class="p">,</span>
                                        <span class="n">refine</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span><span class="n">n_fine</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span><span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span><span class="n">use_discon</span><span class="o">=</span><span class="n">use_discon</span><span class="p">)</span>
                    <span class="c1">#use full array for index matching</span>
                    <span class="n">p_mat</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    
                    <span class="k">try</span><span class="p">:</span>
     
                        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;soho&#39;</span><span class="p">:</span>
                            <span class="c1">#print(&#39;{2:%Y/%m/%d %H:%M:%S},{0:5.2f} min., p_max (plsm) ={1:4.3f}&#39;.format((i_min-i).total_seconds()/60.,p_mat.loc[i_min][p_var],i_min))</span>
                            <span class="n">out_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_row</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">i_min</span><span class="p">,(</span><span class="n">i_min</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">60.</span><span class="p">,(</span><span class="n">i_upp</span><span class="o">-</span><span class="n">i_min</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),(</span><span class="n">i_low</span><span class="o">-</span><span class="n">i_min</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span>
                                        <span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="o">-</span><span class="n">a_w</span><span class="p">:</span><span class="n">i_min</span><span class="o">+</span><span class="n">a_w</span><span class="p">][</span><span class="n">p_var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="mf">0.000</span><span class="p">,</span><span class="s1">&#39;X&#39;</span><span class="p">,</span>
                                        <span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="o">*</span><span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="o">-</span><span class="n">a_w</span><span class="p">:</span><span class="n">i_min</span><span class="o">+</span><span class="n">a_w</span><span class="p">,</span><span class="n">par_out</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">+</span>
                                        <span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,[</span><span class="s1">&#39;GSEx&#39;</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">]]</span><span class="o">-</span><span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,[</span><span class="s1">&#39;GSEx&#39;</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())))</span>
    
                        <span class="k">else</span><span class="p">:</span> 
                            <span class="c1">#print(&#39;{2:%Y/%m/%d %H:%M:%S},{0:5.2f} min., p_max (plsm) ={1:4.3f}, p_max (mag) = {3:4.3f}&#39;.format((i_min-i).total_seconds()/60.,p_mat.loc[i_min][p_var],i_min,p_mat.loc[i_min][p_var.replace(&#39;predict&#39;,&#39;predict_sigma&#39;)]))</span>
                            <span class="n">out_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_row</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">i_min</span><span class="p">,(</span><span class="n">i_min</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">60.</span><span class="p">,(</span><span class="n">i_upp</span><span class="o">-</span><span class="n">i_min</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),(</span><span class="n">i_low</span><span class="o">-</span><span class="n">i_min</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="o">-</span><span class="n">a_w</span><span class="p">:</span><span class="n">i_min</span><span class="o">+</span><span class="n">a_w</span><span class="p">][</span><span class="n">p_var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
                                        <span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="o">-</span><span class="n">a_w</span><span class="p">:</span><span class="n">i_min</span><span class="o">+</span><span class="n">a_w</span><span class="p">][</span><span class="n">p_var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;predict&#39;</span><span class="p">,</span><span class="s1">&#39;predict_sigma&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="s1">&#39;X&#39;</span><span class="p">,</span>
                                        <span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="o">*</span><span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="o">-</span><span class="n">a_w</span><span class="p">:</span><span class="n">i_min</span><span class="o">+</span><span class="n">a_w</span><span class="p">,</span><span class="n">par_out</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">+</span>
                                        <span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,[</span><span class="s1">&#39;GSEx&#39;</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">]]</span><span class="o">-</span><span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,[</span><span class="s1">&#39;GSEx&#39;</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">())))</span>
    
                    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span><span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing Index&#39;</span><span class="p">)</span>
    
    
                <span class="c1">#else no plasma observations                                                                                                                                                      </span>
                <span class="k">elif</span> <span class="p">(((</span><span class="n">p_mat_t</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">p_mat_t</span><span class="p">[</span><span class="n">p_var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">mag_tol</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">p_mat_t</span><span class="p">[</span><span class="n">p_var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">p_mag_t</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;soho&#39;</span><span class="p">)):</span>
                <span class="c1">#elif ((p_mag_t.size &gt; 0.) &amp; (k.lower() != &#39;soho&#39;)):</span>
                    <span class="c1">#sort the cut window and get the top 10 events</span>
                    <span class="n">p_mat_t</span> <span class="o">=</span> <span class="n">p_mag_t</span>
           
                    <span class="c1">#set up logic for dyanmic time warping minimum</span>
                    <span class="k">if</span> <span class="n">use_dtw</span><span class="p">:</span>
                        <span class="n">i_min</span><span class="p">,</span><span class="n">i_upp</span><span class="p">,</span><span class="n">i_low</span> <span class="o">=</span> <span class="n">dtw_min</span><span class="p">(</span><span class="n">p_mat_t</span><span class="p">,[</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">],</span><span class="n">rgh_chi_t</span><span class="p">,</span><span class="n">t_plsm</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">window</span><span class="p">,</span><span class="n">ref_window</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">color</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span><span class="n">ref_chi_t</span><span class="o">=</span><span class="n">ref_chi_t</span><span class="p">,</span>
                                        <span class="n">refine</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span><span class="n">n_fine</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span><span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span><span class="n">use_discon</span><span class="o">=</span><span class="n">use_discon</span><span class="p">)</span>
                    <span class="c1">#else use chi^2 procedures</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">i_min</span><span class="p">,</span><span class="n">i_upp</span><span class="p">,</span><span class="n">i_low</span> <span class="o">=</span> <span class="n">chi_min</span><span class="p">(</span><span class="n">p_mat_t</span><span class="p">,[</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">],</span><span class="n">rgh_chi_t</span><span class="p">,</span><span class="n">t_plsm</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">window</span><span class="p">,</span><span class="n">ref_window</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">color</span><span class="p">,</span><span class="n">marker</span><span class="p">,</span>
                                        <span class="n">ref_chi_t</span><span class="o">=</span><span class="n">ref_chi_t</span><span class="p">,</span><span class="n">refine</span><span class="o">=</span><span class="n">refine</span><span class="p">,</span><span class="n">n_fine</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">,</span><span class="n">nproc</span><span class="o">=</span><span class="n">nproc</span><span class="p">,</span><span class="n">use_discon</span><span class="o">=</span><span class="n">use_discon</span><span class="p">)</span>
    
                    <span class="c1">#use full array for index matching</span>
                    <span class="n">p_mat</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                    <span class="c1">#print output to terminal</span>
                       <span class="c1"># print(&#39;{2:%Y/%m/%d %H:%M:%S},{0:5.2f} min., p_max (plsm) ={1:4.3f}, p_max (mag) = {3:4.3f}&#39;.format((i_min-i).total_seconds()/60.,p_mat.loc[i_min][p_var],i_min,p_mat.loc[i_min][p_var.replace(&#39;predict&#39;,&#39;predict_sigma&#39;)]))</span>
                        <span class="n">out_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_row</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">i_min</span><span class="p">,(</span><span class="n">i_min</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">60.</span><span class="p">,(</span><span class="n">i_upp</span><span class="o">-</span><span class="n">i_min</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),(</span><span class="n">i_low</span><span class="o">-</span><span class="n">i_min</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="o">-</span><span class="n">a_w</span><span class="p">:</span><span class="n">i_min</span><span class="o">+</span><span class="n">a_w</span><span class="p">][</span><span class="n">p_var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="o">-</span><span class="n">a_w</span><span class="p">:</span><span class="n">i_min</span><span class="o">+</span><span class="n">a_w</span><span class="p">][</span><span class="n">p_var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;predict&#39;</span><span class="p">,</span><span class="s1">&#39;predict_sigma&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span><span class="o">*</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="o">-</span><span class="n">a_w</span><span class="p">:</span><span class="n">i_min</span><span class="o">+</span><span class="n">a_w</span><span class="p">,</span><span class="n">par_out</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
    
    
                    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span><span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Missing Index&#39;</span><span class="p">)</span>
           
                <span class="k">else</span><span class="p">:</span>
                   <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Plasma or Mag. Observations&#39;</span><span class="p">)</span>
                   <span class="c1">#Insert fill values for event if event fails</span>
                   <span class="k">continue</span>

            <span class="c1">#Add Times and +/- 40 Minute into event Pandas data frame</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,[</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_time&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_unc&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_GSE_X&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_GSE_Y&#39;</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_GSE_Z&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i_min</span><span class="p">,(</span><span class="n">i_upp</span><span class="o">-</span><span class="n">i_min</span><span class="p">),</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;GSEx&#39;</span><span class="p">],</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">],</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">]]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span><span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
               <span class="k">continue</span>


            <span class="c1">#Plot GSE cooridinates</span>
            <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;GSEx&#39;</span><span class="p">],</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="p">(</span><span class="n">i_min</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">60.</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">v_min</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">v_max</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
            <span class="n">oax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;GSEx&#39;</span><span class="p">],</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="p">(</span><span class="n">i_min</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">60.</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">v_min</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">v_max</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">],</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="p">(</span><span class="n">i_min</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">60.</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">v_min</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">v_max</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="c1">#Out put minute offset to text</span>
            <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;GSEx&#39;</span><span class="p">],</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">{0:3.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">i_min</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">60.</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
            <span class="n">oax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;GSEx&#39;</span><span class="p">],</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">{0:3.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">i_min</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">60.</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
            <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">],</span><span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i_min</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">],</span><span class="s1">&#39;</span><span class="si">{0:3.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">i_min</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">60.</span><span class="p">),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>

            

            <span class="c1">#get a region around one of the best fit times</span>
            <span class="n">plt_slice</span> <span class="o">=</span> <span class="p">[</span><span class="n">i_min</span><span class="o">-</span><span class="n">plt_windw</span><span class="p">,</span><span class="n">i_min</span><span class="o">+</span><span class="n">plt_windw</span><span class="p">]</span>
            <span class="n">b_mat</span> <span class="o">=</span> <span class="n">t_plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">plt_slice</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">plt_slice</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            
            <span class="c1">#update the time index of the match array for comparision with training spacecraft (i=training spacecraft time)</span>
            <span class="n">b_mat</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">b_mat</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">i_min</span><span class="p">)</span>
    
            <span class="c1">#plot plasma parameters</span>

            <span class="c1">#get a region around one of the best fit times</span>
            <span class="n">plt_slice</span> <span class="o">=</span> <span class="p">[</span><span class="n">i_min</span><span class="o">-</span><span class="n">plt_windw</span><span class="p">,</span><span class="n">i_min</span><span class="o">+</span><span class="n">plt_windw</span><span class="p">]</span>
            <span class="n">b_mat</span> <span class="o">=</span> <span class="n">t_plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">plt_slice</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">plt_slice</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            
            <span class="c1">#update the time index of the match array for comparision with training spacecraft (i=training spacecraft time)</span>
            <span class="n">b_mat</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">b_mat</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">i_min</span><span class="p">)</span>
    
            <span class="c1">#plot plasma parameters</span>
            <span class="c1">#fax[0,0].scatter(b_mat[b_mat[&#39;Np&#39;   ] &gt; -9990.0].index,b_mat[b_mat[&#39;Np&#39;   ] &gt; -9990.0].Np   ,marker=marker[k],color=color[k],label=k.upper())         </span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Np</span>   <span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>         
                <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Np</span>   <span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>         
    
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Vth</span>  <span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>         
                <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Vth</span>  <span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>         
    
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>         
                <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>         
    
    
            <span class="c1">#plot mag. parameters</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;soho&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bx</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>         
                    <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bx</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>         
    
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">By</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>         
                    <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">By</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>         
    
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bz</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>         
                    <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bz</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>         
    
            <span class="c1">#print separater </span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;########################################&#39;</span><span class="p">)</span>
        
        <span class="c1">#print end comupation time per event</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Process time for Event </span><span class="si">%s</span><span class="s2"> seconds ---&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span>
      
        <span class="c1">#get training spacecraft time range</span>
        <span class="n">plt_slice</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">plt_windw</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="n">plt_windw</span><span class="p">]</span>
        <span class="n">t_mat</span> <span class="o">=</span> <span class="n">t_plsm</span><span class="p">[</span><span class="n">trainer</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">plt_slice</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">plt_slice</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    
        <span class="c1">#Plot GSE cooridinates for trainer spacecraft</span>
        <span class="n">plotc</span> <span class="o">=</span> <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;GSEx&#39;</span><span class="p">],</span><span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">v_min</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">v_max</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">trainer</span><span class="p">)</span>
        <span class="n">oax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;GSEx&#39;</span><span class="p">],</span><span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">v_min</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">v_max</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">],</span><span class="n">tr_events</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="n">v_min</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="n">v_max</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                                                                                                                                           

        <span class="c1">#add colorbar</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">ofig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">plotc</span><span class="p">,</span><span class="n">cax</span><span class="o">=</span><span class="n">oax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Time Offset [min]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    
    
        <span class="c1">#plot plasma parameters</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Np</span>   <span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>         
            <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Np</span>   <span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>         
    
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Vth</span>  <span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">trainer</span><span class="p">)</span>         
            <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Vth</span>  <span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>         
    
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">])</span>         
            <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>         
    
    
        <span class="c1">#plot mag. parameters</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bx</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">])</span>         
            <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bx</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>         
    
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">By</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">])</span>         
            <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">By</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>         
    
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bz</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">])</span>         
            <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bz</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>         
    
    
    
        <span class="c1">#plot observed break time</span>
        <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">fax</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
            <span class="n">xoff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;90 seconds&#39;</span><span class="p">)</span>  
            <span class="n">pax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
            <span class="n">pax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">xoff</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
            <span class="n">pax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">xoff</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;purple&#39;</span><span class="p">)</span>
           
        <span class="c1">#plot best time for each spacecraft</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scatterpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1">#put legend on X,Z plot</span>
        <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scatterpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
        <span class="c1">#plot an hour around observation</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">i</span><span class="o">-</span><span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;25 minutes&#39;</span><span class="p">),</span><span class="n">i</span><span class="o">+</span><span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;25 minutes&#39;</span><span class="p">)])</span>
      
        <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Np [cm$^{-3}$]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Th. Speed [km/s]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flow Speed [km/s]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [UTC]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    
        <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Bx [nT]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;By [nT]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Bz [nT]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [UTC]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    
        <span class="c1">#set orientation lables</span>
        <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X(GSE) [km]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Z(GSE) [km]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Y(GSE) [km]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Z(GSE) [km]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">oax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X(GSE) [km]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">oax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y(GSE) [km]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

        <span class="c1">#make fancy plot</span>
        <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">fax</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span> <span class="n">fancy_plot</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">oax</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span> <span class="n">fancy_plot</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>
        <span class="c1">#ax.set_ylim([300,1000.])</span>
        <span class="n">bfig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;../plots/spacecraft_events/full_res_event_{0:%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S}_zoom.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()),</span><span class="n">bbox_pad</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    
        <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">i</span><span class="o">-</span><span class="n">plt_windw</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="n">plt_windw</span><span class="p">])</span>
        <span class="n">bfig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;../plots/spacecraft_events/full_res_event_{0:%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S}_bigg.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()),</span><span class="n">bbox_pad</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

        <span class="c1">#Save spacecraft orientation plots</span>
        <span class="n">ofig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;../plots/spacecraft_events/event_orientation_{0:%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S}_bigg.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()),</span><span class="n">bbox_pad</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    
        <span class="c1">#close output file</span>
        <span class="n">out_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">footer</span><span class="p">)</span>

        <span class="c1">#close opened plots</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">bfig</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">ofig</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="c1">#write footer and close file</span>
    
    <span class="n">out_f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ful_ftr</span><span class="p">)</span>
    <span class="n">out_f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


    <span class="c1">#Write out tr_events dataframe</span>
    <span class="n">tr_events</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">&#39;../output_data/space_craft_events_{0:%Y%m</span><span class="si">%d</span><span class="s1">_%H%M}.txt&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39; &#39;</span><span class="p">))</span></div>



</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Jakub Prchlik

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXXXX-1', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>