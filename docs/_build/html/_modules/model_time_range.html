

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>model_time_range &mdash; Solar Wind Matching 0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../',
              VERSION:'0.1',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="../index.html" class="icon icon-home"> Solar Wind Matching
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Solar Wind Matching</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>model_time_range</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for model_time_range</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.inset_locator</span> <span class="k">import</span> <span class="n">inset_axes</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="k">import</span> <span class="n">Axes3D</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="k">import</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="k">import</span> <span class="n">PatchCollection</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">cycle</span>
<span class="kn">from</span> <span class="nn">spacepy</span> <span class="k">import</span> <span class="n">pycdf</span>
<span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mdates</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">fancy_plot</span> <span class="k">import</span> <span class="n">fancy_plot</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">multi_dtw</span> <span class="k">as</span> <span class="nn">md</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">mlpy</span> <span class="c1">#for dynamic time warping </span>
<span class="kn">from</span> <span class="nn">dtaidistance</span> <span class="k">import</span> <span class="n">dtw</span> <span class="c1">#try new dynamic time warping function that creates penalty for compression</span>
<span class="kn">import</span> <span class="nn">load_cdf_files</span> <span class="k">as</span> <span class="nn">lcf</span> <span class="c1">#reading cdfs to pandas arrays</span>


<span class="kn">from</span> <span class="nn">scipy.stats.mstats</span> <span class="k">import</span> <span class="n">theilslopes</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span>


<span class="c1">#Defination of a plane</span>
<div class="viewcode-block" id="plane_func"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.plane_func">[docs]</a><span class="k">def</span> <span class="nf">plane_func</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">y</span><span class="o">+</span><span class="n">c</span><span class="o">*</span><span class="n">z</span><span class="o">+</span><span class="n">d</span></div>


<div class="viewcode-block" id="solve_plane"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.solve_plane">[docs]</a><span class="k">def</span> <span class="nf">solve_plane</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">t</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Velocity plane for given time and position of spacecraft</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    ---------</span>
<span class="sd">    p: np.array or np.matrix</span>
<span class="sd">        Position vectors in x,y,z for three spacecraft with respect to wind</span>
<span class="sd">        The First row is the X,Y,Z values for spacecraft 1</span>
<span class="sd">        The Second row is the X,Y,Z values for spacecraft 2</span>
<span class="sd">        The Thrid row is the X,Y,Z values for spacecraft 3</span>
<span class="sd">    t: np.array or np.matrix</span>
<span class="sd">        Time offset array from Wind for three spacecraft</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vna</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="c1">#solve for the velocity vectors normal</span>
    <span class="n">vn</span>  <span class="o">=</span> <span class="n">vna</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vna</span><span class="p">)</span>
    <span class="n">vm</span>  <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vna</span><span class="p">)</span> <span class="c1">#get velocity magnitude</span>
    <span class="k">return</span> <span class="n">vna</span><span class="p">,</span><span class="n">vn</span><span class="p">,</span><span class="n">vm</span></div>


<div class="viewcode-block" id="solve_plane_cadence"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.solve_plane_cadence">[docs]</a><span class="k">def</span> <span class="nf">solve_plane_cadence</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Velocity plane for given time and position of spacecraft</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    ---------</span>
<span class="sd">    p: np.array or np.matrix</span>
<span class="sd">        Position vectors in x,y,z for three spacecraft with respect to wind</span>
<span class="sd">        The First row is the X,Y,Z values for spacecraft 1</span>
<span class="sd">        The Second row is the X,Y,Z values for spacecraft 2</span>
<span class="sd">        The Thrid row is the X,Y,Z values for spacecraft 3</span>
<span class="sd">    t: np.array or np.matrix</span>
<span class="sd">        Time offset array from Wind for three spacecraft</span>
<span class="sd">    dt: np.array or np.matrix</span>
<span class="sd">        The limiting time cadence for each observation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vna</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">t</span><span class="p">)</span> <span class="c1">#solve for the velocity vectors normal</span>
    <span class="n">vn</span>  <span class="o">=</span> <span class="n">vna</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vna</span><span class="p">)</span>
    <span class="n">vm</span>  <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vna</span><span class="p">)</span> <span class="c1">#get velocity magnitude</span>
    <span class="k">return</span> <span class="n">vna</span><span class="p">,</span><span class="n">vn</span><span class="p">,</span><span class="n">vm</span></div>

<div class="viewcode-block" id="solve_coeff"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.solve_coeff">[docs]</a><span class="k">def</span> <span class="nf">solve_coeff</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span><span class="n">vn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plane coefficients for given time and position of spacecraft</span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">    ----------</span>
<span class="sd">    pi: np.array or np.matrix</span>
<span class="sd">        Position of earth spacecraft in GSE corrected for time offsets</span>
<span class="sd">        The First row is the X,Y,Z values for spacecraft 1</span>
<span class="sd">        The Second row is the X,Y,Z values for spacecraft 2</span>
<span class="sd">        The Thrid row is the X,Y,Z values for spacecraft 3</span>
<span class="sd">    vn: np.array or np.matrix</span>
<span class="sd">        Normal vector to planar front</span>
<span class="sd">  </span>
<span class="sd">    Returns:</span>
<span class="sd">    ----------</span>
<span class="sd">    a,b,c,d: float</span>
<span class="sd">        Solution for a plane at time t where plane has the solution 0=a*x+b*y+c*z+d</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#solve (a*x0+b*y0+c*z0+d)/||v|| = 0</span>
    <span class="c1">#where ||v|| = sqrt(a^2+b^2+c^2)</span>
    <span class="c1">#and distance from the plane to the origin is  dis = d/||v||</span>
    

    <span class="c1">#get the magnitude of the normal vector on the plane from the origin</span>
    <span class="n">pm</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>

    <span class="c1">#Use definition parameter </span>
    <span class="n">coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vn</span><span class="o">*</span><span class="n">pm</span><span class="p">))</span> <span class="c1">#.reshape(-1)</span>


    <span class="c1">#store coefficients</span>
    <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">b</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">c</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">coeff</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pi</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">]</span></div>

<div class="viewcode-block" id="arb_rotation_matrix"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.arb_rotation_matrix">[docs]</a><span class="k">def</span> <span class="nf">arb_rotation_matrix</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a rotation matrix between two unit vectors a and b.</span>
<span class="sd">    U.dot(a) = b</span>
<span class="sd"> </span>
<span class="sd">    Parameters</span>
<span class="sd">    ------------</span>
<span class="sd">    a,b: np.array</span>
<span class="sd">        Two 3 element numpy array unit vectors</span>

<span class="sd">    Returns</span>
<span class="sd">    -----------</span>
<span class="sd">    rot_mat: np.array</span>
<span class="sd">        3x3 rotation matrix between unit vectors</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

    <span class="n">I</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="c1">#skew-symmetric cross product of matrix v</span>
    <span class="n">vx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                   <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                   <span class="p">[</span><span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">]])</span>

    <span class="n">rot_mat</span> <span class="o">=</span> <span class="n">I</span><span class="o">+</span><span class="n">vx</span><span class="o">+</span><span class="n">vx</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vx</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rot_mat</span></div>



<span class="c1">#Function to read in spacecraft</span>
<div class="viewcode-block" id="read_in"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.read_in">[docs]</a><span class="k">def</span> <span class="nf">read_in</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">p_var</span><span class="o">=</span><span class="s1">&#39;predict_shock_500&#39;</span><span class="p">,</span><span class="n">arch</span><span class="o">=</span><span class="s1">&#39;../cdf/cdftotxt/&#39;</span><span class="p">,</span>
            <span class="n">mag_fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_mag_2015_2017_formatted.txt&#39;</span><span class="p">,</span><span class="n">pls_fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_pls_2015_2017_formatted.txt&#39;</span><span class="p">,</span>
            <span class="n">orb_fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">_orb_2015_2017_formatted.txt&#39;</span><span class="p">,</span>
            <span class="n">start_t</span><span class="o">=</span><span class="s1">&#39;2016/12/01&#39;</span><span class="p">,</span><span class="n">end_t</span><span class="o">=</span><span class="s1">&#39;2017/09/24&#39;</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function to read in text files for a given spacecraft. Also replaces out of range and flagged values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    k: string</span>
<span class="sd">        Then name of a spacecraft so to format for file read in</span>
<span class="sd">    arch: string, optional</span>
<span class="sd">        The archive location for the text file to read in (Default = &#39;../cdf/cdftotxt/&#39;)</span>
<span class="sd">    mag_fmt: string, optional</span>
<span class="sd">        The file format for the magnetic field observations (Default = &#39;{0}_mag_2015_2017_formatted.txt&#39;,</span>
<span class="sd">        where 0 is the formatted k).</span>
<span class="sd">    pls_fmt: string, optional</span>
<span class="sd">        The file format for the plasma observations (Default = &#39;{0}_pls_2015_2017_formatted.txt&#39;,</span>
<span class="sd">        where 0 is the formatted k).</span>
<span class="sd">    orb_fmt: string, optional</span>
<span class="sd">        The file format for the orbital data (Default = &#39;{0}_orb_2015_2017_formatted.txt&#39;,</span>
<span class="sd">        where 0 is the formatted k).</span>
<span class="sd">    center = boolean, optional</span>
<span class="sd">        Whether the analyzed point to be center focused (center = True) or right focus (Default = False).</span>
<span class="sd">        Center focus gives you a better localized point, however, the model is trained with a right focus</span>
<span class="sd">        in order to reject spikes and increase S/N.</span>
<span class="sd">    start_t: string, optional</span>
<span class="sd">        Date in YYYY/MM/DD format to start looking for events (Default = &#39;2016/06/04&#39;)</span>
<span class="sd">    end_t: string, optional</span>
<span class="sd">        Date in YYYY/MM/DD format to stop looking for events (inclusive, Default = &#39;2017/07/31&#39;)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    plsm: Pandas DataFrame</span>
<span class="sd">        A pandas dataframe with probability values and combined mag and plasma observations.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Read in plasma and magnetic field data from full res</span>
    <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;soho&#39;</span><span class="p">:</span>
        <span class="n">pls</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">arch</span><span class="o">+</span><span class="n">pls_fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()),</span><span class="n">delim_whitespace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">pls</span><span class="p">[</span><span class="s1">&#39;Bt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="c1">#Change to function that reads cdf files for less data intense loads 2018/05/17 J. Prchlik</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">outp</span> <span class="o">=</span> <span class="n">lcf</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start_t</span><span class="p">),</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">end_t</span><span class="p">),</span><span class="n">scrf</span><span class="o">=</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()],</span><span class="n">pls</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mag</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">orb</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
     
        <span class="c1">#Add data quality cut 2018/05/18 J. Prchlik</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;dscovr&#39;</span><span class="p">:</span>
            <span class="n">good_pls</span> <span class="o">=</span> <span class="p">(</span><span class="n">outp</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s1">&#39;pls&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">DQF</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">pls</span> <span class="o">=</span> <span class="n">outp</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s1">&#39;pls&#39;</span><span class="p">][</span><span class="n">good_pls</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pls</span> <span class="o">=</span> <span class="n">outp</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s1">&#39;pls&#39;</span><span class="p">]</span>


    <span class="n">Re</span> <span class="o">=</span> <span class="mf">6371.0</span><span class="c1"># Earth radius in km </span>

    <span class="c1">#no magnetic field data from SOHO</span>
    <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;soho&#39;</span><span class="p">:</span>
        <span class="c1">#Change to function that reads cdf files for less data intense loads 2018/05/17 J. Prchlik</span>
        <span class="c1">#Add data quality cut 2018/05/18 J. Prchlik</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;dscovr&#39;</span><span class="p">:</span>
            <span class="n">good_mag</span> <span class="o">=</span> <span class="p">(</span><span class="n">outp</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">DQF</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">mag</span> <span class="o">=</span> <span class="n">outp</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s1">&#39;mag&#39;</span><span class="p">][</span><span class="n">good_mag</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mag</span> <span class="o">=</span> <span class="n">outp</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span>


        <span class="n">orb</span> <span class="o">=</span> <span class="n">outp</span><span class="p">[</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s1">&#39;orb&#39;</span><span class="p">]</span>

        <span class="c1">#create datetime objects from time</span>
        <span class="n">pls</span><span class="p">[</span><span class="s1">&#39;time_dt_pls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">pls</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span>
        <span class="n">mag</span><span class="p">[</span><span class="s1">&#39;time_dt_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">mag</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span>
        <span class="n">orb</span><span class="p">[</span><span class="s1">&#39;time_dt_orb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">orb</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span>

        <span class="c1">#setup index</span>
        <span class="n">pls</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">pls</span><span class="o">.</span><span class="n">time_dt_pls</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mag</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">mag</span><span class="o">.</span><span class="n">time_dt_mag</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">orb</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">orb</span><span class="o">.</span><span class="n">time_dt_orb</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">#multiply each component by Earth Radius for Themis observations</span>
        <span class="k">if</span> <span class="s1">&#39;themis&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="n">orb</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;GSEx&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">Re</span>
            <span class="n">orb</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">Re</span>
            <span class="n">orb</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">Re</span>
            <span class="c1">#Convert from GSM to GSE 2018/04/25 J. Prchlik</span>
            <span class="n">mag</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;By&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">mag</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1">#Add total magnetic field 2018/09/07 J. Prchlik</span>
        <span class="n">mag</span><span class="p">[</span><span class="s1">&#39;Bt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">mag</span><span class="o">.</span><span class="n">Bx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">mag</span><span class="o">.</span><span class="n">By</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">mag</span><span class="o">.</span><span class="n">Bz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>

        <span class="c1">#replace bad values in thermal velocity</span>
        <span class="n">pls</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pls</span><span class="o">.</span><span class="n">Vth</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8000</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span><span class="s1">&#39;Vth&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1">#replace bad values in density</span>
        <span class="n">pls</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pls</span><span class="o">.</span><span class="n">Np</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8000</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span><span class="s1">&#39;Np&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1">#replace bad values in Speed</span>
        <span class="n">pls</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pls</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8000</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1">#cut for testing reasons</span>
        <span class="n">pls</span> <span class="o">=</span> <span class="n">pls</span><span class="p">[</span><span class="n">start_t</span><span class="p">:</span><span class="n">end_t</span><span class="p">]</span>
        <span class="n">mag</span> <span class="o">=</span> <span class="n">mag</span><span class="p">[</span><span class="n">start_t</span><span class="p">:</span><span class="n">end_t</span><span class="p">]</span>
        <span class="n">orb</span> <span class="o">=</span> <span class="n">orb</span><span class="p">[</span><span class="n">start_t</span><span class="p">:</span><span class="n">end_t</span><span class="p">]</span>

        <span class="c1">#pls = pls[&#39;2016/07/18&#39;:&#39;2016/07/21&#39;]</span>
        <span class="c1">#mag = mag[&#39;2016/07/18&#39;:&#39;2016/07/21&#39;]</span>
        <span class="c1">#pls = pls[&#39;2017/01/25&#39;:&#39;2017/01/27&#39;]</span>
        <span class="c1">#mag = mag[&#39;2017/01/25&#39;:&#39;2017/01/27&#39;]</span>

        <span class="c1">#join magnetic field and plasma dataframes</span>
        <span class="n">com_df</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">mag</span><span class="p">,</span><span class="n">pls</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span><span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_mag&#39;</span><span class="p">,</span><span class="s1">&#39;_pls&#39;</span><span class="p">),</span><span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">#make sure data columns are numeric</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">,</span><span class="s1">&#39;Np&#39;</span><span class="p">,</span><span class="s1">&#39;Vth&#39;</span><span class="p">,</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">,</span><span class="s1">&#39;Bt&#39;</span><span class="p">]</span>
        <span class="n">com_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">com_df</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

        <span class="c1">#add Time string</span>
        <span class="n">com_df</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">com_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y/%m/</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)</span>

        <span class="n">plsm</span> <span class="o">=</span> <span class="n">com_df</span>
        <span class="c1">#replace NaN with previously measured value</span>
        <span class="c1">#com_df.fillna(method=&#39;bfill&#39;,inplace=True)</span>

        <span class="c1">#add orbital data</span>
        <span class="n">plsm</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">plsm</span><span class="p">,</span><span class="n">orb</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">,</span><span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;_orb&#39;</span><span class="p">),</span><span class="n">sort</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#make sure data columns are numeric</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">,</span><span class="s1">&#39;Np&#39;</span><span class="p">,</span><span class="s1">&#39;Vth&#39;</span><span class="p">,</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">,</span><span class="s1">&#39;GSEx&#39;</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">]</span>
        <span class="n">plsm</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>

        <span class="c1">#add Time string</span>
        <span class="n">plsm</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y/%m/</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">)</span>

        <span class="c1">#fill undersampled orbit</span>
        <span class="k">for</span> <span class="n">cor</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">]:</span> <span class="n">plsm</span><span class="p">[</span><span class="s1">&#39;GSE&#39;</span><span class="o">+</span><span class="n">cor</span><span class="p">]</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">plsm</span> <span class="o">=</span> <span class="n">pls</span>   
        <span class="c1">#work around for no Mag data in SOHO</span>
        <span class="n">pls</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">,</span><span class="s1">&#39;Bt&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">pls</span><span class="p">[</span><span class="s1">&#39;time_dt_pls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">pls</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span>
        <span class="n">pls</span><span class="p">[</span><span class="s1">&#39;time_dt_mag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">pls</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span>
        <span class="n">pls</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">pls</span><span class="o">.</span><span class="n">time_dt_pls</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plsm</span> <span class="o">=</span> <span class="n">pls</span><span class="p">[</span><span class="n">start_t</span><span class="p">:</span><span class="n">end_t</span><span class="p">]</span>
        <span class="n">plsm</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">,</span><span class="s1">&#39;Bt&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.0</span>

        <span class="n">Re</span> <span class="o">=</span> <span class="mf">6371.0</span> <span class="c1"># Earth radius</span>

        <span class="c1">#multiply each component by Earth Radius</span>
        <span class="n">plsm</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;X&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">Re</span>
        <span class="n">plsm</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;Y&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">Re</span>
        <span class="n">plsm</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;Z&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">Re</span>

        <span class="c1">#chane column name from X, Y, Z to GSEx, GSEy, GSEz </span>
        <span class="n">plsm</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;X&#39;</span><span class="p">:</span><span class="s1">&#39;GSEx&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">:</span><span class="s1">&#39;GSEy&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="s1">&#39;GSEz&#39;</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#force index to sort</span>
    <span class="n">plsm</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#for rekeying later</span>
    <span class="n">plsm</span><span class="p">[</span><span class="s1">&#39;craft&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>

    <span class="k">return</span> <span class="n">plsm</span></div>




<div class="viewcode-block" id="dtw_plane"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.dtw_plane">[docs]</a><span class="k">class</span> <span class="nc">dtw_plane</span><span class="p">:</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">start_t</span><span class="p">,</span><span class="n">end_t</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">events</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">par</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">justparm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">nproc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">earth_craft</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">penalty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">pad_earth</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;1 hour&#39;</span><span class="p">),</span><span class="n">speed_pen</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span><span class="n">mag_pen</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class to get planar DTW solutions for L1 spacecraft.      </span>
<span class="sd"> </span>
<span class="sd">        Parameters:</span>
<span class="sd">        ----------</span>
<span class="sd">        start_t: string</span>
<span class="sd">            Any string format recongized by pd.to_datetime indicating when to start looking for events</span>
<span class="sd">        end_t: string</span>
<span class="sd">            Any string format recongized by pd.to_datetime indicating when to stop looking for events</span>
<span class="sd">        center: boolean, optional</span>
<span class="sd">            Whether to use the center pixel for a running mean (Default = True). Otherwise running mean</span>
<span class="sd">            is set by preceding pixels</span>
<span class="sd">        events: int,optional</span>
<span class="sd">            Number of Events to find planar solution for in given time period (Default = 1)</span>
<span class="sd">        par: string or list, optional</span>
<span class="sd">            Parameter to use when matching via DTW (Default = None). The default solution is to use </span>
<span class="sd">            flow speed for SOHO CELIAS and maximum difference in a 3 minute window for magnetic </span>
<span class="sd">            field component for every other spacecraft.</span>
<span class="sd">        justparm: boolean, optional</span>
<span class="sd">            Just do DTW solution but do not create animation of solution as a funciton of time</span>
<span class="sd">            (Default = True)</span>
<span class="sd">        nproc: integer, optional</span>
<span class="sd">            Number of processors to use for matching (Default = 1). Currently, there is no reason</span>
<span class="sd">            to change this value, but is a place holder incase someday it becomes useful</span>
<span class="sd">        earth_craft: list, optional </span>
<span class="sd">            Show Themis/Artemis space craft and the best solutions (Default = None). Can be </span>
<span class="sd">            any combinateion of [&#39;THEMIS_B&#39;,&#39;THEMIS_C&#39;,&#39;THEMIS_A&#39;] </span>
<span class="sd">        penalty: boolean, optional</span>
<span class="sd">            Include a penalty in the DTW solution for compression of time (Default = True)</span>
<span class="sd">        pad_earth: pandas time delta object, optional</span>
<span class="sd">            Time offset to apply when reading in spacecraft data near earth (Default = pd.to_timedelta(&#39;1 hour&#39;))</span>
<span class="sd">        speed_pen: float</span>
<span class="sd">            Penatly in km/s for squashing speed time in DTW (Default = 10.). Only works if penalty is set to True</span>
<span class="sd">        mag_pen: float</span>
<span class="sd">            Penatly in nT for squashing magnetic field time in DTW (Default = 0.2). Only works if penalty is set to True.</span>

<span class="sd">        Example: </span>
<span class="sd">        ----------</span>
<span class="sd">        import model_time_range as mtr</span>
<span class="sd">        plane = mtr.dtw_plane(&#39;2016/07/19 21:00:00&#39;,&#39;2016/07/20 01:00:00&#39;,earth_craft=[&#39;THEMIS_B&#39;],penalty=False)</span>
<span class="sd">        plane.init_read()</span>
<span class="sd">        plane.dtw()</span>
<span class="sd">       </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> <span class="o">=</span> <span class="n">start_t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_t</span> <span class="o">=</span> <span class="n">end_t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">par</span> <span class="o">=</span> <span class="n">par</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">justparm</span> <span class="o">=</span> <span class="n">justparm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nproc</span> <span class="o">=</span> <span class="n">nproc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Re</span> <span class="o">=</span> <span class="mf">6371.0</span> <span class="c1">#km</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">events</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">earth_craft</span> <span class="o">=</span> <span class="n">earth_craft</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">penalty</span> <span class="o">=</span> <span class="n">penalty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad_earth</span> <span class="o">=</span> <span class="n">pad_earth</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">first</span> <span class="o">=</span> <span class="kc">True</span>


        <span class="c1">#store penanalties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">speed_pen</span> <span class="o">=</span> <span class="n">speed_pen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mag_pen</span> <span class="o">=</span> <span class="n">mag_pen</span>


        <span class="c1">#set use to use all spacecraft</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">craft</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Wind&#39;</span><span class="p">,</span><span class="s1">&#39;DSCOVR&#39;</span><span class="p">,</span><span class="s1">&#39;ACE&#39;</span><span class="p">,</span><span class="s1">&#39;SOHO&#39;</span><span class="p">,</span><span class="s1">&#39;THEMIS_A&#39;</span><span class="p">,</span><span class="s1">&#39;THEMIS_B&#39;</span><span class="p">,</span><span class="s1">&#39;THEMIS_C&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span>   <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="s1">&#39;teal&#39;</span><span class="p">,</span><span class="s1">&#39;purple&#39;</span><span class="p">,</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span><span class="s1">&#39;cyan&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mar</span>   <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;^&#39;</span><span class="p">,</span><span class="s1">&#39;8&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">marker</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">color</span>  <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span> <span class="o">=</span> <span class="s1">&#39;Wind&#39;</span>

        <span class="c1">#create dictionaries for labels</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">craft</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">marker</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mar</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>



        <span class="c1">#reset craft variable and add earth craft as requested</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">craft</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Wind&#39;</span><span class="p">,</span><span class="s1">&#39;DSCOVR&#39;</span><span class="p">,</span><span class="s1">&#39;ACE&#39;</span><span class="p">,</span><span class="s1">&#39;SOHO&#39;</span><span class="p">]</span>
      
        
    



<div class="viewcode-block" id="dtw_plane.init_read"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.dtw_plane.init_read">[docs]</a>    <span class="k">def</span> <span class="nf">init_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads in text files containing information on solar wind parameters measured at different space craft</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        self: class</span>
<span class="sd">            Variables contained in self variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Parameters for file read in and parsing</span>
        <span class="c1">#Could be an issue with downwind THEMIS craft 2018/04/25 J. Prchlik</span>
        <span class="n">par_read_in</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">read_in</span><span class="p">,</span><span class="n">start_t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_t</span><span class="p">,</span><span class="n">end_t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">end_t</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">)</span>
        <span class="c1">#read in and format spacecraft in parallel</span>
        <span class="c1">#Switched to single loop solution 2018/03/24 J. Prchlik </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first</span><span class="p">:</span> <span class="c1">#only do read in on the first pass</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nproc</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">:</span>
                <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">craft</span><span class="p">))</span>
                <span class="n">outp</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">par_read_in</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">craft</span><span class="p">)</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1">#create global plasma key</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outp</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">craft</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c1">#create global plasma key</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">craft</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_read_in</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        
            <span class="c1">#set readin to first attempt to false</span>
            <span class="c1">#prevent multiple readin of big files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">first</span> <span class="o">=</span> <span class="kc">False</span>


            <span class="c1">#do the same for the Earth spacecraft </span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">earth_craft</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">earth_craft</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">craft</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
 
                 
                <span class="c1">#Add an hour to the data to approximate time delay</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">earth_start</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_t</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_earth</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">earth_end</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_t</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_earth</span><span class="p">)</span>
                <span class="n">par_read_in_e</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">read_in</span><span class="p">,</span><span class="n">start_t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">earth_start</span><span class="p">,</span><span class="n">end_t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">earth_end</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nproc</span> <span class="o">&gt;</span> <span class="mf">1.5</span><span class="p">:</span>
                    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">earth_craft</span><span class="p">))</span>
                    <span class="n">outp</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">par_read_in_e</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">earth_craft</span><span class="p">)</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

                    <span class="c1">#create global plasma key</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">outp</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">craft</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#create global plasma key</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">earth_craft</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_read_in_e</span><span class="p">(</span><span class="n">i</span><span class="p">)</span></div>
        
            <span class="c1">#set readin to first attempt to false</span>
            <span class="c1">#prevent multiple readin of big files</span>

<div class="viewcode-block" id="dtw_plane.iterate_dtw"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.dtw_plane.iterate_dtw">[docs]</a>    <span class="k">def</span> <span class="nf">iterate_dtw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pr_1</span><span class="o">=</span><span class="mf">85.</span><span class="p">,</span><span class="n">pr_2</span><span class="o">=</span><span class="mf">30.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iteratively find the best DTW solution. In the first iteration get the best time offset between spacecraft.</span>
<span class="sd">        In the second iteration find the best DTW solution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------------</span>
<span class="sd">        pr_1: float, optional</span>
<span class="sd">            Number of minutes allowed when scanning for a DTW solution in the first iteration (Default = 85.)</span>
<span class="sd">        pr_2: float, optional</span>
<span class="sd">            Number of minutes allowed when scanning for a DTW solution in the second iteration (Default = 30.)</span>
<span class="sd">  </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#run the initial DTW solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtw</span><span class="p">(</span><span class="n">pr_1</span><span class="p">)</span>
        <span class="c1">#get DTW offset keys from plasma dictionary</span>
        <span class="n">off_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;offset&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_offset&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
                    <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">earth_craft</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_offset&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="p">))]</span>


        <span class="c1">#pandas start and end times as datetime objects</span>
        <span class="n">pd_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_t</span><span class="p">)</span>
        <span class="n">pd_e</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_t</span><span class="p">)</span>
        <span class="n">pd_p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;30m&#39;</span><span class="p">)</span>
        <span class="c1">#get middle point of DTW range</span>
        <span class="n">pd_m</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd_e</span><span class="o">-</span><span class="n">pd_s</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="o">+</span><span class="n">pd_s</span>


        <span class="c1">#loop over all keys of offset non-trainer/non-earth spacecraft</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">off_keys</span><span class="p">):</span>
            <span class="c1">#get average offset between Trainer craft and specific space craft in the core hour of the observations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="s1">&#39;ave_offset_&#39;</span><span class="o">+</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_offset&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd_m</span><span class="o">-</span><span class="n">pd_p</span><span class="p">:</span><span class="n">pd_m</span><span class="o">+</span><span class="n">pd_p</span><span class="p">][</span><span class="s1">&#39;offsets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span> <span class="c1">#.values.astype(float)*1e-9</span>

        <span class="c1">#datetime format to write string out</span>
        <span class="n">dfmt</span> <span class="o">=</span> <span class="s1">&#39;{0:%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S}&#39;</span>
        <span class="c1">#recreate global plasma key</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">off_keys</span><span class="p">:</span>
            <span class="c1">#Need to repopulate the non-offset plasma values</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_offset&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
            <span class="n">new_start_t</span> <span class="o">=</span> <span class="n">dfmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pd_s</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="s1">&#39;ave_offset_&#39;</span><span class="o">+</span><span class="n">i</span><span class="p">])</span>
            <span class="n">new_end_t</span>   <span class="o">=</span> <span class="n">dfmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pd_e</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="s1">&#39;ave_offset_&#39;</span><span class="o">+</span><span class="n">i</span><span class="p">])</span>
            <span class="n">par_read_in</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">read_in</span><span class="p">,</span><span class="n">start_t</span><span class="o">=</span><span class="n">new_start_t</span><span class="p">,</span><span class="n">end_t</span><span class="o">=</span><span class="n">new_end_t</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">par_read_in</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

        

        <span class="c1">#recompute DTW solution with new time offsets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtw</span><span class="p">(</span><span class="n">pr</span><span class="o">=</span><span class="n">pr_2</span><span class="p">)</span></div>

        <span class="c1">#Do one at a time for now 2018/11/19 J. Prchlik</span>
        <span class="c1">#####Parameters for file read in and parsing</span>
        <span class="c1">#####Could be an issue with downwind THEMIS craft 2018/04/25 J. Prchlik</span>
        <span class="c1">####par_read_in = partial(read_in,start_t=self.start_t,end_t=self.end_t,center=self.center)</span>
        <span class="c1">#####read in and format spacecraft in parallel</span>
        <span class="c1">#####Switched to single loop solution 2018/03/24 J. Prchlik </span>
        <span class="c1">####if self.first: #only do read in on the first pass</span>
        <span class="c1">####    if self.nproc &gt; 1.5:</span>
        <span class="c1">####        pool = Pool(processes=len(self.craft))</span>
        <span class="c1">####        outp = pool.map(par_read_in,self.craft)</span>
        <span class="c1">####        pool.terminate()</span>
        <span class="c1">####        pool.close()</span>
        <span class="c1">####        pool.join()</span>

        <span class="c1">####        self.plsm = {}</span>
        <span class="c1">####        #create global plasma key</span>
        <span class="c1">####        for i in outp:</span>
        <span class="c1">####            self.plsm[i.craft.values[0]] = i</span>
        <span class="c1">####    else:</span>
        


<div class="viewcode-block" id="dtw_plane.dtw"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.dtw_plane.dtw">[docs]</a>    <span class="k">def</span> <span class="nf">dtw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pr</span><span class="o">=</span><span class="mf">85.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds DTW solution to 4 L1 spacecraft, whose later time offsets may be used to predict solar wind conditions at Earth</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------------</span>
<span class="sd">        pr: float, optional</span>
<span class="sd">            Number of minutes allowed when scanning for a DTW solution (Default = 85.)</span>
<span class="sd">     </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Creating modular solution for DTW 2018/03/21 J. Prchlik</span>
        <span class="c1">##set the Start and end time</span>
        <span class="c1">#start_t = &quot;2016/12/21 07:00:00&quot;</span>
        <span class="c1">#end_t = &quot;2016/12/21 13:00:00&quot;</span>
        <span class="c1">#center = True</span>
        <span class="c1">#reset variables to local variables</span>
        <span class="n">Re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Re</span> <span class="c1"># Earth radius</span>
        <span class="n">start_t</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> 
        <span class="n">end_t</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_t</span>   
        <span class="n">center</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span>  
        <span class="n">par</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span>     
        <span class="n">justparm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">justparm</span>
        <span class="n">marker</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marker</span>
        <span class="n">color</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span>
        
        <span class="c1">#set use to use all spacecraft</span>
        <span class="n">craft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">craft</span> <span class="c1">#[&#39;Wind&#39;,&#39;DSCOVR&#39;,&#39;ACE&#39;,&#39;SOHO&#39;]</span>
        <span class="n">col</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span>   <span class="c1">#[&#39;blue&#39;,&#39;black&#39;,&#39;red&#39;,&#39;teal&#39;]</span>
        <span class="n">mar</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mar</span>   <span class="c1">#[&#39;D&#39;,&#39;o&#39;,&#39;s&#39;,&#39;&lt;&#39;]</span>
        <span class="n">trainer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span>
        
        <span class="c1">#range to find the best maximum value</span>
        <span class="n">maxrang</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;3 minutes&#39;</span><span class="p">)</span>
        
        
        <span class="c1">#create new plasma dictory which is a subset of the entire file readin</span>
        <span class="n">plsm</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">craft</span><span class="p">:</span>
             <span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1">#[start_t:end_t] Cutting not required because already using a small sample 2018/05/03 J. Prchlik</span>
             <span class="c1">#remove duplicates</span>
             <span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">~</span><span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)]</span>

        <span class="c1">#get all values at full resolution for dynamic time warping</span>
        <span class="n">t_mat</span>  <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">trainer</span><span class="p">]</span> <span class="c1">#.loc[trainer_t-t_rgh_wid:trainer_t+t_rgh_wid]</span>
  
        <span class="c1">#add trainer matrix to self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_mat</span> <span class="o">=</span> <span class="n">t_mat</span>

        <span class="c1">#Find points with the largest speed differences in wind</span>
        <span class="n">top_vs</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">/</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">)</span>
        
        
        <span class="c1">#sort by time for event number</span>
        <span class="n">top_vs</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1">#add to self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_vs</span> <span class="o">=</span> <span class="n">top_vs</span>

        <span class="c1">#plot with the best timing solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">18</span><span class="p">))</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">fax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fax</span>

       
        <span class="c1">#set range to include all top events (prevents window too large error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;30 minutes&#39;</span><span class="p">)</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">top_vs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">pad</span><span class="p">,</span><span class="n">top_vs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">pad</span><span class="p">])</span>
        
        <span class="c1">#loop over all other craft</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">craft</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;###########################################&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">p_mat</span>  <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="c1">#.loc[i_min-t_rgh_wid:i_min+t_rgh_wid]</span>
        
            <span class="c1">#use speed for rough esimation if possible</span>
            <span class="k">if</span>  <span class="p">((</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;soho&#39;</span><span class="p">)</span> <span class="p">):</span> <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(((</span><span class="n">par</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">par</span><span class="p">,</span><span class="nb">float</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;soho&#39;</span><span class="p">)):</span> <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span> <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="n">par</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">par</span> <span class="o">=</span> <span class="n">par</span>

        
            <span class="c1">#sometimes different componets give better chi^2 values therefore reject the worst when more than 1 parameter</span>
            <span class="c1">#Try using the parameter with the largest difference  in B values preceding and including the event (2017/12/11 J. Prchlik)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">par</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
               <span class="n">check_min</span><span class="p">,</span><span class="n">check_max</span> <span class="o">=</span> <span class="n">top_vs</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">maxrang</span><span class="p">,</span><span class="n">top_vs</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">maxrang</span>
               <span class="n">par_chi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">check_min</span><span class="p">:</span><span class="n">check_max</span><span class="p">,</span><span class="n">par_i</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">check_min</span><span class="p">:</span><span class="n">check_max</span><span class="p">,</span><span class="n">par_i</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">par_i</span> <span class="ow">in</span> <span class="n">par</span><span class="p">])</span>
               <span class="n">use_par</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">par_chi</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">par_chi</span><span class="p">))</span>
               <span class="n">par</span>      <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">par</span><span class="p">)[</span><span class="n">use_par</span><span class="p">])</span>
        
            <span class="c1">#get the median slope and offset</span>
            <span class="c1">#J. Prchlik (2017/11/20)</span>
            <span class="c1">#Dont use interpolated time for solving dynamic time warp (J. Prchlik 2017/12/15)</span>
            <span class="c1">#only try SPEED corrections for SOHO observations</span>
            <span class="c1">#Only apply speed correction after 1 iteration (J. Prchlik 2017/12/18)</span>
            <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;themis&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">())):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1">#create copy of p_mat</span>
                    <span class="n">c_mat</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="c1">#resample the matching (nontrained spacecraft to the trained spacecraft&#39;s timegrid to correct offset (2017/12/15 J. Prchlik)</span>
                    <span class="n">c_mat</span> <span class="o">=</span> <span class="n">c_mat</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
         
                    <span class="c1">#only comoare no NaN values</span>
                    <span class="n">good</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">c_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">values</span><span class="p">))))</span>
         
                    <span class="c1">#if few points for comparison only used baseline offset</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">good</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mf">1E36</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPEED&#39;</span><span class="p">)):</span>
                        <span class="n">med_m</span><span class="p">,</span><span class="n">med_i</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span>
                        <span class="n">off_speed</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                        <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">-</span><span class="n">off_speed</span>
                        <span class="k">if</span> <span class="n">med_m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">*</span><span class="n">med_m</span><span class="o">+</span><span class="n">med_i</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">off_speed</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                        <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">-</span><span class="n">off_speed</span>
                    <span class="c1">#only apply slope if greater than 0</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c1">#get median offset to apply to match spacecraft</span>
                    <span class="n">off_speed</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                    <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">-</span><span class="n">off_speed</span>
         
         
         
            <span class="c1">#get dynamic time warping value   </span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARPING TIME&#39;</span><span class="p">)</span>
            <span class="c1">#use dtw solution that allows penalty for time compression</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">penalty</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;SPEED&#39;</span> <span class="ow">in</span> <span class="n">par</span><span class="p">:</span>
                    <span class="n">penalty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">speed_pen</span>
                <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="s1">&#39;B&#39;</span> <span class="ow">in</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">par</span><span class="p">):</span>
                    <span class="n">penalty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_pen</span>
 
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Penalty = </span><span class="si">{0:4.3f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">penalty</span><span class="p">))</span>
                <span class="c1">#Switching to my code for penalty (Faster and I have more control)</span>
                <span class="c1">###path = dtw.warping_path(t_mat[par[0]].ffill().bfill().values,</span>
                <span class="c1">###                        p_mat[par[0]].ffill().bfill().values,</span>
                <span class="c1">###                        penalty=penalty)</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
                <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">p_mat</span><span class="p">[</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

                <span class="c1">#regularize x1 and x2 using 5 and 95 percentiles</span>
                <span class="n">x1_05</span><span class="p">,</span><span class="n">x1_95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x1</span><span class="p">,[</span><span class="mi">5</span><span class="p">,</span><span class="mi">95</span><span class="p">])</span>
                <span class="n">x2_05</span><span class="p">,</span><span class="n">x2_95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x2</span><span class="p">,[</span><span class="mi">5</span><span class="p">,</span><span class="mi">95</span><span class="p">])</span>

                <span class="c1">#regularlize data</span>
                <span class="c1">#x1 = (x1-x1_05)/(x1_95-x1_05)</span>
                <span class="c1">#x2 = (x2-x2_05)/(x2_95-x2_05)</span>
                
                <span class="c1">#did I flip x1 and x2</span>
                <span class="n">flipped</span> <span class="o">=</span><span class="kc">False</span>

                <span class="c1">#flip x1 and x2 if x1 is small than x2</span>
                <span class="k">if</span> <span class="n">x2</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">x1</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="n">x2</span><span class="p">,</span><span class="n">x1</span> <span class="o">=</span> <span class="n">x1</span><span class="p">,</span><span class="n">x2</span>
                    <span class="n">flipped</span> <span class="o">=</span><span class="kc">True</span>
                
   
                <span class="c1">#Get average time difference</span>
                <span class="n">dt1</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">index</span><span class="p">))</span><span class="o">*</span><span class="mf">1.e-9</span><span class="p">)</span> <span class="c1">#seconds</span>
                <span class="n">dt2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">index</span><span class="p">))</span><span class="o">*</span><span class="mf">1.e-9</span><span class="p">)</span> <span class="c1">#seconds</span>
               

                <span class="c1">#make the penalty kick in at the 10% level</span>
                <span class="n">penalty_r1</span> <span class="o">=</span> <span class="mf">60.</span><span class="o">*</span><span class="n">pr</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">dt1</span><span class="p">,</span><span class="n">dt2</span><span class="p">])</span> <span class="c1">#number of pixels in 65 minutes ((s/m}*(m)/(s)))</span>
                <span class="n">penalty_r2</span> <span class="o">=</span> <span class="mf">60.</span><span class="o">*</span><span class="n">pr</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">dt1</span><span class="p">,</span><span class="n">dt2</span><span class="p">])</span> <span class="c1">#number of pixels in 65 minutes ((s/m}*(m)/(s)))</span>
                <span class="c1">#find DTW path with some restriction on the allowed time offset </span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">dtw_path_single</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">penalty_r1</span><span class="p">,</span><span class="n">penalty_r2</span><span class="p">,</span><span class="mf">500.0</span><span class="p">,</span><span class="mf">100.00</span><span class="p">,</span><span class="mf">1.10</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1">#unflip if flipped</span>
                <span class="k">if</span> <span class="n">flipped</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1">####reformat in old format 2018/04/20 J. Prchlik</span>
                <span class="c1">###path = np.array(path).T</span>
            <span class="c1">#Otherwise you quick DTW solution</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dist</span><span class="p">,</span> <span class="n">cost</span><span class="p">,</span> <span class="n">path</span> <span class="o">=</span> <span class="n">mlpy</span><span class="o">.</span><span class="n">dtw_std</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">p_mat</span><span class="p">[</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span><span class="n">dist_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;STOP WARPING TIME&#39;</span><span class="p">)</span>
        
            <span class="c1">#get full offsets for dynamic time warping</span>
            <span class="n">off_sol</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">],:]</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">t_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;REINDEXED&#39;</span><span class="p">)</span>
        
            <span class="c1">#get a region around one of the best fit times</span>
            <span class="n">b_mat</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
            <span class="c1">#update the time index of the match array for comparision with training spacecraft (i=training spacecraft time)</span>
            <span class="n">b_mat</span> <span class="o">=</span> <span class="n">b_mat</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">b_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">],:]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="c1">#.interpolate(&#39;time&#39;)</span>
            <span class="n">b_mat</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">b_mat</span><span class="o">.</span><span class="n">index</span><span class="o">-</span><span class="n">off_sol</span>
            <span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;offsets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">off_sol</span>

            <span class="c1">#Add the indices for path1 and path2 2018/11/07 J. Prchlik</span>
            <span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;train_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;match_ind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
            <span class="c1">#Add offset data frame to plasma diction</span>
            <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_mat</span>

           
            <span class="c1">#plot plasma parameters</span>
            <span class="c1">#fax[0,0].scatter(b_mat[b_mat[&#39;Np&#39;   ] &gt; -9990.0].index,b_mat[b_mat[&#39;Np&#39;   ] &gt; -9990.0].Np   ,marker=marker[k],color=color[k],label=k.upper())         </span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Np</span>   <span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
                <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Np</span>   <span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Vth</span>  <span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
                <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Vth</span>  <span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        
            <span class="c1">#plot mag. parameters</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;soho&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bx</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bx</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">By</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">By</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bz</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bz</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;###########################################&#39;</span><span class="p">)</span>
        
        
        <span class="c1">#set 0 offsets for training spacecraft</span>
        <span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;offsets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
        <span class="n">plsm</span><span class="p">[</span><span class="n">trainer</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_mat</span>
        
        
        <span class="c1">#plot plasma parameters for Wind</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Np</span>   <span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Np</span>   <span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Vth</span>  <span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">trainer</span><span class="p">)</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Vth</span>  <span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">])</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        
        <span class="c1">#plot mag. parameters</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bx</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">])</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bx</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">By</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">])</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">By</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bz</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">])</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bz</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        
        <span class="n">fancy_plot</span><span class="p">(</span><span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fancy_plot</span><span class="p">(</span><span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fancy_plot</span><span class="p">(</span><span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fancy_plot</span><span class="p">(</span><span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">fancy_plot</span><span class="p">(</span><span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">fancy_plot</span><span class="p">(</span><span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1">#i = pd.to_datetime(&quot;2016/12/21 08:43:12&quot;) </span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">start_t</span><span class="p">,</span><span class="n">end_t</span><span class="p">])</span>
        
        <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Np [cm$^{-3}$]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Th. Speed [km/s]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flow Speed [km/s]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [UTC]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        
        <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Bx [nT]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;By [nT]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Bz [nT]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [UTC]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        
        <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="mf">100.</span><span class="p">])</span>


        <span class="c1">#add legend to plot</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        
        <span class="c1">#turn into data frame </span>
        <span class="n">frm_vs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">top_vs</span><span class="p">)</span>
        <span class="c1">#add columns</span>
        <span class="n">col_add</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Vx&#39;</span><span class="p">,</span><span class="s1">&#39;Vy&#39;</span><span class="p">,</span><span class="s1">&#39;Vz&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">col_add</span><span class="p">:</span> <span class="n">frm_vs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.9</span>



        <span class="c1">#Updated self plasma dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span> <span class="o">=</span> <span class="n">plsm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fax</span> <span class="o">=</span> <span class="n">fig</span><span class="p">,</span><span class="n">fax</span></div>
        
        <span class="c1">#Do not need this 2018/03/21 J. Prchlik</span>
        <span class="c1">####Use wind CDF to get velocity comps</span>
        <span class="c1">####cdf = pycdf.CDF(&#39;/Volumes/Pegasus/jprchlik/dscovr/solar_wind_events/cdf/wind/plsm/wi_h1_swe_20161221_v01.cdf&#39;)</span>
        <span class="c1">####</span>
        <span class="c1">####wind_vx = cdf[&#39;Proton_VX_nonlin&#39;][...]</span>
        <span class="c1">####wind_vy = cdf[&#39;Proton_VY_nonlin&#39;][...]</span>
        <span class="c1">####wind_vz = cdf[&#39;Proton_VZ_nonlin&#39;][...]</span>
        <span class="c1">####wind_t0 = cdf[&#39;Epoch&#39;][...]</span>
        <span class="c1">####</span>
        <span class="c1">####cdf.close()</span>
        <span class="c1">####</span>
        <span class="c1">#####create pandas dataframe with wind components</span>
        <span class="c1">####wind_v = pd.DataFrame(np.array([wind_t0,wind_vx,wind_vy,wind_vz]).T,columns=[&#39;time_dt&#39;,&#39;Vx&#39;,&#39;Vy&#39;,&#39;Vz&#39;])</span>
        <span class="c1">####wind_v.set_index(wind_v.time_dt,inplace=True)</span>
        <span class="c1">#big list of velocities</span>
        <span class="c1">#big_lis = []</span>

<div class="viewcode-block" id="dtw_plane.pred_earth"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.dtw_plane.pred_earth">[docs]</a>    <span class="k">def</span> <span class="nf">pred_earth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cut_deg</span><span class="o">=</span><span class="mf">70.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create prediction for Earth and create corresponding plots</span>
<span class="sd">    </span>
<span class="sd">        Parmeters</span>
<span class="sd">        -------------</span>
<span class="sd">        cut_deg: float</span>
<span class="sd">            Cut calculated normal vectors more than cut_deg away from [-1.,0.,0.]</span>
<span class="sd">             GSE to removed from the prediction (Default = 70, Weimer et al. 2003).</span>
<span class="sd">    </span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="c1">#Use common names for self variables</span>
        <span class="n">t_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_mat</span>
        <span class="n">plsm</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span>
        <span class="n">Re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Re</span> <span class="c1"># Earth radius</span>
        <span class="n">start_t</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> 
        <span class="n">end_t</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_t</span>   
        <span class="n">center</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span>  
        <span class="n">par</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span>     
        <span class="n">justparm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">justparm</span>
        <span class="n">marker</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marker</span>
        <span class="n">color</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">fax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fax</span>
        
        <span class="c1">#set use to use all spacecraft</span>
        <span class="n">craft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">craft</span> <span class="c1">#[&#39;Wind&#39;,&#39;DSCOVR&#39;,&#39;ACE&#39;,&#39;SOHO&#39;]</span>
        <span class="n">col</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span>   <span class="c1">#[&#39;blue&#39;,&#39;black&#39;,&#39;red&#39;,&#39;teal&#39;]</span>
        <span class="n">mar</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mar</span>   <span class="c1">#[&#39;D&#39;,&#39;o&#39;,&#39;s&#39;,&#39;&lt;&#39;]</span>
        <span class="n">trainer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span>
        
        <span class="c1">#range to find the best maximum value</span>
        <span class="n">maxrang</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;3 minutes&#39;</span><span class="p">)</span>
    
        <span class="c1">#Find points with the largest speed differences in wind</span>
        <span class="c1">#Allow dyanic allocation of top events 2018/05/17 J. Prchlik</span>
        <span class="n">top_vs</span> <span class="o">=</span> <span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">trainer</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">/</span><span class="n">plsm</span><span class="p">[</span><span class="n">trainer</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">)</span>
        
        
        <span class="c1">#sort by time for event number</span>
        <span class="n">top_vs</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    
    
        
    
    
        <span class="c1">#Add plot for prediction on THEMIS</span>
        <span class="n">fig_th</span><span class="p">,</span><span class="n">ax_th</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="c1">#Add plot with just the THEMIS plasma data</span>
        <span class="k">for</span> <span class="n">esp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">earth_craft</span><span class="p">:</span>
            <span class="n">slicer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">)</span>
            <span class="n">ax_th</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">slicer</span><span class="p">,:]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">rolling_mean</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">slicer</span><span class="p">,:]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">,</span><span class="mi">25</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">esp</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span><span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
        <span class="n">ax_th</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_t</span><span class="p">)</span><span class="o">-</span><span class="n">pad</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_t</span><span class="p">)</span><span class="o">+</span><span class="n">pad</span><span class="p">])</span>
        <span class="n">ax_th</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [UTC]&#39;</span><span class="p">)</span>
        <span class="n">ax_th</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flow Speed [km/s]&#39;</span><span class="p">)</span>
        <span class="n">fancy_plot</span><span class="p">(</span><span class="n">ax_th</span><span class="p">)</span>
    
    
        <span class="c1">#create dictionary of values for each event 2018/04/24 J. Prchlik</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1">#Store arrival times and plasma parameters in seperate array</span>
        <span class="c1">#to call when comparing with omni prediction</span>
        <span class="k">for</span> <span class="n">esp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">earth_craft</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_plsm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_velo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_nvec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    
        <span class="c1">#List of time and Speed value of events J. Prchlik</span>
        <span class="n">event_plot</span> <span class="o">=</span> <span class="p">[]</span>
    
        <span class="c1">#time delta to skip at the beginning and end due to compression in DTW</span>
        <span class="n">dtw_skp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;45m&#39;</span><span class="p">)</span>
        <span class="n">dtw_stt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_t</span><span class="p">)</span> 
        <span class="n">dtw_end</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_t</span><span class="p">)</span> 
    
        
        <span class="c1">#Plot the top shock values</span>
        <span class="c1">#fax[2,0].scatter(t_mat.loc[top_vs.index,:].index,t_mat.loc[top_vs.index,:].SPEED,color=&#39;purple&#39;,marker=&#39;X&#39;,s=150)</span>
        <span class="c1">#for j,i in enumerate(top_vs.index):</span>
        <span class="c1">#try producing continous plot 2018/05/17 J. Prchlik</span>
        <span class="c1">#This method did not work</span>
        <span class="c1">#Trying again with multi parameter approach 2018/07/26 J. Prchlik</span>
        <span class="c1">#Trying everytin again using the core of the observation </span>
        <span class="c1">#And my new DTW alogrithm</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
            <span class="c1">#skip the first and last 45 minutes for removing compression artifacts</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="n">dtw_stt</span> <span class="o">&lt;</span> <span class="n">dtw_skp</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dtw_end</span><span class="o">-</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">dtw_skp</span><span class="p">)):</span>
                <span class="k">continue</span>
    
            <span class="c1">#get particular speed value</span>
            <span class="n">yval</span> <span class="o">=</span> <span class="n">t_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">SPEED</span>
            <span class="n">yvalb</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">xval</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    
            <span class="c1">#try producing continous plot 2018/05/17 J. Prchlik</span>
            <span class="c1">#Removing 2017/07/26 J. Prchlk</span>
            <span class="c1">#fax[2,0].annotate(&#39;Event {0:1d}&#39;.format(j+1),xy=(xval,yval),xytext=(xval,yval+50.),</span>
            <span class="c1">#                  arrowprops=dict(facecolor=&#39;purple&#39;,shrink=0.005))</span>
            <span class="c1">#fax[2,1].annotate(&#39;Event {0:1d}&#39;.format(j+1),xy=(xval,yvalb),xytext=(xval,yvalb+2.),</span>
            <span class="c1">#                  arrowprops=dict(facecolor=&#39;purple&#39;,shrink=0.005))</span>
    
    
            <span class="c1">#computer surface for events</span>
            <span class="c1">#tvals = -np.array([np.mean(plsm[c+&#39;_offset&#39;].loc[i,&#39;offsets&#39;]).total_seconds() for c in craft])</span>
            <span class="c1">#xvals = np.array([np.mean(plsm[c].loc[i,&#39;GSEx&#39;]) for c in craft])</span>
            <span class="c1">#yvals = np.array([np.mean(plsm[c].loc[i,&#39;GSEy&#39;]) for c in craft])</span>
            <span class="c1">#zvals = np.array([np.mean(plsm[c].loc[i,&#39;GSEz&#39;]) for c in craft])</span>
            <span class="c1">#Switched to one loop 2018/03/07</span>
            <span class="n">tvals</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#-np.array([np.mean(plsm[c+&#39;_offset&#39;].loc[i,&#39;offsets&#39;]).total_seconds() for c in craft])</span>
            <span class="n">xvals</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#np.array([np.mean(plsm[c].loc[i,&#39;GSEx&#39;]) for c in craft])</span>
            <span class="n">yvals</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#np.array([np.mean(plsm[c].loc[i,&#39;GSEy&#39;]) for c in craft])</span>
            <span class="n">zvals</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1">#np.array([np.mean(plsm[c].loc[i,&#39;GSEz&#39;]) for c in craft])</span>
         
            <span class="c1">#create master event dictionary for given event to store parameters</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="s1">&#39;event_</span><span class="si">{0:1d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
           
        
            <span class="c1">#loop over all craft and populate time and position arrays</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">craft</span><span class="p">:</span>
                <span class="c1">#append craft values onto time and position arrays</span>
                <span class="c1">#changed to min values 2018/03/12 J. Prchlik</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">itval</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">c</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">offsets</span>
                <span class="c1">#Fix THEMIS having out of range index</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">check</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">c</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">GSEx</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
                    <span class="n">it</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">c</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">GSEx</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">check</span><span class="p">]</span>
                    <span class="n">itval</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">c</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,:]</span><span class="o">.</span><span class="n">offsets</span>
                    
                <span class="c1">#Switch to first value to have a matched time if multiple values</span>
                <span class="c1">#map to the &quot;trainer&quot; space craft time 2018/11/19 J. Prchlik</span>
                <span class="c1">#Previously idd closest to 0</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itval</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">_libs</span><span class="o">.</span><span class="n">tslib</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">):</span>
                    <span class="n">off_cor</span> <span class="o">=</span> <span class="n">itval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                    <span class="n">tvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">itval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itval</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                    <span class="n">off_cor</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">itval</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                    <span class="n">tvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">itval</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
    
                <span class="c1">#Get closest index value location</span>
                <span class="c1">#Update with time offset implimented</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">GSEx</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">off_cor</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">),</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
                <span class="c1">#convert index location back to time index</span>
                <span class="n">it</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">GSEx</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
    
                <span class="c1">#Use offset pandas DF position 2018/04/25 J. Prchlik</span>
                <span class="n">xvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ii</span><span class="p">,:]</span><span class="o">.</span><span class="n">GSEx</span><span class="p">))</span>
                <span class="n">yvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ii</span><span class="p">,:]</span><span class="o">.</span><span class="n">GSEy</span><span class="p">))</span>
                <span class="n">zvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ii</span><span class="p">,:]</span><span class="o">.</span><span class="n">GSEz</span><span class="p">))</span>
        
            <span class="c1">#Covert arrays into numpy arrays and flip sign of offset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">cur</span><span class="p">][</span><span class="s1">&#39;tvals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tvals</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">cur</span><span class="p">][</span><span class="s1">&#39;xvals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xvals</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">cur</span><span class="p">][</span><span class="s1">&#39;yvals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">yvals</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">cur</span><span class="p">][</span><span class="s1">&#39;zvals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zvals</span><span class="p">)</span> 
            <span class="c1">#Print position values and time values</span>
        
            <span class="c1">#get the velocity components with respect to the shock front at wind</span>
            <span class="c1">#i_val = wind_v.index.get_loc(i,method=&#39;nearest&#39;)</span>
            <span class="c1">#vx = wind_v.iloc[i_val].Vx</span>
            <span class="c1">#vy = wind_v.iloc[i_val].Vy</span>
            <span class="c1">#vz = wind_v.iloc[i_val].Vz</span>
            <span class="c1">#use positions and vectors to get a solution for plane velocity</span>
            <span class="n">pm</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span><span class="n">xvals</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="n">xvals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">yvals</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="n">yvals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">zvals</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="n">zvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span> <span class="c1">#coordinate of craft 1 in top row</span>
            <span class="n">tm</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">tvals</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span><span class="o">.</span><span class="n">T</span> <span class="c1"># 1x3 matrix of time (wind-spacecraft)</span>
            <span class="n">vna</span><span class="p">,</span><span class="n">vn</span><span class="p">,</span><span class="n">vm</span> <span class="o">=</span> <span class="n">solve_plane</span><span class="p">(</span><span class="n">pm</span><span class="p">,</span><span class="n">tm</span><span class="p">)</span>
            <span class="c1">#vna = np.linalg.solve(pm,tm) #solve for the velocity vectors normal</span>
            <span class="c1">#vn  = vna/np.linalg.norm(vna)</span>
            <span class="c1">#vm  = 1./np.linalg.norm(vna) #get velocity magnitude</span>


            <span class="c1">#Check that angle is less than 70 deg. from -X GSE following Weimer et al (2003)</span>
            <span class="c1">#2018/11/20 J. Prchlik</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vn</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">]))))</span>

            <span class="c1">#replace vn,vm with the previous value if theta is greater than 70 degree</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">theta</span> <span class="o">&gt;</span> <span class="n">cut_deg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_velo&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)):</span>
                <span class="n">vm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_velo&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">vn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_nvec&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="c1">#Skip the prediction if there are no good previous values</span>
            <span class="k">elif</span> <span class="p">((</span><span class="n">theta</span> <span class="o">&gt;</span> <span class="n">cut_deg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_velo&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)):</span>
                <span class="k">continue</span>
            
            
            <span class="c1">#store vx,vy,vz values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">cur</span><span class="p">][</span><span class="s1">&#39;vx&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">cur</span><span class="p">][</span><span class="s1">&#39;vy&#39;</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">cur</span><span class="p">][</span><span class="s1">&#39;vz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vm</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">vn</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="c1">#store normal vector 2018/04/24 J. prchlik</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">cur</span><span class="p">][</span><span class="s1">&#39;vn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vn</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">cur</span><span class="p">][</span><span class="s1">&#39;vm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vm</span>
        
            <span class="c1">#get the 4 point location of the front when at wind</span>
            <span class="c1">#p_x(t0)1 = p_x(t1)-V_x*dt where dt = t1-t0  </span>
            <span class="c1">#solving exactly</span>
            <span class="c1">#use the velocity matrix solution to get the solution for the plane analytically</span>
            <span class="c1">#2018/03/15 J. Prchlik</span>
            <span class="c1">#px = -vx*tvals+xvals</span>
            <span class="c1">#py = -vy*tvals+yvals</span>
            <span class="c1">#pz = -vz*tvals+zvals</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">cur</span><span class="p">][</span><span class="s1">&#39;wind_px&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">xvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">cur</span><span class="p">][</span><span class="s1">&#39;wind_py&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">yvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">cur</span><span class="p">][</span><span class="s1">&#39;wind_pz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
            <span class="c1">#Wind position to determine starting point  2018/05/24 J. Prchlik</span>
            <span class="n">px</span> <span class="o">=</span> <span class="n">xvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">py</span> <span class="o">=</span> <span class="n">yvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pz</span> <span class="o">=</span> <span class="n">zvals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
            <span class="k">for</span> <span class="n">esp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">earth_craft</span><span class="p">:</span>
                <span class="c1">################################################################</span>
                <span class="c1">#Get THEMIS B location and compare arrival times</span>
                <span class="c1">################################################################</span>
                <span class="c1">#</span>
                <span class="c1">#</span>
                <span class="c1">#Get closest index value location</span>
                <span class="c1">#Fix THEMIS having out of range index</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">itval</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">offsets</span>
                    <span class="c1">#Get time of observation in THEMIS B</span>
                    <span class="n">itind</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span>
                    <span class="n">it</span> <span class="o">=</span> <span class="n">i</span>
                <span class="c1">#Fix THEMIS having out of range index</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">check</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">GSEx</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
                    <span class="n">it</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">GSEx</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">check</span><span class="p">]</span>
                    <span class="n">itval</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,:]</span><span class="o">.</span><span class="n">offsets</span>
                    <span class="c1">#Get time of observation in THEMIS B</span>
                    <span class="n">itind</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span>
    
                <span class="c1">#Get first match if DTW produces more than one</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itind</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span> <span class="n">itind</span> <span class="o">=</span> <span class="n">itind</span><span class="o">.</span><span class="n">dropna</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itval</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">_libs</span><span class="o">.</span><span class="n">tslib</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">):</span>
                    <span class="n">atval</span> <span class="o">=</span> <span class="n">itval</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">itval</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
                    <span class="n">atval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">itval</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="c1">#,key=abs).total_seconds()</span>
    
                <span class="c1">#Store THEMIS position</span>
                <span class="n">axval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;GSEx&#39;</span><span class="p">])</span>
                <span class="n">ayval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">])</span>
                <span class="n">azval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">])</span>
    
                <span class="c1">################################################################</span>
                <span class="c1">################################################################</span>
    
                <span class="c1">#parameters to add</span>
                <span class="c1">#Switched to dictionary 2018/04/24 J. Prchlik</span>
                <span class="c1">#add_lis = [vx,vy,vz,tvals,vm,vn,px,py,pz]</span>
                <span class="c1">#big_lis.append(add_lis)</span>
                <span class="c1">#Wind Themis B distance difference from plane at wind</span>
                <span class="n">themis_d</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">vn</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span><span class="n">axval</span><span class="p">,</span><span class="n">ayval</span><span class="p">,</span><span class="n">azval</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span><span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">,</span><span class="n">pz</span><span class="p">]))</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
                <span class="n">themis_dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">themis_d</span><span class="p">)</span><span class="o">/</span><span class="n">vm</span>
                <span class="n">themis_pr</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">themis_dt</span><span class="p">,</span><span class="n">unit</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
    
                <span class="c1">#Try to print prediction, but if it fails just move on 2018/05/17 J. Prchlik</span>
                <span class="k">try</span><span class="p">:</span>
                   <span class="c1"># print(&#39;Arrival Time {0:%Y/%m/%d %H:%M:%S} at Wind&#39;.format(i))</span>
                   <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;Arrival Time {0:%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S} at Wind&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                   <span class="n">test</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Predicted Arrival Time at </span><span class="si">{2}</span><span class="s1"> {0:%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S}, Distance = </span><span class="si">{1:4.1f}</span><span class="s1">km&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">themis_pr</span><span class="p">,</span><span class="n">themis_d</span><span class="p">,</span><span class="n">esp</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
                   <span class="n">test</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Actual Arrival Time at </span><span class="si">{2}</span><span class="s1"> {0:%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S}, Offset (Pred.-Act.) = </span><span class="si">{1:4.2f}</span><span class="s1">s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">itind</span><span class="p">,</span><span class="n">themis_dt</span><span class="o">-</span><span class="n">atval</span><span class="p">,</span><span class="n">esp</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>
                
    
                <span class="c1">#Use wind parameters to predict shock location 2018/04/25 J. Prchlik</span>
                <span class="n">th_yval</span> <span class="o">=</span> <span class="n">t_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">.</span><span class="n">SPEED</span>
                <span class="n">th_xval</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">themis_pr</span><span class="p">)</span>
                <span class="n">rl_xval</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">itind</span><span class="p">)</span>
                    
                <span class="c1">#plot parameters from wind prediction 2018/05/17 J. Prchlik</span>
                <span class="n">ax_th</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">th_xval</span><span class="p">,</span><span class="n">th_yval</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    
                <span class="c1">#Store the prediction in array for plotting and comparing to omni</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th_xval</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_plsm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">th_yval</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_velo&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vm</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_nvec&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vn</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_dist&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">themis_d</span><span class="p">)</span>
    
    
    
                <span class="c1">#change to line at wind 2018/05/17</span>
                <span class="c1">#Add predicted THEMIS plot</span>
                <span class="c1">#Remove 2018/07/26 J. Prchlik</span>
                <span class="c1">#ax_th.annotate(&#39;Event {0:1d} at {1}&#39;.format(j+1,esp.upper()),xy=(th_xval,th_yval),xytext=(th_xval,th_yval+50.),</span>
                <span class="c1">#          arrowprops=dict(facecolor=&#39;purple&#39;,shrink=0.005))</span>
                <span class="c1">###Add Actual to THEMIS plot 2018/05/03 J. Prchlik</span>
                <span class="c1">##ax_th.annotate(&#39;Event {0:1d} at {1}&#39;.format(j+1,esp.upper()),xy=(rl_xval,th_yval),xytext=(rl_xval,th_yval-50.),</span>
                <span class="c1">##          arrowprops=dict(facecolor=&#39;red&#39;,shrink=0.005))</span>
                <span class="c1">#store speed and time values</span>
                <span class="n">event_plot</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">th_xval</span><span class="p">,</span><span class="n">th_yval</span><span class="p">])</span>
                <span class="n">event_plot</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">rl_xval</span><span class="p">,</span><span class="n">th_yval</span><span class="p">])</span>
    
            <span class="c1">#put values in new dataframe</span>
            <span class="c1">#for l in range(len(col_add)):</span>
            <span class="c1">#    frm_vs.loc[i,col_add[l]] = add_lis[l] </span>
        
        <span class="c1">#turn big lis into numpy array</span>
        <span class="c1">#I don&#39;t need to do this 2018/03/15 J. Prchlik</span>
        <span class="c1">#big_lis = np.array(big_lis)</span>
        
        
        <span class="n">fig</span><span class="o">.</span><span class="n">autofmt_xdate</span><span class="p">()</span>
                        
        <span class="c1">#Puff up y-limit 2018/05/03 J. Prchlik</span>
        <span class="n">ylims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">())</span>
        <span class="c1">#if ylim min less than 0 set to 250</span>
        <span class="k">if</span> <span class="n">ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">250.</span> 
    
        <span class="n">yrang</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+.</span><span class="mi">1</span><span class="o">*</span><span class="n">yrang</span><span class="p">])</span>
        <span class="c1">#Save time warping plot</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;../plots/bou_{0:%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S}.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start_t</span><span class="p">)),</span><span class="n">bbox_pad</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        
        <span class="c1">#set up date and time ranges 2018/05/03 J. Prchlik</span>
        <span class="n">event_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">event_plot</span><span class="p">)</span>
        <span class="n">min_val</span> <span class="o">=</span> <span class="n">event_plot</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">max_val</span> <span class="o">=</span> <span class="n">event_plot</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">rng_val</span> <span class="o">=</span> <span class="n">max_val</span><span class="o">-</span><span class="n">min_val</span>
    
       
        <span class="c1">#save resulting THEMIS plot 2018/04/25 J. Prchlik</span>
        <span class="n">xlims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ax_th</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">())</span>
        <span class="n">ax_th</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+.</span><span class="mi">1</span><span class="o">*</span><span class="n">yrang</span><span class="p">])</span>
    
        <span class="c1">#include earth pad offset in time range 2018/05/04 J. Prchlik </span>
        <span class="n">xlims</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_earth</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span>
    
        <span class="c1">#Add 10% padding around plot time window for events</span>
        <span class="c1">#increase time range if needed</span>
        <span class="n">test_xmin</span> <span class="o">=</span> <span class="n">min_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-.</span><span class="mi">1</span><span class="o">*</span><span class="n">rng_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">test_xmax</span> <span class="o">=</span> <span class="n">max_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+.</span><span class="mi">1</span><span class="o">*</span><span class="n">rng_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">test_xmin</span> <span class="o">&lt;</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">xlims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_xmin</span>
        <span class="k">if</span> <span class="n">test_xmax</span> <span class="o">&gt;</span> <span class="n">xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">xlims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_xmax</span>
    
    
        <span class="c1">#use pretty axis and save</span>
        <span class="n">ax_th</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlims</span><span class="p">)</span>
        <span class="n">ax_th</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fig_th</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;../plots/themis_pred_{0:%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S}.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">start_t</span><span class="p">)),</span><span class="n">bbox_pad</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        
        
        
    
    
        <span class="c1">#Do not run animation sequence if asked to stop and return with just parameters</span>
        <span class="c1">#Returns vx,vy,vz,tvals,Vmag,Vnoraml,X,Y,Z</span>
        <span class="c1">#Switched to self.event_dict dictionary 2018/04/24 J. Prchlik</span>
        <span class="k">if</span> <span class="n">justparm</span><span class="p">:</span> <span class="k">return</span> </div>

<div class="viewcode-block" id="dtw_plane.dtw_multi_parm"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.dtw_plane.dtw_multi_parm">[docs]</a>    <span class="k">def</span> <span class="nf">dtw_multi_parm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">twind</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds planar solution to 4 L1 spacecraft</span>
<span class="sd">     </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd"> </span>
<span class="sd">        self: Class</span>
<span class="sd">        twind: datetime object</span>
<span class="sd">             The rough time of discontinuity in the Trainer Spacecraft, which is used to time weight the fit</span>

<span class="sd"> </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">tslearn</span> <span class="k">import</span> <span class="n">metrics</span>
        <span class="kn">from</span> <span class="nn">tslearn.preprocessing</span> <span class="k">import</span> <span class="n">TimeSeriesScalerMinMax</span><span class="p">,</span><span class="n">TimeSeriesScalerMeanVariance</span>


        <span class="c1">#Creating modular solution for DTW 2018/03/21 J. Prchlik</span>
        <span class="c1">##set the Start and end time</span>
        <span class="c1">#start_t = &quot;2016/12/21 07:00:00&quot;</span>
        <span class="c1">#end_t = &quot;2016/12/21 13:00:00&quot;</span>
        <span class="c1">#center = True</span>
        <span class="c1">#reset variables to local variables</span>
        <span class="n">Re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Re</span> <span class="c1"># Earth radius</span>
        <span class="n">start_t</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> 
        <span class="n">end_t</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_t</span>   
        <span class="n">center</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span>  
        <span class="n">par</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span>     
        <span class="n">justparm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">justparm</span>
        <span class="n">marker</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marker</span>
        <span class="n">color</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span>
        
        <span class="c1">#set use to use all spacecraft</span>
        <span class="n">craft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">craft</span> <span class="c1">#[&#39;Wind&#39;,&#39;DSCOVR&#39;,&#39;ACE&#39;,&#39;SOHO&#39;]</span>
        <span class="n">col</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span>   <span class="c1">#[&#39;blue&#39;,&#39;black&#39;,&#39;red&#39;,&#39;teal&#39;]</span>
        <span class="n">mar</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mar</span>   <span class="c1">#[&#39;D&#39;,&#39;o&#39;,&#39;s&#39;,&#39;&lt;&#39;]</span>
        <span class="n">trainer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span>
        
        <span class="c1">#range to find the best maximum value</span>
        <span class="n">maxrang</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;3 minutes&#39;</span><span class="p">)</span>
        
        
        <span class="c1">#create new plasma dictory which is a subset of the entire file readin</span>
        <span class="n">plsm</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">craft</span><span class="p">:</span>
             <span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1">#[start_t:end_t] Cutting not required because already using a small sample 2018/05/03 J. Prchlik</span>
             <span class="c1">#remove duplicates</span>
             <span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">~</span><span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)]</span>

        <span class="c1">#get all values at full resolution for dynamic time warping</span>
        <span class="n">t_mat</span>  <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">trainer</span><span class="p">]</span> <span class="c1">#.loc[trainer_t-t_rgh_wid:trainer_t+t_rgh_wid]</span>
  
        <span class="c1">#add trainer matrix to self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_mat</span> <span class="o">=</span> <span class="n">t_mat</span>


        <span class="c1">#parameters to replace bad values</span>
        <span class="c1">#par = [&#39;SPEED&#39;,&#39;Np&#39;,&#39;Vth&#39;,&#39;Bx&#39;,&#39;By&#39;,&#39;Bz&#39;]</span>
        <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">,</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>
        <span class="c1">#par = [&#39;SPEED&#39;,&#39;Bt&#39;]</span>

        <span class="c1">#fill all Nans in data series with forward values first and then back fill the first times</span>
        <span class="c1">#ffil inf values</span>
        <span class="n">t_mat</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">t_mat</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#ffil bad values</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">par</span><span class="p">:</span>
            <span class="n">bad</span><span class="o">=</span><span class="p">((</span><span class="n">t_mat</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">80000.</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">80000.</span><span class="p">))</span>
            <span class="n">t_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bad</span><span class="p">,</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
        <span class="c1">#fill bad values first forward then backward for the starting time</span>
        <span class="n">t_mat</span> <span class="o">=</span> <span class="n">t_mat</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span>


        <span class="c1">#Find points with the largest speed differences in wind</span>
        <span class="n">top_vs</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">/</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span><span class="o">.</span><span class="n">nlargest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">)</span>
        
        <span class="c1">#sort by time for event number</span>
        <span class="n">top_vs</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="c1">#add to self</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_vs</span> <span class="o">=</span> <span class="n">top_vs</span>

        <span class="c1">#plot with the best timing solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">18</span><span class="p">))</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">fax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">fax</span>

       
        <span class="c1">#set range to include all top events (prevents window too large error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;30 minutes&#39;</span><span class="p">)</span>
        <span class="n">pad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">top_vs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="n">pad</span><span class="p">,</span><span class="n">top_vs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">+</span><span class="n">pad</span><span class="p">])</span>
        
        <span class="c1">#loop over all other craft</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">craft</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;###########################################&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">p_mat</span>  <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="c1">#.loc[i_min-t_rgh_wid:i_min+t_rgh_wid]</span>
        
            <span class="c1">#use speed for rough esimation if possible</span>
            <span class="c1">#if  ((k.lower() == &#39;soho&#39;) ): par = [&#39;SPEED&#39;,&#39;Np&#39;,&#39;Vth&#39;]</span>
            <span class="c1">#elif (((par is None) | (isinstance(par,float))) &amp; (k.lower() != &#39;soho&#39;)): par = [&#39;SPEED&#39;,&#39;Np&#39;,&#39;Vth&#39;,&#39;Bx&#39;,&#39;By&#39;,&#39;Bz&#39;,&#39;Bt&#39;] #Add Total magnetic field 2018/09/07 J. Prchlik</span>
            <span class="c1">#Try just speed and magnetic field 2108/09/07 J. Prchlik</span>
            <span class="k">if</span>  <span class="p">((</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;soho&#39;</span><span class="p">)</span> <span class="p">):</span> 
                <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(((</span><span class="n">par</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">par</span><span class="p">,</span><span class="nb">float</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;soho&#39;</span><span class="p">)):</span>
                <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">,</span><span class="s1">&#39;By&#39;</span><span class="p">,</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span> <span class="c1">#Add Total magnetic field 2018/09/07 J. Prchlik</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">par</span><span class="p">,</span><span class="nb">str</span><span class="p">):</span>
                <span class="n">par</span> <span class="o">=</span> <span class="p">[</span><span class="n">par</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                 <span class="n">par</span> <span class="o">=</span> <span class="n">par</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">par</span><span class="p">)</span>

            <span class="c1">#Get and record differences and add to x_vals</span>
            <span class="c1">#t_mat,x_vals = get_x_difference(t_mat,par)       </span>
            <span class="n">x_vals</span> <span class="o">=</span> <span class="n">par</span>

            <span class="c1">#set up variables for training set</span>
            <span class="n">X_train</span> <span class="o">=</span> <span class="n">t_mat</span><span class="p">[</span><span class="n">x_vals</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="c1">#Include a time normalization</span>
            <span class="n">normer_train</span> <span class="o">=</span> <span class="n">t_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

            <span class="n">min_train</span> <span class="o">=</span> <span class="n">normer_train</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="n">max_train</span> <span class="o">=</span> <span class="n">normer_train</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="c1">#create normalization values</span>
            <span class="n">normer_train</span> <span class="o">=</span> <span class="n">dtw_wei</span><span class="p">(</span><span class="n">normer_train</span><span class="p">,</span><span class="n">twind</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="mf">5.</span><span class="o">/</span><span class="p">((</span><span class="n">max_train</span><span class="o">-</span><span class="n">min_train</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>

            <span class="c1">#expand array so you can simply multiply</span>
            <span class="n">normer_train</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">normer_train</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="c1">#include a time normalization factor</span>
            <span class="c1">#X_train *= normer_train</span>

            <span class="c1">#time values trying to match</span>
            <span class="n">y_train</span> <span class="o">=</span> <span class="n">t_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        
            <span class="c1">#get the median slope and offset</span>
            <span class="c1">#J. Prchlik (2017/11/20)</span>
            <span class="c1">#Dont use interpolated time for solving dynamic time warp (J. Prchlik 2017/12/15)</span>
            <span class="c1">#only try SPEED corrections for SOHO observations</span>
            <span class="c1">#Only apply speed correction after 1 iteration (J. Prchlik 2017/12/18)</span>
   
            <span class="c1">#Switched to standardized variables 2018/07/31 J. Prchlik</span>
            <span class="c1">#Turned back on </span>
            <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;themis&#39;</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">())):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1">#create copy of p_mat</span>
                    <span class="n">c_mat</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="c1">#resample the matching (nontrained spacecraft to the trained spacecraft&#39;s timegrid to correct offset (2017/12/15 J. Prchlik)</span>
                    <span class="n">c_mat</span> <span class="o">=</span> <span class="n">c_mat</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
         
                    <span class="c1">#only comoare no NaN values</span>
                    <span class="n">good</span><span class="p">,</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(((</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">c_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">values</span><span class="p">))))</span>
         
                    <span class="c1">#if few points for comparison only used baseline offset</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">good</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mf">1E36</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">par</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SPEED&#39;</span><span class="p">)):</span>
                        <span class="n">med_m</span><span class="p">,</span><span class="n">med_i</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span>
                        <span class="n">off_speed</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                        <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">-</span><span class="n">off_speed</span>
                        <span class="k">if</span> <span class="n">med_m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">*</span><span class="n">med_m</span><span class="o">+</span><span class="n">med_i</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">off_speed</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                        <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">-</span><span class="n">off_speed</span>
                    <span class="c1">#only apply slope if greater than 0</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c1">#get median offset to apply to match spacecraft</span>
                    <span class="n">off_speed</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="o">-</span><span class="n">t_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">.</span><span class="n">nsmallest</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
                    <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">SPEED</span><span class="o">-</span><span class="n">off_speed</span>
         
         
            <span class="c1">#ffil inf values</span>
            <span class="n">p_mat</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">p_mat</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1">#ffil bad values</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">par</span><span class="p">:</span>
                <span class="n">bad</span><span class="o">=</span><span class="p">((</span><span class="n">p_mat</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">80000.</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">p_mat</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">80000.</span><span class="p">))</span>
                <span class="n">p_mat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">bad</span><span class="p">,</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="c1">#fill all Nans in data series with forward values first and then back fill the first times</span>
            <span class="n">p_mat</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">ffill</span><span class="p">()</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span>
            <span class="c1">#Get and record differences and add to x_vals</span>
            <span class="c1">#p_mat,x_vals = get_x_difference(p_mat,par)</span>
            <span class="n">x_vals</span> <span class="o">=</span> <span class="n">par</span>



            <span class="c1">#set up variables for test set</span>
            <span class="n">X_tests</span> <span class="o">=</span> <span class="n">p_mat</span><span class="p">[</span><span class="n">x_vals</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

            <span class="c1">#Include a time normalization</span>
            <span class="n">normer_tests</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>


            <span class="c1">#create normalization values</span>
            <span class="n">normer_tests</span> <span class="o">=</span> <span class="n">dtw_wei</span><span class="p">(</span><span class="n">normer_tests</span><span class="p">,</span><span class="n">twind</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="mf">5.</span><span class="o">/</span><span class="p">((</span><span class="n">max_train</span><span class="o">-</span><span class="n">min_train</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
            <span class="n">normer_tests</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">normer_tests</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">X_tests</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

            <span class="c1">#include a time normalization factor</span>
            <span class="c1">#X_tests *= normer_tests</span>

            <span class="n">y_tests</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
         

            <span class="c1">#Scale the parameter to have a mean of 0 and a varience of 1</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">TimeSeriesScalerMeanVariance</span><span class="p">(</span><span class="n">mu</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">std</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
            <span class="c1">#scaler = TimeSeriesScalerMinMax(min=0., max=1.)  # Rescale time series</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">X_train</span><span class="p">[:,</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[:,</span><span class="n">kk</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">X_tests</span><span class="p">[:,</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_tests</span><span class="p">[:,</span><span class="n">kk</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>



            <span class="c1">#get dynamic time warping value   </span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARPING TIME&#39;</span><span class="p">)</span>
            <span class="c1">#get multi-parameter dtw solution</span>
            <span class="c1">#path, sim = metrics.dtw_path(X_train, X_tests)</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">sim</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">dtw_path</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_tests</span><span class="p">,</span><span class="n">global_constraint</span><span class="o">=</span><span class="s1">&#39;sakoe_chiba&#39;</span><span class="p">,</span><span class="n">sakoe_chiba_radius</span><span class="o">=</span><span class="mi">1550</span><span class="p">)</span>
            <span class="c1">#convert path into a numpy array</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">path</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;STOP WARPING TIME&#39;</span><span class="p">)</span>
        
            <span class="c1">#get full offsets for dynamic time warping</span>
            <span class="n">off_sol</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">],:]</span><span class="o">.</span><span class="n">index</span> <span class="o">-</span> <span class="n">t_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;REINDEXED&#39;</span><span class="p">)</span>
        
            <span class="c1">#get a region around one of the best fit times</span>
            <span class="n">b_mat</span> <span class="o">=</span> <span class="n">p_mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
            <span class="c1">#update the time index of the match array for comparision with training spacecraft (i=training spacecraft time)</span>
            <span class="n">b_mat</span> <span class="o">=</span> <span class="n">b_mat</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">b_mat</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">path</span><span class="p">[</span><span class="mi">1</span><span class="p">],:]</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="c1">#.interpolate(&#39;time&#39;)</span>
            <span class="n">b_mat</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">b_mat</span><span class="o">.</span><span class="n">index</span><span class="o">-</span><span class="n">off_sol</span>
            <span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;offsets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">off_sol</span>
        
            <span class="c1">#Add offset data frame to plasma diction</span>
            <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_mat</span>
            <span class="c1">#plot plasma parameters</span>
            <span class="c1">#fax[0,0].scatter(b_mat[b_mat[&#39;Np&#39;   ] &gt; -9990.0].index,b_mat[b_mat[&#39;Np&#39;   ] &gt; -9990.0].Np   ,marker=marker[k],color=color[k],label=k.upper())         </span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Np</span>   <span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
                <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Np</span>   <span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Vth</span>  <span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
                <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Vth</span>  <span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        
            <span class="c1">#plot mag. parameters</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;soho&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bx</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bx</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">By</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">By</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bz</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">b_mat</span><span class="p">[</span><span class="n">b_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bz</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;###########################################&#39;</span><span class="p">)</span>
        
        
        <span class="c1">#set 0 offsets for training spacecraft</span>
        <span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;offsets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> 
        <span class="n">plsm</span><span class="p">[</span><span class="n">trainer</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">t_mat</span>
        
        
        <span class="c1">#plot plasma parameters for Wind</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Np</span>   <span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">trainer</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Np&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Np</span>   <span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Vth</span>  <span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">trainer</span><span class="p">)</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Vth&#39;</span>  <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Vth</span>  <span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">])</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;SPEED&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        
        <span class="c1">#plot mag. parameters</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bx</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">])</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bx&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bx</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">By</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">])</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;By&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">By</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bz</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">])</span>
            <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span>   <span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">t_mat</span><span class="p">[</span><span class="n">t_mat</span><span class="p">[</span><span class="s1">&#39;Bz&#39;</span><span class="p">]</span>    <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">]</span><span class="o">.</span><span class="n">Bz</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">trainer</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        
        <span class="n">fancy_plot</span><span class="p">(</span><span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fancy_plot</span><span class="p">(</span><span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fancy_plot</span><span class="p">(</span><span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">fancy_plot</span><span class="p">(</span><span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">fancy_plot</span><span class="p">(</span><span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">fancy_plot</span><span class="p">(</span><span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1">#i = pd.to_datetime(&quot;2016/12/21 08:43:12&quot;) </span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">start_t</span><span class="p">,</span><span class="n">end_t</span><span class="p">])</span>
        
        <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Np [cm$^{-3}$]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Th. Speed [km/s]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Flow Speed [km/s]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [UTC]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        
        <span class="n">fax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Bx [nT]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;By [nT]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Bz [nT]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [UTC]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        
        <span class="n">fax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="mf">100.</span><span class="p">])</span>
        
        
        <span class="c1">#turn into data frame </span>
        <span class="n">frm_vs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">top_vs</span><span class="p">)</span>
        <span class="c1">#add columns</span>
        <span class="n">col_add</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="s1">&#39;Y&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">,</span><span class="s1">&#39;Vx&#39;</span><span class="p">,</span><span class="s1">&#39;Vy&#39;</span><span class="p">,</span><span class="s1">&#39;Vz&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">col_add</span><span class="p">:</span> <span class="n">frm_vs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">9999.9</span>



        <span class="c1">#Updated self plasma dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span> <span class="o">=</span> <span class="n">plsm</span></div></div>

<span class="c1">#plot distribution of time offsets as a function of time in wind of SOHO, ACE, DSCVOR</span>
<div class="viewcode-block" id="plot_time_dis"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.plot_time_dis">[docs]</a><span class="k">def</span> <span class="nf">plot_time_dis</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="c1">#get DTW offset keys from plasma dictionary</span>
    <span class="n">off_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;offset&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_offset&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
                <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">earth_craft</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_offset&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="p">))]</span>

    <span class="c1">#time range</span>
    <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="n">off_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-9</span>
    <span class="c1">#Set up bins for Heat map</span>
    <span class="n">resx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">6e1</span><span class="p">)</span> <span class="c1">#1 minutes</span>
    <span class="n">resy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e1</span><span class="p">)</span> <span class="c1">#10 seconds</span>
    <span class="n">xbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">resx</span><span class="p">)</span>
    <span class="n">ybins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="mf">3.6e3</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="mf">3.6e3</span><span class="p">),</span><span class="n">resy</span><span class="p">)</span><span class="c1">#1 hour around time offset</span>

    <span class="c1">#set up color map</span>
    <span class="n">ccmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">viridis</span><span class="o">.</span><span class="n">reversed</span><span class="p">()</span>
    <span class="n">ccmap</span><span class="o">.</span><span class="n">set_under</span><span class="p">(</span><span class="s1">&#39;1.00&#39;</span><span class="p">)</span>
    <span class="c1">#create a figure with as many columns as off_keys </span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">fax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">off_keys</span><span class="p">),</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">off_keys</span><span class="p">),</span><span class="mi">6</span><span class="p">),</span><span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fax</span> <span class="o">=</span> <span class="n">fax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>


    <span class="c1">#pandas start and end times as datetime objects</span>
    <span class="n">pd_s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_t</span><span class="p">)</span>
    <span class="n">pd_e</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_t</span><span class="p">)</span>
    <span class="n">pd_p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;30m&#39;</span><span class="p">)</span>
    <span class="c1">#get middle point of DTW range</span>
    <span class="n">pd_m</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd_e</span><span class="o">-</span><span class="n">pd_s</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span><span class="o">+</span><span class="n">pd_s</span>


    <span class="c1">#loop over all keys</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">off_keys</span><span class="p">):</span>

        <span class="c1">#convert from ns to s</span>
        <span class="n">xvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd_m</span><span class="o">-</span><span class="n">pd_p</span><span class="p">:</span><span class="n">pd_m</span><span class="o">+</span><span class="n">pd_p</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-9</span>
        <span class="n">yvals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd_m</span><span class="o">-</span><span class="n">pd_p</span><span class="p">:</span><span class="n">pd_m</span><span class="o">+</span><span class="n">pd_p</span><span class="p">][</span><span class="s1">&#39;offsets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-9</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">yvals</span><span class="p">),</span><span class="n">i</span><span class="p">)</span>

        <span class="c1">#create two D histogram</span>
        <span class="n">H</span><span class="p">,</span><span class="n">xedges</span><span class="p">,</span><span class="n">yedges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span><span class="n">yvals</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="p">(</span><span class="n">xbins</span><span class="p">,</span><span class="n">ybins</span><span class="p">))</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">T</span> <span class="c1">#transpose for plotting</span>

        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xedges</span><span class="p">,</span> <span class="n">yedges</span><span class="p">)</span>
        <span class="n">plotc</span> <span class="o">=</span> <span class="n">fax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">ccmap</span><span class="p">,</span><span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_offset&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
        <span class="n">fax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [UTC]&#39;</span><span class="p">)</span>
        <span class="n">fax</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Offset from Wind [s]&#39;</span><span class="p">)</span>
        <span class="n">fancy_plot</span><span class="p">(</span><span class="n">fax</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>


    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;../plots/two_d_his.png&#39;</span><span class="p">,</span><span class="n">bbox_pad</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
<span class="c1">#    fig.savefig(&#39;../plots/two_d_his.eps&#39;,bbox_pad=.1,bbox_inches=&#39;tight&#39;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div>

<span class="c1">#get difference in parameter values for DTW</span>
<div class="viewcode-block" id="get_x_difference"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.get_x_difference">[docs]</a><span class="k">def</span> <span class="nf">get_x_difference</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">diff_v</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    df: pandas data frame of solar wind observations</span>
<span class="sd">    diff_v: list of parameters to compute the difference for</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#Get difference values and stor</span>
    <span class="n">new</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;diff_&#39;</span><span class="o">+</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">diff_v</span><span class="p">]</span>
    <span class="n">df</span><span class="p">[</span><span class="n">new</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">diff_v</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">bfill</span><span class="p">()</span>
    <span class="n">diff_v</span> <span class="o">=</span> <span class="n">diff_v</span><span class="o">+</span><span class="n">new</span>

    <span class="k">return</span> <span class="n">df</span><span class="p">,</span><span class="n">diff_v</span></div>

<span class="c1">#create an equation to wieght the observation of the form y = b*(x-a)^2+c</span>
<div class="viewcode-block" id="dtw_wei"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.dtw_wei">[docs]</a><span class="k">def</span> <span class="nf">dtw_wei</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">t0</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    x: a time range in nanoseconds</span>
<span class="sd">    t0: the central time point in nanoseconds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">t0</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">c</span></div>

<div class="viewcode-block" id="plot_dtw_example"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.plot_dtw_example">[docs]</a><span class="k">def</span> <span class="nf">plot_dtw_example</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">c_time</span><span class="p">,</span><span class="n">compare</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DSCOVR&#39;</span><span class="p">],</span><span class="n">pad</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="s1">&#39;30m&#39;</span><span class="p">),</span><span class="n">parm</span><span class="o">=</span><span class="s1">&#39;Bz&#39;</span><span class="p">,</span><span class="n">subsamp</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span><span class="n">leg_loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A function to create an example of how DTW works</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    self: class</span>
<span class="sd">        The class object created in the code after running .init_read() and .dtw() </span>
<span class="sd">    c_time: pd.datetime object</span>
<span class="sd">        The central panda datetime object to plot around</span>
<span class="sd">    compare: list, optional</span>
<span class="sd">        List of two space craft to use to compare DTW solution (Default = [&#39;DSCOVR&#39;])</span>
<span class="sd">    pd: pd.timedelta object, optional</span>
<span class="sd">        Time around c_time to plot (Defatult = 30 minutes, pd.to_timedelta(&#39;30m&#39;))</span>
<span class="sd">    parm: str, optional</span>
<span class="sd">        Parameter to plot on the y-axis (Default = &#39;Bz&#39;)</span>
<span class="sd">    subsamp: int, optional</span>
<span class="sd">        Subsampling parameter, so that plot does not show the full range of values (Default = 10).</span>
<span class="sd">    offset: float, optional</span>
<span class="sd">        Value to offset the unwarped time value solution (Default = 10.)</span>
<span class="sd">    leg_loc: string or int</span>
<span class="sd">        Location of the matplotlib legend (Default = &#39;lower right&#39;).</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#Create figure</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
 
    <span class="c1">#The reference or &quot;trainer&quot; space craft</span>
    <span class="n">traft</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="p">]</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">compare</span><span class="p">:</span>
        <span class="c1">#What the spacecraft observed</span>
        <span class="n">craft</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="c1">#Offsets applied to the spacecraft observations</span>
        <span class="n">oraft</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span>

 


        <span class="c1">#good parameters</span>
        <span class="n">good_parm</span> <span class="o">=</span> <span class="p">((</span><span class="n">oraft</span><span class="p">[</span><span class="n">parm</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9990.0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">traft</span><span class="p">[</span><span class="n">parm</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">9999.0</span><span class="p">))</span>

        <span class="c1">#plot nicely</span>
        <span class="c1">#ax.scatter(craft[craft[&#39;SPEED&#39;] &gt; -9990.0].index,craft[craft[&#39;SPEED&#39;] &gt; -9990.0].SPEED,color=self.color[i],marker=self.marker[i])</span>

        <span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">craft</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">oraft</span><span class="o">.</span><span class="n">match_ind</span><span class="p">[</span><span class="n">good_parm</span><span class="p">],:]</span><span class="o">.</span><span class="n">index</span>   <span class="p">,</span><span class="n">traft</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">oraft</span><span class="o">.</span><span class="n">train_ind</span><span class="p">[</span><span class="n">good_parm</span><span class="p">],:]</span><span class="o">.</span><span class="n">index</span><span class="p">])[:,::</span><span class="n">subsamp</span><span class="p">]</span>
        <span class="n">yvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">craft</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">oraft</span><span class="o">.</span><span class="n">match_ind</span><span class="p">[</span><span class="n">good_parm</span><span class="p">],:][</span><span class="n">parm</span><span class="p">]</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span><span class="n">traft</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">oraft</span><span class="o">.</span><span class="n">train_ind</span><span class="p">[</span><span class="n">good_parm</span><span class="p">],:][</span><span class="n">parm</span><span class="p">]])[:,::</span><span class="n">subsamp</span><span class="p">]</span>


        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">yvals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>

        <span class="c1">#only get keep finite values</span>
        <span class="c1">#good = np.isfinite(yvals)</span>
        <span class="c1">#allgood = ((good[0]) &amp; (good[1]))</span>
        <span class="c1">#xvals=xvals[allgood]</span>
        <span class="c1">#yvals=yvals[allgood]</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span><span class="n">yvals</span><span class="p">,</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=.</span><span class="mi">11</span><span class="p">)</span>


   

    <span class="c1">#plot the trainer space craft (i.e. the spacecraft which we are referencing for the DTW</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">yvals</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">trainer</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">c_time</span><span class="o">-</span><span class="n">pad</span><span class="p">,</span><span class="n">c_time</span><span class="o">+</span><span class="n">pad</span><span class="p">])</span>

    <span class="c1">#rotate  x axis tick labels</span>
    <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
        <span class="n">tick</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">leg_loc</span><span class="p">,</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time [UTC]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">parm</span><span class="o">+</span><span class="s1">&#39; [nT]&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;{0:%Y/%m/</span><span class="si">%d</span><span class="s1">}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_time</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

    <span class="c1"># format the ticks</span>
    <span class="n">mins</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">MinuteLocator</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  <span class="c1">#every x minutes </span>
    <span class="n">minsFmt</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s1">&#39;%H:%M&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">mins</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">minsFmt</span><span class="p">)</span>

    <span class="n">fancy_plot_small</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;../plots/example_dtw_{0:%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S}.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_time</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()),</span><span class="n">bbox_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;../plots/example_dtw_{0:%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S}.eps&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c_time</span><span class="o">.</span><span class="n">to_pydatetime</span><span class="p">()),</span><span class="n">bbox_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>


<span class="c1">#add small tick marks to plots</span>
<div class="viewcode-block" id="fancy_plot_small"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.fancy_plot_small">[docs]</a><span class="k">def</span> <span class="nf">fancy_plot_small</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
    <span class="c1">#Turn minor ticks on</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;both&#39;</span><span class="p">)</span>
    <span class="c1">#set the width of the ticks</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#set the length of the major ticks</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="c1">#set length of the minor ticks</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span><span class="n">length</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="omni_plot"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.omni_plot">[docs]</a><span class="k">def</span> <span class="nf">omni_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">hours</span><span class="o">=</span><span class="n">mdates</span><span class="o">.</span><span class="n">HourLocator</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function to plot 4-spacecraft plane solution at L1 compared to omni prediciton. This function</span>
<span class="sd">    was used to make the plots for AGU Fall 2018.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -------------</span>
<span class="sd">    self: Class</span>
<span class="sd">        A dtw_plane class instance after the pred_earth function is already ran. </span>
<span class="sd">    hours: matplotlib.dates.HourLocator object, optional</span>
<span class="sd">        The frequency which to label the time axis in the plots (Default =  mdates.HourLocator(), which is every hour).</span>
<span class="sd">    Returns</span>
<span class="sd">    ------------</span>
<span class="sd">    None</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="k">import</span> <span class="n">MaxNLocator</span>

    <span class="c1">#Create omni figure</span>
    <span class="n">fig_omni</span><span class="p">,</span> <span class="n">ax_omni</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">dpi</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>

    <span class="c1">#local plsm variable to skip self</span>
    <span class="n">plsm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span>

    <span class="c1">#Read and store omni observations</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_t</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_earth</span>
    <span class="n">end</span>   <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">end_t</span><span class="p">)</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_earth</span>
    <span class="n">omni</span> <span class="o">=</span> <span class="n">lcf</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">,</span><span class="n">scrf</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;omni&#39;</span><span class="p">],</span><span class="n">pls</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">mag</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">orb</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">omni</span> <span class="o">=</span> <span class="n">omni</span><span class="p">[</span><span class="s1">&#39;omni&#39;</span><span class="p">][</span><span class="s1">&#39;pls&#39;</span><span class="p">]</span>
    <span class="n">omni</span><span class="p">[</span><span class="s1">&#39;time_dt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">omni</span><span class="o">.</span><span class="n">Time</span><span class="p">)</span>
    <span class="n">omni</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">omni</span><span class="o">.</span><span class="n">time_dt</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="s1">&#39;omni&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">omni</span>

    <span class="c1">#plot omni parameters</span>
    <span class="c1">#slicer = ((omni.SPEED &lt; 10000.) &amp; (omni.time_dt &gt; start) &amp; (omni.time_dt &lt; end))</span>
    <span class="n">slicer</span> <span class="o">=</span> <span class="p">((</span><span class="n">omni</span><span class="o">.</span><span class="n">SPEED</span> <span class="o">&lt;</span> <span class="mf">10000.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">omni</span><span class="o">.</span><span class="n">time_dt</span> <span class="o">&gt;</span> <span class="n">start</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">omni</span><span class="o">.</span><span class="n">time_dt</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">))</span>
    <span class="n">ax_omni</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">omni</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">slicer</span><span class="p">,:]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">omni</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">slicer</span><span class="p">,:]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;OMNI&#39;</span><span class="p">)</span>

    <span class="c1">#loop over all earth space craft to plot</span>
    <span class="k">for</span> <span class="n">esp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">earth_craft</span><span class="p">:</span>
        <span class="c1">#Plot predictions at themis</span>
        <span class="n">pre_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_time&#39;</span><span class="p">])</span>
        <span class="n">pre_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_time&#39;</span><span class="p">])</span>
        <span class="n">pre_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_plsm&#39;</span><span class="p">])</span>
        <span class="n">pre_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_velo&#39;</span><span class="p">])</span>
        <span class="n">pre_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_nvec&#39;</span><span class="p">])</span>
        <span class="n">pre_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_dist&#39;</span><span class="p">])</span>


        <span class="c1">#Average velocties</span>
        <span class="n">smt_v</span> <span class="o">=</span> <span class="n">movingaverage</span> <span class="p">(</span><span class="n">pre_v</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="c1">#difference between smooth ando measured</span>
        <span class="n">err_v</span> <span class="o">=</span> <span class="p">(</span><span class="n">smt_v</span><span class="o">-</span><span class="n">pre_v</span><span class="p">)</span><span class="o">/</span><span class="n">smt_v</span>

      
<span class="c1">#        min_v, max_v = np.nanpercentile(pre_v,(65,98))</span>
        <span class="c1">#remove nans and bad velocities and distances (2018/08/01)</span>
        <span class="c1">#good, = np.where((np.isfinite(pre_x)) &amp; (np.isfinite(pre_y)) &amp; (pre_v &lt; 2.E4)  &amp; (pre_d &lt; 3.E9 ) &amp; (pre_v &gt; 220.) &amp; (pre_d &gt; 1.E5))#)))</span>
        <span class="c1">#1.5E6 is the approximate distance to L1 only use attack angles near radially propogating</span>
        <span class="c1">#good, = np.where((np.isfinite(pre_x)) &amp; (np.isfinite(pre_y)) &amp; (np.abs(pre_d-1.5E6)/1.5e6 &lt; 0.65) &amp; (pre_v &gt; min_v) &amp; (pre_v &lt; max_v))#)))</span>
        <span class="c1">#good = ((np.isfinite(pre_x)) &amp; (np.isfinite(pre_y)) &amp; (np.abs(pre_d-1.5E6)/1.5e6 &lt; 1.50) &amp; (pre_v &gt; min_v) &amp; (pre_v &lt; max_v))#)))</span>


        <span class="c1">#No longer needed after making cut on normal vector</span>
        <span class="c1">####good = ((np.isfinite(pre_x)) &amp; (np.isfinite(pre_y)) )#&amp; (np.abs(pre_d-1.5E6)/1.5e6 &lt; 1.50) &amp; (abs(err_v) &lt; 0.05))#(pre_v &gt; min_v) &amp; (pre_v &lt; max_v))#)))</span>
        <span class="c1">#range of velocities to consider 2018/09/07 J. Prchlik</span>
        <span class="c1">###min_v, max_v = np.nanpercentile(pre_v[good],(2,98))</span>
        <span class="c1">###min_v, max_v = np.nanpercentile(pre_d[good],(10,100))#-1.5e6</span>
        <span class="c1">###</span>
        <span class="c1">###if min_v &lt; 0.:</span>
        <span class="c1">###    min_v = 0.</span>
        <span class="c1">###print(min_v,max_v,pre_d[good].max())</span>

        <span class="c1">####iterate on what is a good velocity 2018/11/16 J. Prchlik </span>
        <span class="c1">####good = ((np.isfinite(pre_x)) &amp; (np.isfinite(pre_y)) &amp; (np.abs(pre_d-1.5E6)/1.5e6 &gt; 0.50))# &amp; (abs(err_v) &lt; 0.05) &amp; (pre_v &gt; min_v) &amp; (pre_v &lt; max_v))#)))</span>
        <span class="n">good</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">pre_x</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">pre_y</span><span class="p">)))</span><span class="c1"># &amp; (pre_d &gt; min_v) &amp; (pre_d &lt; max_v))# &amp; (abs(err_v) &lt; 0.05) &amp; (pre_v &gt; min_v) &amp; (pre_v &lt; max_v))#)))</span>

        <span class="n">pre_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pre_x</span><span class="p">)[</span><span class="n">good</span><span class="p">]</span>
        <span class="n">pre_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pre_y</span><span class="p">)[</span><span class="n">good</span><span class="p">]</span>
        <span class="c1">#replace bad values with nan</span>
        <span class="c1">#pre_x[good == False] = np.nan</span>
        <span class="c1">#pre_y[good == False] = np.nan</span>


        


        <span class="c1">#sort argument in time</span>
        <span class="c1">#remove out of order arrive fronts</span>
        <span class="n">srt_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pre_x</span><span class="p">)</span>
        <span class="c1">#srt_x, = np.where(np.diff(pre_x) &gt; 0.)</span>
        <span class="n">pre_x</span> <span class="o">=</span> <span class="n">pre_x</span><span class="p">[</span><span class="n">srt_x</span><span class="p">]</span>
        <span class="n">pre_y</span> <span class="o">=</span> <span class="n">pre_y</span><span class="p">[</span><span class="n">srt_x</span><span class="p">]</span>


        <span class="c1">#insert start and end times</span>
        <span class="c1">#x-values</span>
        <span class="n">pre_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pre_x</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">pre_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">pre_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pre_x</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
        <span class="n">pre_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pre_x</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">mdates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">end</span><span class="p">))</span>
        <span class="c1">#y-values</span>
        <span class="c1">#get value before first shock</span>
        <span class="c1">#init_idx = self.plsm[&#39;Wind&#39;].index.get_loc(self.top_vs.index[0])-1</span>
        <span class="n">init_val</span> <span class="o">=</span> <span class="n">pre_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#self.plsm[&#39;Wind&#39;].ffill().iloc[init_idx].SPEED</span>
        <span class="n">pre_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pre_y</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">init_val</span><span class="p">)</span>
        <span class="n">pre_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pre_y</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">init_val</span><span class="p">)</span>
        <span class="n">pre_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">pre_y</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">pre_y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>


        <span class="c1">#create box like plot</span>
        <span class="n">pre_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pre_x</span><span class="p">,</span><span class="n">pre_x</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">pre_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pre_y</span><span class="p">,</span><span class="n">pre_y</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1">#sort argument in time</span>
        <span class="c1">#remove out of order arrive fronts</span>
        <span class="n">srt_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">pre_x</span><span class="p">)</span>
        <span class="c1">#srt_x, = np.where(np.diff(pre_x) &gt; 0.)</span>
        <span class="n">pre_x</span> <span class="o">=</span> <span class="n">pre_x</span><span class="p">[</span><span class="n">srt_x</span><span class="p">]</span>
        <span class="n">pre_y</span> <span class="o">=</span> <span class="n">pre_y</span><span class="p">[</span><span class="n">srt_x</span><span class="p">]</span>



        <span class="c1">#No longer need with restriction in theta angle 2018/11/20 J. Prchlik</span>
        <span class="c1">######create pandas df and get rolling median value to plot</span>
        <span class="c1">#####window = &#39;90s&#39;</span>
        <span class="c1">#pre_df = pd.DataFrame(np.array([pre_x,pre_y]).T,columns=[&#39;time&#39;,&#39;SPEED&#39;])</span>
        <span class="c1">#pre_df.set_index(pd.to_datetime(pre_df.time),inplace=True)</span>
        <span class="c1">#resample at a 2minute cadence</span>
        <span class="c1">#pre_df = pre_df.drop_duplicates(&#39;time&#39;).reindex(plsm[esp].index.drop_duplicates(),method=&#39;nearest&#39;).interpolate(&#39;time&#39;)</span>
        <span class="c1">#pre_df.drop_duplicates(&#39;time&#39;,keep=&#39;first&#39;,inplace=True) </span>

        <span class="c1">######smooth array for prediction plotting</span>
        <span class="c1">#####pre_df[&#39;med_SPEED&#39;] = pre_df.SPEED.rolling(window,min_periods=0,closed=&#39;both&#39;).median()</span>
        <span class="c1">######pre_df[&#39;std_SPEED&#39;] = pre_df.SPEED.rolling(window,min_periods=0,closed=&#39;both&#39;).std()</span>
        <span class="c1">#####pre_df[&#39;std_SPEED&#39;] = (pre_df.SPEED-pre_df.med_SPEED).abs().rolling(window,min_periods=0,closed=&#39;both&#39;).median()</span>
        <span class="c1">#####pre_df[&#39;cnt_SPEED&#39;] = pre_df.SPEED.rolling(window,min_periods=0,closed=&#39;both&#39;).count()</span>

        <span class="c1">######get the core 1sigma uncert</span>
        <span class="c1">#####sig_min,sig_max = np.nanpercentile(pre_df.std_SPEED,[32,68])</span>

        <span class="c1">######replace values less than the min with the 1sigma value</span>
        <span class="c1">#####pre_df.loc[pre_df.std_SPEED &lt; sig_min,&#39;std_SPEED&#39;] = sig_min</span>
        <span class="c1">#####pre_df.loc[pre_df.std_SPEED &gt; sig_max,&#39;std_SPEED&#39;] = sig_max</span>


        <span class="c1">######compute # of sigma away from median</span>
        <span class="c1">#####pre_df[&#39;sig_SPEED&#39;] = np.abs(pre_df.SPEED-pre_df.med_SPEED)/(pre_df.std_SPEED)</span>

        <span class="c1">######replace bad SPEED values with last previous measurement</span>
        <span class="c1">#####repl_pred = pre_df.sig_SPEED &gt; 3.</span>
        <span class="c1">#####pre_df.loc[repl_pred,&#39;SPEED&#39;] = np.nan</span>
        <span class="c1">#####pre_df.ffill(inplace=True)</span>


        
        <span class="c1">#Add plot with just the THEMIS plasma data</span>
        <span class="n">slicer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="p">]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">)</span>
        <span class="n">ax_omni</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">slicer</span><span class="p">,:]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="n">pd</span><span class="o">.</span><span class="n">rolling_mean</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">slicer</span><span class="p">,:]</span><span class="o">.</span><span class="n">SPEED</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="n">center</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span><span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">color</span><span class="p">[</span><span class="n">esp</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">esp</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">),</span><span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1">#ax_omni.plot(pre_df.time,pre_df.med_SPEED,color=&#39;teal&#39;,linestyle=&#39;-.&#39;,label=&#39;Plane Pred.&#39;)</span>
        <span class="c1">#Plot plane prediction</span>
        <span class="n">ax_omni</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pre_x</span><span class="p">,</span><span class="n">pre_y</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Plane Pred.&#39;</span><span class="p">)</span>
        <span class="c1">#ax_omni.plot(pre_df.time,pre_df.SPEED,color=&#39;black&#39;,linestyle=&#39;-.&#39;,label=&#39;Plane Pred.&#39;,zorder=500)</span>


    <span class="c1">#ax_omni.locator_params(axis=&#39;x&#39;, nbins=4)</span>
    <span class="c1"># format the ticks</span>
    <span class="c1">#hours =   # every hour</span>
    <span class="n">hoursFmt</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s1">&#39;%H&#39;</span><span class="p">)</span>
    <span class="n">ax_omni</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">hours</span><span class="p">)</span>
    <span class="n">ax_omni</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">hoursFmt</span><span class="p">)</span>

    <span class="c1">#ax_omni.format_xdata = mdates.DateFormatter(&#39;%H:%M&#39;)</span>
    <span class="c1">#ax_omni.xaxis.set_major_locator(MaxNLocator(4))</span>
    <span class="n">ax_omni</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_t</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">ax_omni</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">,</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="c1">#set axis labels</span>
    <span class="n">ax_omni</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time [UTC]&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">ax_omni</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Flow Speed [km/s]&quot;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="c1">#Add limit to be only THEMIS region</span>
    <span class="n">ax_omni</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">((</span><span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">slicer</span><span class="p">,:]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">slicer</span><span class="p">,:]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
    <span class="n">fancy_plot_small</span><span class="p">(</span><span class="n">ax_omni</span><span class="p">)</span>
    <span class="c1">#rotate y,z y axis tick labels</span>
    <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">ax_omni</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
        <span class="n">tick</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="o">-</span><span class="mi">35</span><span class="p">)</span>
    

    <span class="n">fig_omni</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;../plots/omni_pred_{0:%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S}.png&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_t</span><span class="p">)),</span><span class="n">bbox_pad</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
    <span class="n">fig_omni</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;../plots/omni_pred_{0:%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S}.eps&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_t</span><span class="p">)),</span><span class="n">bbox_pad</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span></div>

    <span class="c1">#REMOVED TEST 2018/11/20 J. Prchlik</span>
    <span class="c1">#Also plot distances and vn values</span>
    <span class="c1">####fig_test,ax_test = plt.subplots(nrows=3,sharex=True)</span>

    <span class="c1">####ax_test[0].plot(pre_t,np.array(pre_d)*1.5e-6)</span>
    <span class="c1">####ax_test[1].plot(pre_t,np.array(pre_v))</span>
    <span class="c1">####ax_test[2].plot(pre_t,np.array(pre_n)[:,0])</span>

    <span class="c1">####ax_test[0].set_ylabel(&#39;Distance&#39;)</span>
    <span class="c1">####ax_test[1].set_ylabel(&#39;Velocity&#39;)</span>
    <span class="c1">####</span>
    <span class="c1">####ax_test[0].set_xlim(ax_omni.get_xlim())</span>

    <span class="c1">####for iax in ax_test.ravel():</span>
    <span class="c1">####    fancy_plot(iax)</span>


<div class="viewcode-block" id="delay_plot"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.delay_plot">[docs]</a><span class="k">def</span> <span class="nf">delay_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot the time delay between spacecraft as a function of time for the spacecraft used in the analysis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    self: dtw class instance</span>

<span class="sd">    &quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="movingaverage"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.movingaverage">[docs]</a><span class="k">def</span> <span class="nf">movingaverage</span> <span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate moving average</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    values: np.array</span>
<span class="sd">         Value to compute movie average over</span>
<span class="sd">    window: int</span>
<span class="sd">         Length of window to compute moving averages over</span>

<span class="sd">    Returns</span>
<span class="sd">    -----------</span>
<span class="sd">    sma: np.array</span>
<span class="sd">        Smoothed running average</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">window</span><span class="p">)</span><span class="o">/</span><span class="n">window</span>
    <span class="n">sma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span>
    <span class="c1">#extapolate to start to keep sma the same size as values</span>
    <span class="n">sma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">sma</span><span class="p">,</span><span class="mi">0</span><span class="p">,(</span><span class="n">window</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">[</span><span class="n">sma</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">sma</span></div>



        
        
<div class="viewcode-block" id="plane_animation"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.plane_animation">[docs]</a><span class="k">def</span> <span class="nf">plane_animation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">andir</span> <span class="o">=</span> <span class="s1">&#39;../plots/boutique_ana/&#39;</span><span class="p">):</span>
        
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates a series of plots that can be used for a movie showing successively propogation solar wind planes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -------------</span>
<span class="sd">    self: Class</span>
<span class="sd">        A dtw_plane class instance after the pred_earth function is already ran. </span>
<span class="sd">    andir: string, optional</span>
<span class="sd">        String value to plotting directory for the animation. Directory must already exist (Default = &#39;../plots/boutique_ana/&#39;).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#get animation function from matplotlib</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">animation</span>

    <span class="c1">#make sure andir ends with a &#39;/&#39;</span>
    <span class="k">if</span> <span class="n">andir</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
        <span class="n">andir</span> <span class="o">+=</span> <span class="s1">&#39;/&#39;</span>

    <span class="c1">#reset variables to local variables</span>
    <span class="n">Re</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Re</span> <span class="c1"># Earth radius in km</span>
    <span class="n">start_t</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_t</span> 
    <span class="n">end_t</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_t</span>   
    <span class="n">center</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span>  
    <span class="n">par</span>      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">par</span>     
    <span class="n">justparm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">justparm</span>
    <span class="n">marker</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">marker</span>
    <span class="n">color</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">color</span>
    <span class="n">plsm</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span>
    
    <span class="c1">#set use to use all spacecraft</span>
    <span class="n">craft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">craft</span> <span class="c1">#[&#39;Wind&#39;,&#39;DSCOVR&#39;,&#39;ACE&#39;,&#39;SOHO&#39;]</span>
    <span class="n">col</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">col</span>   <span class="c1">#[&#39;blue&#39;,&#39;black&#39;,&#39;red&#39;,&#39;teal&#39;]</span>
    <span class="n">mar</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mar</span>   <span class="c1">#[&#39;D&#39;,&#39;o&#39;,&#39;s&#39;,&#39;&lt;&#39;]</span>
    <span class="n">trainer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trainer</span>
    <span class="c1">#sim_date =  pd.date_range(start=start_t,end=end_t,freq=&#39;60S&#39;)</span>


    <span class="c1">#get data from THEMIS prediction</span>
    <span class="n">esp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">earth_craft</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#switched to Wind index for looping and creating figures 2018/03/15</span>
    <span class="n">sim_date</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="p">][</span><span class="n">start_t</span><span class="p">:</span><span class="n">end_t</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[::</span><span class="mi">100</span><span class="p">]</span>
    <span class="c1">#time &quot;event&quot; is observed at Wind</span>
    <span class="n">pre_t</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_time&#39;</span><span class="p">]),</span><span class="n">tz</span><span class="o">=</span><span class="kc">None</span><span class="p">)[::</span><span class="mi">100</span><span class="p">]</span>
    <span class="c1">#get a pandas formatted time</span>
    <span class="n">fmt_t</span> <span class="o">=</span>  <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">pre_t</span><span class="p">)</span>
    <span class="c1">#pre_t = np.array(self.event_dict[esp+&#39;_time&#39;])</span>
    <span class="c1">#The velocity of the propograting vector </span>
    <span class="n">pre_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_velo&#39;</span><span class="p">])[::</span><span class="mi">100</span><span class="p">]</span>
    <span class="c1">#The normal of the propogating vector</span>
    <span class="n">pre_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">esp</span><span class="o">+</span><span class="s1">&#39;_nvec&#39;</span><span class="p">])[::</span><span class="mi">100</span><span class="p">]</span>
    <span class="c1">#pre_d = np.array(self.event_dict[esp+&#39;_dist&#39;])</span>

    

    <span class="c1">#SWITCH to Just creation of mp4 using animate in matplotlib</span>
    <span class="c1">#Create figure showing space craft orientation</span>
    <span class="n">ofig</span><span class="p">,</span> <span class="n">oax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;height_ratios&#39;</span><span class="p">:[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;width_ratios&#39;</span><span class="p">:[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]},</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
    <span class="c1">#set orientation labels</span>
    <span class="n">oax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    
    <span class="c1">#Create axes inside [1,1] (bottom left) will be used for the vector normal</span>
    <span class="n">vec_ax_1</span> <span class="o">=</span> <span class="n">inset_axes</span><span class="p">(</span><span class="n">oax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;40%&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;40%&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">vec_ax_2</span> <span class="o">=</span> <span class="n">inset_axes</span><span class="p">(</span><span class="n">oax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;40%&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;40%&quot;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

 
    <span class="c1">#create a title object to pass to the animation function</span>
    <span class="n">title_time</span> <span class="o">=</span> <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;{0:%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sim_date</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="c1">#These labels are statics, so no need to create objects for them</span>
    <span class="c1">#oax[0,0].set_xlabel(&#39;X(GSE) [R$_\oplus$]&#39;,fontsize=20)</span>
    <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Z(GSE) [R$_\oplus$]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Y(GSE) [R$_\oplus$]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="c1">#oax[0,1].set_ylabel(&#39;Z(GSE) [R$_\oplus$]&#39;,fontsize=20)</span>
    <span class="n">oax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X(GSE) [R$_\oplus$]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">oax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y(GSE) [R$_\oplus$]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

    <span class="c1">#add fancy_plot to 2D plots</span>
    <span class="k">for</span> <span class="n">pax</span> <span class="ow">in</span> <span class="n">oax</span><span class="o">.</span><span class="n">ravel</span><span class="p">():</span>
        <span class="n">fancy_plot</span><span class="p">(</span><span class="n">pax</span><span class="p">)</span>



    <span class="c1">#set static limits from orbit maximum from SOHO file in Re</span>
    <span class="c1">#z limits</span>
    <span class="n">z_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mf">240.</span>
    <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">z_lim</span><span class="p">)</span>
    <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">z_lim</span><span class="p">)</span>
    <span class="c1">#xlimits</span>
    <span class="n">x_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">100.</span><span class="p">,</span><span class="mi">450</span><span class="p">])</span><span class="c1">#*300.0+200.</span>
    <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x_lim</span><span class="p">)</span>
    <span class="n">oax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">x_lim</span><span class="p">)</span>
    <span class="c1">#y limits</span>
    <span class="n">y_lim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="mf">120.0</span>
    <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">y_lim</span><span class="p">)</span>
    <span class="n">oax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">y_lim</span><span class="p">)</span>
    
    <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">,</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scatterpoints</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


    <span class="c1">#Add Earth&#39;s Bow Shock 2018/12/04 J. Prchlik</span>
    <span class="c1">#y^2+Axy+Bx^2+Cy+Dx+E=0</span>
    <span class="c1">#Assume y=z</span>
    <span class="c1">#Parameters are from Fairfield et  al. 1971 Table 2 X Rotation No 4</span>
    <span class="n">A</span> <span class="o">=</span>  <span class="mf">0.2164</span>
    <span class="n">B</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0986</span>
    <span class="n">C</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.26</span>
    <span class="n">D</span> <span class="o">=</span>  <span class="mf">44.916</span>
    <span class="n">E</span> <span class="o">=</span> <span class="o">-</span><span class="mf">623.77</span>

    <span class="c1">#Merdian 4 deg</span>
    <span class="c1">#More even so use this one 2018/12/05 J. Prchlik</span>
    <span class="n">A</span> <span class="o">=</span>  <span class="mf">0.0296</span>
    <span class="n">B</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.0381</span>
    <span class="n">C</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.280</span>
    <span class="n">D</span> <span class="o">=</span>  <span class="mf">45.664</span>
    <span class="n">E</span> <span class="o">=</span> <span class="o">-</span><span class="mf">652.10</span>


    <span class="c1">#Sample xvalue</span>
    <span class="n">y_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>


    <span class="c1">#Define simplifying constants</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">A</span><span class="o">*</span><span class="n">y_v</span><span class="o">+</span><span class="n">D</span>
    <span class="n">G</span> <span class="o">=</span> <span class="n">y_v</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">C</span><span class="o">*</span><span class="n">y_v</span><span class="o">+</span><span class="n">E</span>
    
    <span class="c1">#Get positive root of solution</span>
    <span class="n">x_v</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">F</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">F</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">G</span><span class="o">*</span><span class="n">B</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">B</span><span class="p">)</span>
    
    <span class="c1">#plot Bow shock</span>
    <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_v</span><span class="p">,</span><span class="n">y_v</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">oax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_v</span><span class="p">,</span><span class="n">y_v</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
  
    <span class="c1">#Now do it for y,z Bow shock is meaningless in this orientation (face on)</span>
    <span class="c1">#oax[0,1].plot(,,linewidth=2,color=&#39;black&#39;,label=None)</span>


    <span class="c1">#Set axis limits for vectors</span>
    <span class="n">vec_ax_1</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> 
    <span class="n">vec_ax_2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 
    <span class="n">vec_ax_1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">vec_ax_2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1">#Set axis limits for vectors</span>
    <span class="n">fancy_plot</span><span class="p">(</span><span class="n">vec_ax_1</span><span class="p">)</span>
    <span class="n">fancy_plot</span><span class="p">(</span><span class="n">vec_ax_2</span><span class="p">)</span>


    <span class="c1">#create labels</span>
    <span class="n">small_font</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">vec_ax_1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$n_\mathrm</span><span class="si">{X}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">small_font</span><span class="p">)</span>
    <span class="n">vec_ax_2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;($n_\mathrm</span><span class="si">{X}</span><span class="s1">^2$+$n_\mathrm</span><span class="si">{Y}</span><span class="s1">^2$)$^\frac</span><span class="si">{1}{2}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">small_font</span><span class="p">)</span>
    <span class="n">vec_ax_1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$n_\mathrm</span><span class="si">{Y}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">small_font</span><span class="p">)</span>
    <span class="n">vec_ax_2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$n_\mathrm</span><span class="si">{Z}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="n">small_font</span><span class="p">)</span>
    <span class="n">vec_ax_2</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>       
    
    <span class="c1">#rotate y,z y axis tick labels</span>
    <span class="k">for</span> <span class="n">tick</span> <span class="ow">in</span> <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_xticklabels</span><span class="p">():</span>
        <span class="n">tick</span><span class="o">.</span><span class="n">set_rotation</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span>

    <span class="c1">#set up vector plots</span>
    <span class="n">vec_xy</span> <span class="o">=</span> <span class="n">vec_ax_1</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">head_width</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">vec_rz</span> <span class="o">=</span> <span class="n">vec_ax_2</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">head_width</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1">#Dictionary for locations of the Spacecraft</span>
    <span class="n">loc_dic</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1">#get array of x,y,z spacecraft positions</span>
    <span class="c1">#spacraft positions</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">craft</span><span class="p">:</span>
        <span class="c1">#Get closest index value location</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">GSEx</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">sim_date</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
        <span class="c1">#convert index location back to time index</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">GSEx</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
    
        <span class="n">loc_dic</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_xz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;GSEx&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Re</span><span class="p">,</span><span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Re</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
        <span class="n">loc_dic</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_xy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;GSEx&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Re</span><span class="p">,</span><span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Re</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">loc_dic</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_yz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Re</span><span class="p">,</span><span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Re</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    
    <span class="c1">#dictionary for path objects created</span>
    <span class="n">patch_dic</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1">#Create function to initialize animation</span>
    <span class="k">def</span> <span class="nf">init_an</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes variables used in the animation of the solar wind.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#removed positions of the space craft</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">craft</span><span class="p">:</span>
            <span class="n">loc_dic</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_xz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">([[],[]])</span>
            <span class="n">loc_dic</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_xy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">([[],[]])</span>
            <span class="n">loc_dic</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_yz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">([[],[]])</span>

        <span class="c1">#remove vectors from plot</span>
        <span class="c1">#vec_xy.set_xy([[],[]],[[],[]])</span>
        <span class="c1">#vec_rz.set_xy([[],[]],[[],[]])</span>
        <span class="c1">#print(&#39;HERE&#39;)</span>
        <span class="n">title_time</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 


        <span class="k">return</span> <span class="n">vec_xy</span><span class="p">,</span><span class="n">vec_rz</span><span class="p">,</span><span class="n">title_time</span>

    <span class="c1">#Function to run the animation (basically just runs the loop)</span>
    <span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Animates the propogation of the solar wind using a simulated time l.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        l : pd.datetime index object</span>
<span class="sd">            A pandas datatime index corresponding to a specific time in the refernce spacecraft&#39;s</span>
<span class="sd">            (usually Wind) observations.</span>
<span class="sd">        </span>
<span class="sd">        Output</span>
<span class="sd">        ------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">sim_date</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="c1">#list of colors to use for the planes</span>
        <span class="n">cycol</span> <span class="o">=</span> <span class="n">cycle</span><span class="p">([</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span><span class="s1">&#39;green&#39;</span><span class="p">,</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="s1">&#39;cyan&#39;</span><span class="p">,</span><span class="s1">&#39;magenta&#39;</span><span class="p">,</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="s1">&#39;teal&#39;</span><span class="p">,</span><span class="s1">&#39;orange&#39;</span><span class="p">])</span>

        <span class="c1">#set title of plot</span>
        <span class="n">title_time</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;{0:%Y/%m/</span><span class="si">%d</span><span class="s1"> %H:%M:%S}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>


        <span class="c1">#get the wind plane values for given x, y, or z</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1e10</span><span class="p">,</span><span class="mf">1e10</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">windloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="c1">#+/- range for plane</span>
        <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.e10</span><span class="p">,</span><span class="mf">1.e10</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>

        <span class="c1">#remove all path objects created on the plot</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">patch_dic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1">#remove patch from plot</span>
            <span class="n">patch_dic</span><span class="p">[</span><span class="n">z</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
            <span class="c1">#remove patch from dictionary</span>
            <span class="n">patch_dic</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1">#Wind coordinates</span>
        <span class="n">px</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="s1">&#39;GSEx&#39;</span><span class="p">])</span>
        <span class="n">py</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">])</span>
        <span class="n">pz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="n">esp</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">])</span>

        <span class="c1">#Get time of l in local time then find difference between the</span>
        <span class="c1">#input time and the time the front is at Wind</span>
        <span class="c1">#The tz_localize is a hack because pandas inherents the local</span>
        <span class="c1">#time zone, which can give you incorrects results if not </span>
        <span class="c1">#accounted for 2019/01/09 J. Prchlik</span>
        <span class="n">fmt_l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="n">fmt_t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tz</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">fmt_t</span><span class="o">-</span><span class="n">fmt_l</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>

        <span class="c1">#Add radially propogating CME shock front    </span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pre_t</span><span class="p">):</span>
            <span class="c1">#color to use</span>
            <span class="n">cin</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">cycol</span><span class="p">)</span>

            <span class="c1">#get variable store in large array</span>
            <span class="n">vm</span> <span class="o">=</span> <span class="n">pre_v</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">vn</span> <span class="o">=</span> <span class="n">pre_n</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

            <span class="c1">#give temp variables to some parameters</span>
            <span class="n">vx</span><span class="p">,</span><span class="n">vy</span><span class="p">,</span><span class="n">vz</span> <span class="o">=</span> <span class="n">vn</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">vm</span><span class="p">)</span>

    
    
          
            <span class="c1">#theta normal angle</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">vn</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">vn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span><span class="o">*</span><span class="mf">180.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    
            <span class="c1">#leave loop if event is not within 2 hours (i.e., do not plot that event)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="mf">3600.</span><span class="p">:</span>
                <span class="k">continue</span>
    
    
            <span class="c1">#solve for the plane at time l</span>
            <span class="c1">#first get the points</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="n">vx</span><span class="p">],[</span><span class="n">vy</span><span class="p">],[</span><span class="n">vz</span><span class="p">]])</span><span class="o">*</span><span class="n">dt</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="n">px</span><span class="p">],[</span><span class="n">py</span><span class="p">],[</span><span class="n">pz</span><span class="p">]])</span>
    
            <span class="c1">#get the magentiude of the position</span>
            <span class="n">pm</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ps</span><span class="p">))</span>
            
    
            <span class="c1">#Switched to solve_coeff function 2018/04/24 J. Prchlik</span>
            <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span> <span class="o">=</span> <span class="n">solve_coeff</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span><span class="n">vn</span><span class="p">)</span>
    
            <span class="c1">#get the plane values for given x, y, or z</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1e10</span><span class="p">,</span><span class="mf">1e10</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">windloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    
            <span class="c1">#set off axis values to 0</span>
            <span class="n">zvalsx</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">counter</span><span class="o">-</span><span class="n">d</span><span class="p">)</span><span class="o">/</span><span class="n">c</span>
            <span class="n">zvalsy</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">b</span><span class="o">*</span><span class="n">counter</span><span class="o">-</span><span class="n">d</span><span class="p">)</span><span class="o">/</span><span class="n">c</span>
            <span class="n">yvalsx</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">counter</span><span class="o">-</span><span class="n">d</span><span class="p">)</span><span class="o">/</span><span class="n">b</span>
    
    
            <span class="c1">#get shock Np value (use bfill to get values from the next good Np value) </span>
            <span class="n">np_df</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">trainer</span><span class="o">+</span><span class="s1">&#39;_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">Np</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="n">np_vl</span> <span class="o">=</span> <span class="n">np_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;bfill&#39;</span><span class="p">)</span>
            <span class="n">np_op</span> <span class="o">=</span> <span class="n">np_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np_vl</span><span class="p">]</span>
            

            <span class="c1">#Use value limits from Weimer et al. (2002)</span>
            <span class="n">maxx</span> <span class="o">=</span>  <span class="mf">400.</span><span class="o">*</span><span class="n">Re</span>
            <span class="n">maxy</span> <span class="o">=</span>  <span class="mf">150.</span><span class="o">*</span><span class="n">Re</span>
            <span class="n">maxz</span> <span class="o">=</span>  <span class="mf">150.</span><span class="o">*</span><span class="n">Re</span>
            <span class="n">minx</span> <span class="o">=</span> <span class="o">-</span><span class="mf">50.</span><span class="o">*</span><span class="n">Re</span>
            <span class="n">miny</span> <span class="o">=</span> <span class="o">-</span><span class="mf">150.</span><span class="o">*</span><span class="n">Re</span>
            <span class="n">minz</span> <span class="o">=</span> <span class="o">-</span><span class="mf">150.</span><span class="o">*</span><span class="n">Re</span>
    
            <span class="c1">#make x and y grids</span>
            <span class="n">xg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">minx</span><span class="p">,</span><span class="n">maxx</span><span class="p">])</span>
            <span class="n">yg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">miny</span><span class="p">,</span><span class="n">maxy</span><span class="p">])</span>
            <span class="n">zg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">minz</span><span class="p">,</span><span class="n">maxz</span><span class="p">])</span>
    
            <span class="c1"># compute needed points for plane plotting</span>
            <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xg</span><span class="p">,</span> <span class="n">yg</span><span class="p">)</span>
            <span class="n">xt</span><span class="p">,</span> <span class="n">yt</span> <span class="o">=</span> <span class="n">xt</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">yt</span><span class="o">.</span><span class="n">T</span>
            <span class="c1">#simplify grid</span>
            <span class="n">xt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">minx</span><span class="p">,</span><span class="n">maxx</span><span class="p">,</span><span class="n">maxx</span><span class="p">,</span><span class="n">minx</span><span class="p">])</span>
            <span class="n">yt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">maxy</span><span class="p">,</span><span class="n">maxy</span><span class="p">,</span><span class="n">miny</span><span class="p">,</span><span class="n">miny</span><span class="p">])</span>
            <span class="c1">#switched to exact a,b,c from above 2018/03/15</span>
            <span class="n">zvalsx</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">xt</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">yt</span><span class="o">-</span><span class="n">d</span><span class="p">)</span><span class="o">/</span><span class="n">c</span>
            <span class="n">yvalsx</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">xt</span><span class="o">+</span><span class="n">c</span><span class="o">*</span><span class="n">yt</span><span class="o">-</span><span class="n">d</span><span class="p">)</span><span class="o">/</span><span class="n">b</span> <span class="c1">#works only because I set min(y), max(y) equal to min(z), max(z), respectively</span>
            <span class="n">zvalsy</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">xt</span><span class="o">+</span><span class="n">b</span><span class="o">*</span><span class="n">yt</span><span class="o">-</span><span class="n">d</span><span class="p">)</span><span class="o">/</span><span class="n">c</span>
    
            <span class="c1">#Itentifier for this plane</span>
            <span class="n">pi</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    
            <span class="c1">#create polygons</span>
            <span class="n">patch_dic</span><span class="p">[</span><span class="n">pi</span><span class="o">+</span><span class="s1">&#39;_xz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xt</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">/</span><span class="n">Re</span><span class="p">,</span><span class="n">zvalsx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">/</span><span class="n">Re</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">cin</span><span class="p">)</span>
            <span class="n">patch_dic</span><span class="p">[</span><span class="n">pi</span><span class="o">+</span><span class="s1">&#39;_xy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xt</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">/</span><span class="n">Re</span><span class="p">,</span><span class="n">yvalsx</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">/</span><span class="n">Re</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">cin</span><span class="p">)</span>
            <span class="n">patch_dic</span><span class="p">[</span><span class="n">pi</span><span class="o">+</span><span class="s1">&#39;_yz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">yt</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">/</span><span class="n">Re</span><span class="p">,</span><span class="n">zvalsy</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">/</span><span class="n">Re</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="n">cin</span><span class="p">)</span>

            <span class="c1">#Add normal vector</span>
            <span class="c1">#Plot normal vector with nearest arrive time at THEMIS</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">():</span>
                 <span class="c1">#Remove previous arrows Just a hack so animation actually works 2019/01/09 J. Prchlik</span>
                 <span class="n">vec_xy</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="c1">#remove()</span>
                 <span class="n">vec_rz</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span><span class="c1">#remove()</span>
                 <span class="c1">#vec_xy.set_xy(0,0,vn[0],vn[1])</span>
                 <span class="c1">#vec_rz.set_xy(0,0,np.sqrt(vn[0]**2+vn[1]**2),vn[2])</span>
                 <span class="n">patch_dic</span><span class="p">[</span><span class="n">pi</span><span class="o">+</span><span class="s1">&#39;a1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec_ax_1</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">vn</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vn</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">cin</span><span class="p">,</span><span class="n">head_width</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                 <span class="n">patch_dic</span><span class="p">[</span><span class="n">pi</span><span class="o">+</span><span class="s1">&#39;a2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec_ax_2</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">vn</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="n">vn</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="n">cin</span><span class="p">,</span><span class="n">head_width</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span><span class="n">width</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">length_includes_head</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                 <span class="c1">#Hack to make animation work. Without this line it fails</span>
                 <span class="c1">#vec_xy.set_color(cin)</span>
                 <span class="c1">#vec_rz.set_color(cin)</span>

            <span class="c1">#Add patchs corresponding to solar wind planes</span>
            <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch_dic</span><span class="p">[</span><span class="n">pi</span><span class="o">+</span><span class="s1">&#39;_xz&#39;</span><span class="p">])</span>
            <span class="n">oax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch_dic</span><span class="p">[</span><span class="n">pi</span><span class="o">+</span><span class="s1">&#39;_xy&#39;</span><span class="p">])</span>
            <span class="n">oax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">patch_dic</span><span class="p">[</span><span class="n">pi</span><span class="o">+</span><span class="s1">&#39;_yz&#39;</span><span class="p">])</span>

    
    
        <span class="c1">#get array of x,y,z spacecraft positions</span>
        <span class="c1">#spacraft positions</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">craft</span><span class="p">:</span>
            <span class="c1">#Get closest index value location</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">GSEx</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
            <span class="c1">#convert index location back to time index</span>
            <span class="n">it</span> <span class="o">=</span> <span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">GSEx</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
    
            <span class="c1">#Update the plotting location of the spacecraft</span>
            <span class="n">loc_dic</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_xy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">([</span><span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;GSEx&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Re</span><span class="p">,</span><span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Re</span><span class="p">])</span>
            <span class="n">loc_dic</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_xz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">([</span><span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;GSEx&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Re</span><span class="p">,</span><span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Re</span><span class="p">])</span>
            <span class="n">loc_dic</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_yz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_offsets</span><span class="p">([</span><span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Re</span><span class="p">,</span><span class="n">plsm</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">it</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">Re</span><span class="p">])</span>


        <span class="k">return</span> <span class="n">vec_xy</span><span class="p">,</span><span class="n">vec_rz</span>


    <span class="c1">#Set up animation</span>
    <span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">ofig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">init_func</span><span class="o">=</span><span class="n">init_an</span><span class="p">,</span>
                                   <span class="n">frames</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sim_date</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1">#Name of movie for the plane animation</span>
    <span class="n">movie_name</span> <span class="o">=</span> <span class="n">andir</span><span class="o">+</span><span class="s1">&#39;plane_ani_{0:%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S}.mp4&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_t</span><span class="p">))</span>
    
    <span class="c1">#save the output animation</span>
    <span class="n">anim</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">movie_name</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;-vcodec&#39;</span><span class="p">,</span> <span class="s1">&#39;libx264&#39;</span><span class="p">])</span></div>


    
    
<div class="viewcode-block" id="print_ave_offsets"><a class="viewcode-back" href="../source/code/model_time_range.html#model_time_range.print_ave_offsets">[docs]</a><span class="k">def</span> <span class="nf">print_ave_offsets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple function that prints the interesting times of prediction, the coordinates of the Earth Craft at that time,</span>
<span class="sd">    and the 5th and 95th percentile of time offsets for SOHO, DSCOVR, and ACE</span>

<span class="sd">    Parameters</span>
<span class="sd">    -------------</span>
<span class="sd">    self: Class</span>
<span class="sd">        A dtw_plane class instance after running iterate DTW. </span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="n">wind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="s1">&#39;Wind&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">dscvr</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="s1">&#39;DSCOVR_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">offsets</span><span class="p">,(</span><span class="mi">5</span><span class="p">,</span><span class="mi">95</span><span class="p">))</span><span class="o">*</span><span class="mf">1.e-9</span><span class="o">/</span><span class="mf">60.</span>
    <span class="n">ace</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="s1">&#39;ACE_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">offsets</span><span class="p">,(</span><span class="mi">5</span><span class="p">,</span><span class="mi">95</span><span class="p">))</span><span class="o">*</span><span class="mf">1.e-9</span>   <span class="o">/</span><span class="mf">60.</span>
    <span class="n">soho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="s1">&#39;SOHO_offset&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">offsets</span><span class="p">,(</span><span class="mi">5</span><span class="p">,</span><span class="mi">95</span><span class="p">))</span><span class="o">*</span><span class="mf">1.e-9</span>  <span class="o">/</span><span class="mf">60.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;####################################################&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DSCVOR-Wind (5%,95%) = </span><span class="si">{0:2.1f}</span><span class="s1">,</span><span class="si">{1:2.1f}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">dscvr</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ACE   -Wind (5%,95%) = </span><span class="si">{0:2.1f}</span><span class="s1">,</span><span class="si">{1:2.1f}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">ace</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SOHO  -Wind (5%,95%) = </span><span class="si">{0:2.1f}</span><span class="s1">,</span><span class="si">{1:2.1f}</span><span class="s1">m&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">soho</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;THEMIS Coordinates and Time&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">earth_craft</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plsm</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">earth_craft</span><span class="p">[</span><span class="mi">0</span><span class="p">]][[</span><span class="s1">&#39;GSEx&#39;</span><span class="p">,</span><span class="s1">&#39;GSEy&#39;</span><span class="p">,</span><span class="s1">&#39;GSEz&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Re</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;####################################################&#39;</span><span class="p">)</span></div>


</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Jakub Prchlik

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXXXX-1', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>